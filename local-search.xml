<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>è‹¥ä¾</title>
    <link href="/2024/11/23/%E8%8B%A5%E4%BE%9D/"/>
    <url>/2024/11/23/%E8%8B%A5%E4%BE%9D/</url>
    
    <content type="html"><![CDATA[<p>ç®¡ç†å‘˜ï¼šadminï¼Œadmin123<br>æ™®é€šç”¨æˆ·ï¼šryï¼Œadmin123</p><h1 id="Ruoyi-Vue"><a href="#Ruoyi-Vue" class="headerlink" title="Ruoyi-Vue"></a>Ruoyi-Vue</h1><h2 id="1-æƒé™ç®¡ç†"><a href="#1-æƒé™ç®¡ç†" class="headerlink" title="1 æƒé™ç®¡ç†"></a>1 æƒé™ç®¡ç†</h2><p>ruoyi çš„æƒé™ç®¡ç†æ˜¯ç”¨ @PreAuthorize æ¥å®ç°çš„ï¼Œå®ƒæ˜¯ SpringSecurity çš„ä¸€ä¸ªæ³¨è§£<br>è¿™ä¸ªæ³¨è§£ç”¨åœ¨æ–¹æ³•ä¸Šï¼Œå½“è¿™ä¸ªæ³¨è§£é‡Œçš„å€¼æ˜¯ true çš„æ—¶å€™ä»£è¡¨å¯ä»¥è®¿é—®<br>æ³¨è§£æ”¯æŒ EL è¡¨è¾¾å¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/monitor/server&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ServerController</span><br>&#123;<br>    <span class="hljs-meta">@PreAuthorize(&quot;@ss.hasPermi(&#x27;monitor:server:list&#x27;)&quot;)</span><br>    <span class="hljs-meta">@GetMapping()</span><br>    <span class="hljs-keyword">public</span> AjaxResult <span class="hljs-title function_">getInfo</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception<br>    &#123;<br>        <span class="hljs-type">Server</span> <span class="hljs-variable">server</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Server</span>();<br>        server.copyTo();<br>        <span class="hljs-keyword">return</span> AjaxResult.success(server);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­ï¼Œ@ss è¡¨ç¤ºä½œè€…è‡ªå®šä¹‰çš„ä¸€ä¸ª Service æ–¹æ³•ï¼Œå–äº†åˆ«å</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service(&quot;ss&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PermissionService</span><br>&#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * éªŒè¯ç”¨æˆ·æ˜¯å¦å…·å¤‡æŸæƒé™</span><br><span class="hljs-comment">     * </span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> permission æƒé™å­—ç¬¦ä¸²</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> ç”¨æˆ·æ˜¯å¦å…·å¤‡æŸæƒé™</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasPermi</span><span class="hljs-params">(String permission)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(permission))<br>        &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>        <span class="hljs-type">LoginUser</span> <span class="hljs-variable">loginUser</span> <span class="hljs-operator">=</span> SecurityUtils.getLoginUser();<br>        <span class="hljs-keyword">if</span> (StringUtils.isNull(loginUser) || CollectionUtils.isEmpty(loginUser.getPermissions()))<br>        &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>        PermissionContextHolder.setContext(permission);<br>        <span class="hljs-keyword">return</span> hasPermissions(loginUser.getPermissions(), permission);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­ <code>@PreAuthorize(&quot;@ss.hasPermi(&#39;monitor:server:list&#39;)&quot;)</code> è°ƒç”¨äº† PermissionService çš„ hasPermi æ–¹æ³•ï¼Œä¼ å…¥äº†ä¸€ä¸ªæƒé™åˆ—è¡¨</p><p>ruoyi çš„æƒé™ç®¡ç†æ˜¯åœ¨æ•°æ®è¡¨ sys_menu é‡Œçš„ï¼Œå…¶ä¸­æœ‰ä¸€åˆ— perms å®šä¹‰äº†å„ç§å„æ ·çš„æƒé™</p><p>ç„¶ååœ¨ä»£ç é‡Œæœ‰ä¸€ä¸ªç±» LoginUser é‡Œçš„ä¸€ä¸ªå±æ€§ <code>Set&lt;String&gt; permissions</code> å¯¹æƒé™åšäº†å°è£…ï¼Œåˆ¤æ–­ä¸€ä¸ªç”¨æˆ·æ˜¯å¦æœ‰ç›®æ ‡èµ„æºçš„æƒé™ï¼Œå°±çœ‹è¿™ä¸ª Set é›†åˆé‡Œæœ‰æ²¡æœ‰å¯¹åº”çš„æƒé™åˆ—è¡¨</p><p>ruoyi çš„ç”¨æˆ·å¯¹åº”çš„èœå•æƒé™æ˜¯åœ¨ï¼šç³»ç»Ÿç®¡ç† &#x2F; è§’è‰²ç®¡ç†é‡Œä¿®æ”¹çš„ï¼Œå¯¹åº”çš„è¡¨æ˜¯ sys_role_menu</p><h2 id="2-äº‹åŠ¡ç®¡ç†"><a href="#2-äº‹åŠ¡ç®¡ç†" class="headerlink" title="2 äº‹åŠ¡ç®¡ç†"></a>2 äº‹åŠ¡ç®¡ç†</h2><p>@Transactional æ³¨è§£åªèƒ½åº”ç”¨åˆ° public å¯è§åº¦çš„æ–¹æ³•ä¸Šï¼ˆå› ä¸º @Transactional åŸºäº AOP å®ç°çš„äº‹åŠ¡ç®¡ç†ï¼ŒAOP åªä¼šä»£ç† public çš„æ–¹æ³•ï¼‰</p><ol><li>æ£€æŸ¥æ€§å¼‚å¸¸ï¼Œäº‹åŠ¡ä¸ä¼šå›æ»šï¼›æ­£ç¡®åšæ³•æ˜¯ï¼Œåœ¨ @Transactional ä¸­åŠ å…¥ rollbackFor<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">insertUser</span><span class="hljs-params">(User user)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br><span class="hljs-comment">// æ–°å¢ç”¨æˆ·ä¿¡æ¯</span><br><span class="hljs-type">int</span> <span class="hljs-variable">rows</span> <span class="hljs-operator">=</span> userMapper.insertUser(user);<br><span class="hljs-comment">// æ–°å¢ç”¨æˆ·å²—ä½å…³è”</span><br>insertUserPost(user);<br><span class="hljs-comment">// æ–°å¢ç”¨æˆ·ä¸è§’è‰²ç®¡ç†</span><br>insertUserRole(user);<br><span class="hljs-comment">// æ¨¡æ‹ŸæŠ›å‡ºSQLExceptionå¼‚å¸¸</span><br><span class="hljs-type">boolean</span> <span class="hljs-variable">flag</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br><span class="hljs-keyword">if</span> (flag)&#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SQLException</span>(<span class="hljs-string">&quot;å‘ç”Ÿå¼‚å¸¸äº†..&quot;</span>);<br>&#125;<br><span class="hljs-keyword">return</span> rows;<br>&#125;<br></code></pre></td></tr></table></figure></li><li>try-catch è‡ªå·±æ‰‹åŠ¨æ•è·å¼‚å¸¸ï¼Œä¸ä¼šå›æ»šï¼›æ­£ç¡®åšæ³•æ˜¯åœ¨ä¸šåŠ¡å±‚ç»Ÿä¸€æŠ›å‡ºå¼‚å¸¸ï¼Œå…¨å±€å¼‚å¸¸å¤„ç†å™¨å¤„ç†</li></ol><h2 id="3-ç³»ç»Ÿæ—¥å¿—"><a href="#3-ç³»ç»Ÿæ—¥å¿—" class="headerlink" title="3 ç³»ç»Ÿæ—¥å¿—"></a>3 ç³»ç»Ÿæ—¥å¿—</h2><p>å®šä¹‰è‡ªå®šä¹‰æ³¨è§£ @Log æ·»åŠ åˆ°è¢«è®°å½•æ—¥å¿—çš„ Controller æ–¹æ³•ä¸Š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> Log&#123;<br>String <span class="hljs-title function_">title</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-string">&quot;&quot;</span>; <span class="hljs-comment">// æ¨¡å—</span><br><span class="hljs-comment">// åŠŸèƒ½</span><br>BusinessType <span class="hljs-title function_">businessType</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> BusinessType.OTHER;<br><span class="hljs-comment">// æ“ä½œäººç±»åˆ«</span><br>OperatorType <span class="hljs-title function_">operatorType</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> OperatorType.MANAGE;<br><span class="hljs-comment">// æ˜¯å¦ä¿å­˜è¯·æ±‚å‚æ•°</span><br><span class="hljs-type">boolean</span> <span class="hljs-title function_">isSaveRequestData</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-literal">true</span>;<br><span class="hljs-comment">// æ˜¯å¦ä¿å­˜å“åº”å‚æ•°</span><br><span class="hljs-type">boolean</span> <span class="hljs-title function_">isSaveResponseData</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-literal">true</span>;<br><span class="hljs-comment">// æ’é™¤æŒ‡å®šè¯·æ±‚å‚æ•°</span><br>String[] excludeParamNames() <span class="hljs-keyword">default</span> &#123;&#125;;<br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­ BusinessType å’Œ OperatorType æ˜¯æšä¸¾ç±»å‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">BusinessType</span>&#123;<br>OTHER, <span class="hljs-comment">// å…¶ä»–</span><br>INSERT, <span class="hljs-comment">// æ–°å¢</span><br>UPDATE, <span class="hljs-comment">// æ›´æ–°</span><br>DELETE, <span class="hljs-comment">// ä¿®æ”¹</span><br>...<br>&#125;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">OperatorType</span>&#123;<br>OTHER, <span class="hljs-comment">// å…¶ä»–</span><br>MANAGE, <span class="hljs-comment">// åå°ç”¨æˆ·</span><br>MOBILE <span class="hljs-comment">// æ‰‹æœºç«¯ç”¨æˆ·</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨æ–¹å¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@PreAuthorize(&quot;@ss.hasPermi(&#x27;system:dict:add&#x27;)&quot;)</span><br><span class="hljs-meta">@Log(title = &quot;å­—å…¸æ•°æ®&quot;, businessType = BusinessType.INSERT)</span><br><span class="hljs-meta">@PostMapping</span><br><span class="hljs-keyword">public</span> AjaxResult <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-meta">@Validated</span> <span class="hljs-meta">@RequestBody</span> SysDictData dict)</span><br>&#123;<br>dict.setCreateBy(getUsername());<br><span class="hljs-keyword">return</span> toAjax(dictDataService.insertDictData(dict));<br>&#125;<br></code></pre></td></tr></table></figure><p>å®šä¹‰ä¸€ä¸ªåˆ‡é¢ç±»ï¼Œå…¶ä¸­å‰ç½®è¯·æ±‚æŠŠå½“å‰æ—¶é—´å­˜å…¥åˆ° ThreadLocalä¸­ï¼Œä¸ºäº†è®¡ç®—æ“ä½œæ¶ˆè€—æ—¶é—´<br>å…¶ä¸­ä¸€ä¸ªå‚æ•°æ˜¯ <code>Log controllerLog</code>ï¼Œè¿™ä¸ªå‚æ•°ç›¸å½“äº Log æ³¨è§£çš„ä¸€ä¸ªå®ä¾‹ï¼Œæœ‰äº†è¿™ä¸ªå‚æ•°å°±å¯ä»¥ç”¨<code>@Before(value = &quot;@annotation(controllerLog)&quot;)</code> è¿™ç§æ–¹å¼è¡¨ç¤ºæ‰€æœ‰å¸¦ @Log æ³¨è§£çš„æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Before(value = &quot;@annotation(controllerLog)&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">boBefore</span><span class="hljs-params">(JoinPoint joinPoint, Log controllerLog)</span>&#123;<br>TIME_THREADLOCAL.set(System.currentTimeMillis());<br>&#125;<br></code></pre></td></tr></table></figure><p>@AfterReturning æ˜¯æ­£å¸¸æ‰§è¡Œå®Œè¿”å›çš„æƒ…å†µï¼Œå…¶ä¸­æ³¨è§£ä¸­çš„ returning è¡¨ç¤ºçš„æ˜¯ä»£ç†æ–¹æ³•çš„è¿”å›å€¼ï¼Œå†™åˆ°äº†å‚æ•°ä¸­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@AfterReturning(pointcut = &quot;@annotation(controllerLog)&quot;, returning = &quot;jsonResult&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doAfterReturning</span><span class="hljs-params">(JoinPoint joinPoint, Log controllerLog, Object jsonResult)</span>&#123;<br>handleLog(joinPoint, controllerLog, <span class="hljs-literal">null</span>, jsonResult);<br>&#125;<br></code></pre></td></tr></table></figure><p>æ‹¦æˆªå¼‚å¸¸æ“ä½œï¼Œthrowing è¡¨ç¤ºæŠ›å‡ºçš„å¼‚å¸¸</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@AfterThrowing(value = &quot;@annotation(controllerLog)&quot;, throwing = &quot;e&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doAfterThrowing</span><span class="hljs-params">(JoinPoint joinPoint, Log controllerLog, Exception e)</span>&#123;<br>handleLog(joinPoint, controllerLog, e, <span class="hljs-literal">null</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="4-æ•°æ®æ ¡éªŒ"><a href="#4-æ•°æ®æ ¡éªŒ" class="headerlink" title="4 æ•°æ®æ ¡éªŒ"></a>4 æ•°æ®æ ¡éªŒ</h2><p>ç”¨@Validated æ³¨è§£å¯ä»¥å¸®å¿™æ ¡éªŒå‰ç«¯ä¼ è¿‡æ¥çš„æ•°æ®ï¼Œå¼•å…¥ä»¥ä¸‹çš„åŒ…</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-validation<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>@NotNullä¸èƒ½ä¸ºnull<br>@NotBlankä¸èƒ½ä¸ºç©ºï¼Œå¸¸ç”¨äºæ£€æŸ¥ç©ºå­—ç¬¦ä¸²<br>@NotEmptyä¸èƒ½ä¸ºç©ºï¼Œå¤šç”¨äºæ£€æµ‹listæ˜¯å¦sizeæ˜¯0<br>@Maxè¯¥å­—æ®µçš„å€¼åªèƒ½å°äºæˆ–ç­‰äºè¯¥å€¼<br>@Minè¯¥å­—æ®µçš„å€¼åªèƒ½å¤§äºæˆ–ç­‰äºè¯¥å€¼<br>@Pastæ£€æŸ¥è¯¥å­—æ®µçš„æ—¥æœŸæ˜¯åœ¨è¿‡å»<br>@Futureæ£€æŸ¥è¯¥å­—æ®µçš„æ—¥æœŸæ˜¯å¦æ˜¯å±äºå°†æ¥çš„æ—¥æœŸ<br>@Emailæ£€æŸ¥æ˜¯å¦æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„emailåœ°å€<br>ä½¿ç”¨æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@PostMapping(&quot;/test&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">test</span><span class="hljs-params">(<span class="hljs-meta">@Validated</span> <span class="hljs-meta">@RequestBody</span> UserDto userDto)</span>&#123;<br>...<br>&#125;<br><span class="hljs-comment">// åœ¨ UserDto çš„ get æ–¹æ³•ä¸Šæˆ–è€…å­—æ®µä¸Šå¯ä»¥å£°æ˜è§„åˆ™</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserDto</span> &#123;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-meta">@NotNull(message = &quot;ç”¨æˆ·å¯†ç ä¸èƒ½ä¸ºç©º&quot;)</span><br>    <span class="hljs-keyword">private</span> String password;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿˜å¯ä»¥è‡ªå®šä¹‰æ³¨è§£æ ¡éªŒå™¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * è‡ªå®šä¹‰xssæ ¡éªŒæ³¨è§£</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> ruoyi</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-meta">@Target(value = &#123; ElementType.METHOD, ElementType.FIELD, ElementType.CONSTRUCTOR, ElementType.PARAMETER &#125;)</span><br><span class="hljs-meta">@Constraint(validatedBy = &#123; XssValidator.class &#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> Xss<br>&#123;<br>    String <span class="hljs-title function_">message</span><span class="hljs-params">()</span><br><br>    <span class="hljs-keyword">default</span> <span class="hljs-string">&quot;ä¸å…è®¸ä»»ä½•è„šæœ¬è¿è¡Œ&quot;</span>;<br><br>    Class&lt;?&gt;[] groups() <span class="hljs-keyword">default</span> &#123;&#125;;<br><br>    Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Payload</span>&gt;[] payload() <span class="hljs-keyword">default</span> &#123;&#125;;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * è‡ªå®šä¹‰xssæ ¡éªŒæ³¨è§£å®ç°</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> ruoyi</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">XssValidator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ConstraintValidator</span>&lt;Xss, String&gt;<br>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">HTML_PATTERN</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&lt;(\\S*?)[^&gt;]*&gt;.*?|&lt;.*? /&gt;&quot;</span>;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isValid</span><span class="hljs-params">(String value, ConstraintValidatorContext constraintValidatorContext)</span><br>    &#123;<br>        <span class="hljs-keyword">return</span> !containsHtml(value);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">containsHtml</span><span class="hljs-params">(String value)</span><br>    &#123;<br>        <span class="hljs-type">Pattern</span> <span class="hljs-variable">pattern</span> <span class="hljs-operator">=</span> Pattern.compile(HTML_PATTERN);<br>        <span class="hljs-type">Matcher</span> <span class="hljs-variable">matcher</span> <span class="hljs-operator">=</span> pattern.matcher(value);<br>        <span class="hljs-keyword">return</span> matcher.matches();<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨è‡ªå®šä¹‰æ³¨è§£</span><br><span class="hljs-meta">@Xss(message = &quot;ç™»å½•è´¦å·ä¸èƒ½åŒ…å«è„šæœ¬å­—ç¬¦&quot;)</span><br><span class="hljs-meta">@NotBlank(message = &quot;ç™»å½•è´¦å·ä¸èƒ½ä¸ºç©º&quot;)</span><br><span class="hljs-meta">@Size(min = 0, max = 30, message = &quot;ç™»å½•è´¦å·é•¿åº¦ä¸èƒ½è¶…è¿‡30ä¸ªå­—ç¬¦&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">getLoginName</span><span class="hljs-params">()</span><br>&#123;<br><span class="hljs-keyword">return</span> loginName;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="5-æ•°æ®æƒé™"><a href="#5-æ•°æ®æƒé™" class="headerlink" title="5 æ•°æ®æƒé™"></a>5 æ•°æ®æƒé™</h2><p>ç”¨æˆ·åªèƒ½çœ‹åˆ°è‡ªå·±éƒ¨é—¨çš„æ•°æ®ï¼Œè¿™ç§æƒ…å†µä¸€èˆ¬è¢«ç§°ä¸ºæ•°æ®æƒé™<br>åœ¨  SysRole ç±»ä¸­ï¼Œæœ‰ä¸€ä¸ªå­—æ®µï¼ŒdataScope è¡¨ç¤ºæ•°æ®èŒƒå›´</p><ol><li>æ‰€æœ‰æ•°æ®æƒé™</li><li>è‡ªå®šä¹‰æ•°æ®æƒé™</li><li>æœ¬éƒ¨é—¨æ•°æ®æƒé™</li><li>æœ¬éƒ¨é—¨åŠä»¥ä¸‹æ•°æ®æƒé™</li><li>ä»…æœ¬äººæ•°æ®æƒé™<br>æ ¸å¿ƒæ˜¯åˆ©ç”¨è‡ªå®šä¹‰æ³¨è§£ï¼Œ@DataScope å’Œ å¤„ç† AOP çš„ç±» DataScopeAspect æ¥å®ç°<br>@DataScope æ³¨è§£é‡Œå®šä¹‰äº†ä¸‰ä¸ªå±æ€§<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Target(ElementType.METHOD)</span><br><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-meta">@Documented</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> DataScope<br>&#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * éƒ¨é—¨è¡¨çš„åˆ«å</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">deptAlias</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-string">&quot;&quot;</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * ç”¨æˆ·è¡¨çš„åˆ«å</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">userAlias</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-string">&quot;&quot;</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * æƒé™å­—ç¬¦ï¼ˆç”¨äºå¤šä¸ªè§’è‰²åŒ¹é…ç¬¦åˆè¦æ±‚çš„æƒé™ï¼‰é»˜è®¤æ ¹æ®æƒé™æ³¨è§£<span class="hljs-doctag">@ss</span>è·å–ï¼Œå¤šä¸ªæƒé™ç”¨é€—å·åˆ†éš”å¼€æ¥</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">permission</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-string">&quot;&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>å…¶ä¸­åœ¨ DataScopeAspect ç±»ä¸­å¯ä»¥æ”¶åˆ°è¿™ä¸‰ä¸ªå±æ€§<br>è¿™ä¸ªæ³¨è§£ä¸€èˆ¬æ”¾åœ¨ Service å±‚çš„æ–¹æ³•ä¸Šï¼Œä¼ è¿›æ¥çš„ä¸€èˆ¬æ˜¯ pojo å¯¹è±¡<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-meta">@DataScope(deptAlias = &quot;d&quot;)</span><br><span class="hljs-keyword">public</span> List&lt;SysDept&gt; <span class="hljs-title function_">selectDeptList</span><span class="hljs-params">(SysDept dept)</span>&#123;<br>    <span class="hljs-keyword">return</span> deptMapper.selectDeptList(dept);<br>&#125;<br></code></pre></td></tr></table></figure>ä¼ è¿›æ¥çš„ pojo å¯¹è±¡ï¼Œæ¯”å¦‚ SysDept é›†æˆäº† BaseEntityï¼ŒBaseEntity ä¸­æœ‰ä¸€ä¸ªå±æ€§ <code>Map&lt;String, Object&gt; params;</code><br>åœ¨ AOP çš„è¿‡ç¨‹ä¸­ï¼Œä¼šå–å‡ºæ¥è¿™ä¸ªå­—æ®µï¼Œæ ¹æ®ä¸åŒè§’è‰²çš„æƒé™ï¼Œå¾€é‡Œé¢åŠ¨æ€æ·»åŠ ä¸€äº› SQL è¯­å¥<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (StringUtils.isNotBlank(sqlString.toString()))&#123;<br><span class="hljs-type">Object</span> <span class="hljs-variable">params</span> <span class="hljs-operator">=</span> joinPoint.getArgs()[<span class="hljs-number">0</span>];<br><span class="hljs-keyword">if</span> (StringUtils.isNotNull(params) &amp;&amp; params <span class="hljs-keyword">instanceof</span> BaseEntity)&#123;<br><span class="hljs-type">BaseEntity</span> <span class="hljs-variable">baseEntity</span> <span class="hljs-operator">=</span> (BaseEntity) params;<br>baseEntity.getParams().put(DATA_SCOPE, <span class="hljs-string">&quot; AND (&quot;</span> + sqlString.substring(<span class="hljs-number">4</span>) + <span class="hljs-string">&quot;)&quot;</span>);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure>æœ€ååœ¨ mapper.xml æ–‡ä»¶ä¸­ï¼Œä¼šæŠŠæ·»åŠ çš„å†…å®¹æ‹¼æ¥åˆ°æŸ¥è¯¢è¯­å¥æœ€å <code>$&#123;params.dataScope&#125;</code><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;selectDeptList&quot;</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">&quot;SysDept&quot;</span> <span class="hljs-attr">resultMap</span>=<span class="hljs-string">&quot;SysDeptResult&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">refid</span>=<span class="hljs-string">&quot;selectDeptVo&quot;</span>/&gt;</span><br>where d.del_flag = &#x27;0&#x27;<br><span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;deptId != null and deptId != 0&quot;</span>&gt;</span><br>AND dept_id = #&#123;deptId&#125;<br><span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;parentId != null and parentId != 0&quot;</span>&gt;</span><br>AND parent_id = #&#123;parentId&#125;<br><span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;deptName != null and deptName != &#x27;&#x27;&quot;</span>&gt;</span><br>AND dept_name like concat(&#x27;%&#x27;, #&#123;deptName&#125;, &#x27;%&#x27;)<br><span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;status != null and status != &#x27;&#x27;&quot;</span>&gt;</span><br>AND status = #&#123;status&#125;<br><span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br><span class="hljs-comment">&lt;!-- æ•°æ®èŒƒå›´è¿‡æ»¤ --&gt;</span><br>$&#123;params.dataScope&#125;<br>order by d.parent_id, d.order_num<br><span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br></code></pre></td></tr></table></figure></li></ol><h2 id="6-å¼‚å¸¸å¤„ç†"><a href="#6-å¼‚å¸¸å¤„ç†" class="headerlink" title="6 å¼‚å¸¸å¤„ç†"></a>6 å¼‚å¸¸å¤„ç†</h2><p>é¦–å…ˆéœ€è¦è‡ªå®šä¹‰å¼‚å¸¸ï¼Œæ¯”å¦‚è¿™é‡Œçš„ç™»å½•å¼‚å¸¸ï¼Œç»§æ‰¿äº† RuntimeExceptionï¼Œä¿è¯ Spring äº‹åŠ¡ä¸å¤±æ•ˆï¼Œå› ä¸º Spring äº‹åŠ¡é»˜è®¤å¤„ç†çš„æ˜¯è¿è¡Œæ—¶å¼‚å¸¸ï¼Œå¦‚æœæŠ›å‡ºæ£€æŸ¥æ€§å¼‚å¸¸å°±ä¸ä¼šè¿›è¡Œå›æ»š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.ruoyi.common.exception;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * ç™»å½•å¼‚å¸¸</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> ruoyi</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">RuntimeException</span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> String message;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">LoginException</span><span class="hljs-params">(String message)</span>&#123;<br>        <span class="hljs-built_in">this</span>.message = message;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getMessage</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> message;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>åˆ›å»ºå…¨å±€å¼‚å¸¸å¤„ç†å™¨ï¼Œåœ¨ç±»ä¸ŠåŠ ä¸€ä¸ªæ³¨è§£ï¼Œ@RestControllerAdvice &#x3D; @ControllerAdvice + @ResponseBody</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestControllerAdvice</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GlobalExceptionHandler</span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">log</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(GlobalExceptionHandler.class);<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * ç™»å½•å¼‚å¸¸</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@ExceptionHandler(LoginException.class)</span><br>    <span class="hljs-keyword">public</span> AjaxResult <span class="hljs-title function_">loginException</span><span class="hljs-params">(LoginException e)</span>&#123;<br>        log.error(e.getMessage(), e);<br>        <span class="hljs-keyword">return</span> AjaxResult.error(e.getMessage());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="7-æ•°æ®å¯¼å…¥å¯¼å‡º"><a href="#7-æ•°æ®å¯¼å…¥å¯¼å‡º" class="headerlink" title="7 æ•°æ®å¯¼å…¥å¯¼å‡º"></a>7 æ•°æ®å¯¼å…¥å¯¼å‡º</h2><h3 id="7-1-å¯¼å‡º"><a href="#7-1-å¯¼å‡º" class="headerlink" title="7.1 å¯¼å‡º"></a>7.1 å¯¼å‡º</h3><h2 id="8-ç™»å½•ç®¡ç†"><a href="#8-ç™»å½•ç®¡ç†" class="headerlink" title="8 ç™»å½•ç®¡ç†"></a>8 ç™»å½•ç®¡ç†</h2><h3 id="8-1-SpringSecurity-å‰ç½®çŸ¥è¯†"><a href="#8-1-SpringSecurity-å‰ç½®çŸ¥è¯†" class="headerlink" title="8.1 SpringSecurity å‰ç½®çŸ¥è¯†"></a>8.1 SpringSecurity å‰ç½®çŸ¥è¯†</h3><p>SpringSecurity è®¤è¯æµç¨‹</p><blockquote><p>Filter-&gt;æ„é€ Token-&gt;AuthenticationManager-&gt;è½¬ç»™Providerå¤„ç†-&gt;è®¤è¯å¤„ç†æˆåŠŸåç»­æ“ä½œæˆ–è€…ä¸é€šè¿‡æŠ›å¼‚å¸¸</p></blockquote><p>ç™»å½•é€»è¾‘</p><blockquote><p>ç™»å½•ğŸ‘‰æ‹¿åˆ°tokenğŸ‘‰è¯·æ±‚å¸¦ä¸ŠtokenğŸ‘‰JWTè¿‡æ»¤å™¨æ‹¦æˆªğŸ‘‰æ ¡éªŒtokenğŸ‘‰å°†ä»ç¼“å­˜ä¸­æŸ¥å‡ºæ¥çš„å¯¹è±¡æ”¾åˆ°ä¸Šä¸‹æ–‡ä¸­</p></blockquote><p>é‡è¦æ¦‚å¿µ</p><ul><li>SecurityContextï¼šä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œ<code>Authentication</code> å¯¹è±¡ä¼šæ”¾åœ¨é‡Œé¢ã€‚</li><li>SecurityContextHolderï¼šç”¨äºæ‹¿åˆ°ä¸Šä¸‹æ–‡å¯¹è±¡çš„é™æ€å·¥å…·ç±»ã€‚</li><li>Authenticationï¼šè®¤è¯æ¥å£ï¼Œå®šä¹‰äº†è®¤è¯å¯¹è±¡çš„æ•°æ®å½¢å¼ã€‚</li><li>AuthenticationManagerï¼šç”¨äºæ ¡éªŒ <code>Authentication</code> ï¼Œè¿”å›ä¸€ä¸ªè®¤è¯å®Œæˆåçš„ <code>Authentication</code> å¯¹è±¡<ul><li>Authentication æ˜¯ä¸ªæ¥å£, å¸¸ç”¨çš„å®ç°ç±»æ˜¯ <code>UsernamePasswordAuthenticationToken</code></li><li>æ²¡è®¤è¯çš„ <code>UsernamePasswordAuthenticationToken</code> æ˜¯ <code>this.setAuthenticated(false);</code></li><li>è®¤è¯ä¹‹åæ˜¯ <code>super.setAuthenticated(true);</code><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">UsernamePasswordAuthenticationToken</span><span class="hljs-params">(Object principal, Object credentials)</span> &#123;<br><span class="hljs-built_in">super</span>((Collection)<span class="hljs-literal">null</span>);<br><span class="hljs-built_in">this</span>.principal = principal;<br><span class="hljs-built_in">this</span>.credentials = credentials;<br><span class="hljs-built_in">this</span>.setAuthenticated(<span class="hljs-literal">false</span>);<br>&#125;<br><span class="hljs-keyword">public</span> <span class="hljs-title function_">UsernamePasswordAuthenticationToken</span><span class="hljs-params">(Object principal, Object credentials, Collection&lt;? extends GrantedAuthority&gt; authorities)</span> &#123;<br><span class="hljs-built_in">super</span>(authorities);<br><span class="hljs-built_in">this</span>.principal = principal;<br><span class="hljs-built_in">this</span>.credentials = credentials;<br><span class="hljs-built_in">super</span>.setAuthenticated(<span class="hljs-literal">true</span>);<br>&#125;<br></code></pre></td></tr></table></figure></li></ul></li></ul><ol><li><p>SecurityContext<br>ä¸Šä¸‹æ–‡å¯¹è±¡, è®¤è¯åçš„æ•°æ®å°±æ”¾åœ¨è¿™é‡Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">SecurityContext</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Serializable</span> &#123;<br> <span class="hljs-comment">// è·å–Authenticationå¯¹è±¡</span><br> Authentication <span class="hljs-title function_">getAuthentication</span><span class="hljs-params">()</span>;<br><br> <span class="hljs-comment">// æ”¾å…¥Authenticationå¯¹è±¡</span><br> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAuthentication</span><span class="hljs-params">(Authentication authentication)</span>;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>SecurityContextHolder<br>å¯ä»¥è¯´æ˜¯SecurityContextçš„å·¥å…·ç±»ï¼Œç”¨äºget or set or clear SecurityContextï¼Œé»˜è®¤ä¼šæŠŠæ•°æ®éƒ½å­˜å‚¨åˆ°å½“å‰çº¿ç¨‹ä¸­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityContextHolder</span> &#123;<br><br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clearContext</span><span class="hljs-params">()</span> &#123;<br>  strategy.clearContext();<br> &#125;<br><br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SecurityContext <span class="hljs-title function_">getContext</span><span class="hljs-params">()</span> &#123;<br>  <span class="hljs-keyword">return</span> strategy.getContext();<br> &#125;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setContext</span><span class="hljs-params">(SecurityContext context)</span> &#123;<br>  strategy.setContext(context);<br> &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>AuthenticationManager<br>å°†ä¸€ä¸ªæœªè®¤è¯çš„Authenticationä¼ å…¥ï¼Œè¿”å›ä¸€ä¸ªå·²è®¤è¯çš„Authenticationï¼Œé»˜è®¤ä½¿ç”¨çš„å®ç°ç±»ä¸ºï¼šProviderManager</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AuthenticationManager</span> &#123;<br> <span class="hljs-comment">// è®¤è¯æ–¹æ³•</span><br> Authentication <span class="hljs-title function_">authenticate</span><span class="hljs-params">(Authentication authentication)</span><br>   <span class="hljs-keyword">throws</span> AuthenticationException;<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><p>Controller çš„è¯·æ±‚åˆ° SysLoginController#login</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@PostMapping(&quot;/login&quot;)</span><br><span class="hljs-keyword">public</span> AjaxResult <span class="hljs-title function_">login</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> LoginBody loginBody)</span><br>&#123;<br><span class="hljs-type">AjaxResult</span> <span class="hljs-variable">ajax</span> <span class="hljs-operator">=</span> AjaxResult.success();<br><span class="hljs-comment">// ç”Ÿæˆä»¤ç‰Œ</span><br><span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> loginService.login(loginBody.getUsername(), loginBody.getPassword(), loginBody.getCode(),<br>loginBody.getUuid());<br>ajax.put(Constants.TOKEN, token);<br><span class="hljs-keyword">return</span> ajax;<br>&#125;<br></code></pre></td></tr></table></figure><p>è°ƒç”¨ Service çš„ login æ–¹æ³•</p><p>å…¶ä¸­ uuid æ¥éªŒè¯è¾“å…¥çš„éªŒè¯ç ä¸ Redis ä¸­çš„éªŒè¯ç æ˜¯å¦åŒ¹é…</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">authentication = authenticationManager.authenticate(authenticationToken);<br></code></pre></td></tr></table></figure><p>SpringSecurity çš„éªŒè¯æ–¹æ³•é‰´æƒï¼Œè¿™ä¸ªè¯­å¥æ˜¯æ ¸å¿ƒè¯­å¥<br>ä¸‹é¢å°± <code>authenticationManager</code> å¯¹è±¡åˆ›å»º<br><code>authenticate</code> æ–¹æ³•å‚æ•°ï¼Œæ¥è§£æè¿™ä¸ªç™»å½•é‰´æƒè¿‡ç¨‹</p><ol><li>ä¼ å…¥ç”¨æˆ·åå’Œå¯†ç åˆ›å»ºäº†ä¸€ä¸ªUsernamePasswordAuthenticationTokenå¯¹è±¡ï¼Œè¿™æ˜¯æˆ‘ä»¬å‰é¢è¯´è¿‡çš„Authenticationçš„å®ç°ç±»ï¼Œä¼ å…¥ç”¨æˆ·åå’Œå¯†ç åšæ„é€ å‚æ•°ï¼Œè¿™ä¸ªå¯¹è±¡å°±æ˜¯æˆ‘ä»¬åˆ›å»ºå‡ºæ¥çš„æœªè®¤è¯çš„Authenticationå¯¹è±¡ã€‚</li><li>ä½¿ç”¨æˆ‘ä»¬å…ˆå‰å·²ç»å£°æ˜è¿‡çš„Bean-authenticationManagerè°ƒç”¨å®ƒçš„authenticateæ–¹æ³•è¿›è¡Œè®¤è¯ï¼Œè¿”å›ä¸€ä¸ªè®¤è¯å®Œæˆçš„Authenticationå¯¹è±¡ã€‚</li><li>è®¤è¯å®Œæˆæ²¡æœ‰å‡ºç°å¼‚å¸¸ï¼Œä½¿ç”¨SecurityContextHolderè·å–SecurityContextä¹‹åï¼Œå°†è®¤è¯å®Œæˆä¹‹åçš„Authenticationå¯¹è±¡ï¼Œæ”¾å…¥ä¸Šä¸‹æ–‡å¯¹è±¡ã€‚</li><li>ä»Authenticationå¯¹è±¡ä¸­æ‹¿åˆ°æˆ‘ä»¬çš„UserDetailså¯¹è±¡ï¼Œä¹‹å‰æˆ‘ä»¬è¯´è¿‡ï¼Œè®¤è¯åçš„Authenticationå¯¹è±¡è°ƒç”¨å®ƒçš„getPrincipal()æ–¹æ³•å°±å¯ä»¥æ‹¿åˆ°æˆ‘ä»¬å…ˆå‰æ•°æ®åº“æŸ¥è¯¢åç»„è£…å‡ºæ¥çš„UserDetailså¯¹è±¡ï¼Œç„¶ååˆ›å»ºtokenã€‚</li></ol><p>å…¶ä¸­ authenticationManager å¯¹è±¡æ˜¯é…ç½®ç±»é…ç½®çš„ bean<br>å®šä¹‰äº†ä¸€ä¸ªé…ç½®ç±» SecurityConfig ç»§æ‰¿äº† WebSecurityConfigurerAdapter å®šä¹‰äº† AuthenticationManager å¯¹è±¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@EnableGlobalMethodSecurity(prePostEnabled = true, securedEnabled = true)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span>&#123;<br><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * è§£å†³ æ— æ³•ç›´æ¥æ³¨å…¥ AuthenticationManager</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> AuthenticationManager <span class="hljs-title function_">authenticationManagerBean</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception<br>    &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.authenticationManagerBean();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ ¸å¿ƒä»£ç ä¸­è°ƒç”¨çš„è¿™ä¸ªæ–¹æ³• <code>authenticate</code> ä¼ å…¥çš„å‚æ•°æ˜¯ <code>Authentication</code> ç±»å‹çš„ï¼Œæ‰€ä»¥éœ€è¦åœ¨å‰é¢åˆ›å»ºå‡º <code>Authentication</code> ç±»çš„å¯¹è±¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">UsernamePasswordAuthenticationToken</span> <span class="hljs-variable">authenticationToken</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UsernamePasswordAuthenticationToken</span>(username, password);<br></code></pre></td></tr></table></figure><p>å…¶ä¸­ <code>UsernamePasswordAuthenticationToken</code> æ˜¯ <code>Authentication</code> ç±»çš„å­ç±»ï¼Œéœ€è¦æŠŠç”¨æˆ·åå’Œå¯†ç ä¼ é€’è¿›å»<br>è¿™æ˜¯ <code>authenticate</code> æ–¹æ³•ä¼ é€’çš„å‚æ•°æ¥æº</p><p>ä¹‹å <code>authenticate</code> æ–¹æ³•ä¼šæ‰§è¡Œä¸€ä¸ªè¿‡æ»¤å™¨é“¾(SpringSecurity è‡ªåŠ¨è°ƒç”¨), æœ€ç»ˆä¼šè°ƒç”¨åˆ° <code>UserDetailsService</code> è¿™ä¸ªæ¥å£çš„ <code>loadUserByUsername</code> æ–¹æ³•, è¿™é‡Œæœ‰ä¸€ä¸ªå®ç°ç±» <code>UserDetailsServiceImpl</code> å®ç°äº†è¿™ä¸ªæ¥å£æ¥å£é‡å†™äº†æ–¹æ³•<br>æ‰€ä»¥æœ€ç»ˆ <code>authenticate</code> ä¼šè°ƒç”¨ <code>UserDetailsServiceImpl.loadUserByUsername</code> </p><p>åœ¨ <code>SysLoginService.login</code> æ–¹æ³•, æ ¸å¿ƒä»£ç ä¹‹å‰è¿˜æœ‰ä¸€ä¸ª, æŠŠ <code>Authentication</code> å¯¹è±¡å­˜åˆ° ThreadLocal çš„æ“ä½œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// ç»™ç”¨æˆ·åå¯†ç å°è£…åˆ°è¿™é‡Œ</span><br><span class="hljs-type">UsernamePasswordAuthenticationToken</span> <span class="hljs-variable">authenticationToken</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UsernamePasswordAuthenticationToken</span>(username, password);<br>AuthenticationContextHolder.setContext(authenticationToken);<br><span class="hljs-comment">// è¯¥æ–¹æ³•ä¼šå»è°ƒç”¨UserDetailsServiceImpl.loadUserByUsername</span><br>authentication = authenticationManager.authenticate(authenticationToken);<br></code></pre></td></tr></table></figure><p>å…¶ä¸­ç¬¬äºŒè¡ŒæŠŠ <code>Authentication</code> ä¿å­˜åˆ°äº† ThreadLocal ä¸­, <code>AuthenticationContextHolder</code> åº•å±‚å°è£…äº† ThreadLocal<br>åœ¨ <code>UserDetailsServiceImpl.loadUserByUsername</code> ä¸­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> UserDetails <span class="hljs-title function_">loadUserByUsername</span><span class="hljs-params">(String username)</span> <span class="hljs-keyword">throws</span> UsernameNotFoundException<br>&#123;<br><span class="hljs-type">SysUser</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userService.selectUserByUserName(username);<br><span class="hljs-keyword">if</span> (StringUtils.isNull(user))<br>&#123;<br>log.info(<span class="hljs-string">&quot;ç™»å½•ç”¨æˆ·ï¼š&#123;&#125; ä¸å­˜åœ¨.&quot;</span>, username);<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServiceException</span>(MessageUtils.message(<span class="hljs-string">&quot;user.not.exists&quot;</span>));<br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (UserStatus.DELETED.getCode().equals(user.getDelFlag()))<br>&#123;<br>log.info(<span class="hljs-string">&quot;ç™»å½•ç”¨æˆ·ï¼š&#123;&#125; å·²è¢«åˆ é™¤.&quot;</span>, username);<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServiceException</span>(MessageUtils.message(<span class="hljs-string">&quot;user.password.delete&quot;</span>));<br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (UserStatus.DISABLE.getCode().equals(user.getStatus()))<br>&#123;<br>log.info(<span class="hljs-string">&quot;ç™»å½•ç”¨æˆ·ï¼š&#123;&#125; å·²è¢«åœç”¨.&quot;</span>, username);<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServiceException</span>(MessageUtils.message(<span class="hljs-string">&quot;user.blocked&quot;</span>));<br>&#125;<br><br>passwordService.validate(user);<br><br><span class="hljs-keyword">return</span> createLoginUser(user);<br>&#125;<br></code></pre></td></tr></table></figure><p>æ ¹æ® username æŸ¥è¯¢äº†æ•°æ®åº“, å¾—åˆ°äº† SysUser å¯¹è±¡<br>è°ƒç”¨äº† passwordService.validate() æ–¹æ³•, è¿›å…¥ validate æ–¹æ³•å†…<br>è¿™ä¸ªæ–¹æ³•å†…</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">validate</span><span class="hljs-params">(SysUser user)</span><br>&#123;<br><span class="hljs-type">Authentication</span> <span class="hljs-variable">usernamePasswordAuthenticationToken</span> <span class="hljs-operator">=</span> AuthenticationContextHolder.getContext();<br><span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> usernamePasswordAuthenticationToken.getName();<br><span class="hljs-type">String</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> usernamePasswordAuthenticationToken.getCredentials().toString();<br><br><span class="hljs-type">Integer</span> <span class="hljs-variable">retryCount</span> <span class="hljs-operator">=</span> redisCache.getCacheObject(getCacheKey(username));<br><br><span class="hljs-keyword">if</span> (retryCount == <span class="hljs-literal">null</span>)<br>&#123;<br>retryCount = <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-keyword">if</span> (retryCount &gt;= Integer.valueOf(maxRetryCount).intValue())<br>&#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserPasswordRetryLimitExceedException</span>(maxRetryCount, lockTime);<br>&#125;<br><br><span class="hljs-keyword">if</span> (!matches(user, password))<br>&#123;<br>retryCount = retryCount + <span class="hljs-number">1</span>;<br>redisCache.setCacheObject(getCacheKey(username), retryCount, lockTime, TimeUnit.MINUTES);<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserPasswordNotMatchException</span>();<br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br>clearLoginRecordCache(username);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªæ–¹æ³•é¦–å…ˆä»ä¹‹å‰çš„ <code>AuthenticationContextHolder</code> (æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª ThreadLocal) ä»å–å‡ºä¹‹å‰å­˜çš„ <code>UsernamePasswordAuthenticationToken</code> å¯¹è±¡(é‡Œé¢æ˜¯<strong>ç”¨æˆ·è¾“å…¥çš„</strong>ç”¨æˆ·åå’Œå¯†ç )</p><p>username å’Œ password æ˜¯ä»–ä» <code>UsernamePasswordAuthenticationToken</code> é‡Œå–å‡ºæ¥çš„<br>è·Ÿæ•°æ®åº“æŸ¥å‡ºæ¥çš„å¯†ç è¿›è¡Œæ¯”è¾ƒ(åŠ å¯†ä¹‹åæ¯”è¾ƒ,  å› ä¸ºæ•°æ®åº“é‡Œæ˜¯å­˜å‚¨çš„å¯†æ–‡, SpringSecurity è‡ªåŠ¨åŠ å¯†åçš„, SpringSecurity é»˜è®¤æ˜¯ç”¨ BCryptPasswordEncoder æ¥è¿›è¡ŒåŠ å¯†çš„)</p><p>æœ‰ä¸€ä¸ª retryCount å˜é‡, å¦‚æœ<br>å¦‚æœä¸åŒ¹é…, æŠŠ retryCount æ”¾åˆ° Redis é‡Œé»˜è®¤è®¾ç½® 10 åˆ†é’Ÿ, å¦‚æœè¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°è®¾ç½®çš„æ˜¯ 5 æ¬¡, å°±æŠ›å‡ºå¼‚å¸¸</p><p>å¦‚æœæœŸé—´å†…åŒ¹é…æˆåŠŸ, å°±ä» Redis ä¸­åˆ é™¤ key</p><p>æœ€å <code>UserDetailsServiceImpl.loadUserByUsername</code> æ˜¯ SpringSecurity æä¾›çš„æ–¹æ³•, å®ƒçš„è¿”å›å€¼æ˜¯ <code>UserDetails</code> ç±»å‹çš„, ruoyi åˆ›å»ºäº†ä¸€ä¸ª <code>LoginUser</code> ç±»ç»§æ‰¿äº† <code>UserDetails</code><br>æ‰€ä»¥  <code>UserDetailsServiceImpl.loadUserByUsername</code> æ–¹æ³•è¿”å›äº† <code>LoginUser</code> å¯¹è±¡<br>æƒé™å­—ç¬¦æ˜¯åœ¨ <code>UserDetailsServiceImpl.createLoginUser</code> æ–¹æ³•ä¸­é€šè¿‡æ„é€ æ–¹æ³•å­˜å…¥ LoginUser ä¸­çš„, æœ‰ä¸ªè°ƒç”¨ <code>permissionService</code> çš„è¡Œä¸º</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> UserDetails <span class="hljs-title function_">createLoginUser</span><span class="hljs-params">(SysUser user)</span>&#123;<br><span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LoginUser</span>(user.getUserId(), user.getDeptId(), user, permissionService.getMenuPermission(user));<br>&#125;<br></code></pre></td></tr></table></figure><p>å‰é¢ <code>UserDetailsServiceImpl.loadUserByUsername</code> æ‰§è¡ŒæˆåŠŸä¹‹åä¼šæŠŠ <code>UserDetails</code> å¯¹è±¡å­˜å‚¨åˆ° <code>authentication</code> å¯¹è±¡ä¸­<br>å›åˆ° <code>SysLoginService</code> æ–¹æ³•ä¸­, ç¬¬äºŒè¡Œå¾—åˆ° <code>getPrincipal</code> å¯¹è±¡å¯ä»¥å¼ºè½¬ä¸º LoginUser</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">AsyncManager.me().execute(AsyncFactory.recordLogininfor(username, Constants.LOGIN_SUCCESS, MessageUtils.message(<span class="hljs-string">&quot;user.login.success&quot;</span>)));<br><span class="hljs-type">LoginUser</span> <span class="hljs-variable">loginUser</span> <span class="hljs-operator">=</span> (LoginUser) authentication.getPrincipal();<br>recordLoginInfo(loginUser.getUserId());<br></code></pre></td></tr></table></figure><p><img src="https://gitee.com/AWallFlower/picture/raw/master/img/20240423173322.png" alt="image.png"></p><p>ç¬¬ä¸€è¡Œæ˜¯å¼‚æ­¥æ‰§è¡Œæ–¹æ³•, todo<br>æœ€åä¸€è¡Œæ˜¯è®°å½•ç”¨æˆ·ä¿¡æ¯, ç™»å½•çš„ ip å’Œç™»å½•çš„æ—¶é—´</p><h2 id="9-å¼‚æ­¥ä»»åŠ¡ç®¡ç†å™¨"><a href="#9-å¼‚æ­¥ä»»åŠ¡ç®¡ç†å™¨" class="headerlink" title="9 å¼‚æ­¥ä»»åŠ¡ç®¡ç†å™¨"></a>9 å¼‚æ­¥ä»»åŠ¡ç®¡ç†å™¨</h2><p>ä»–å®šä¹‰äº†ä¸€ä¸ªç±», ç”¨æ¥ç®¡ç†å¼‚æ­¥ä»»åŠ¡è°ƒç”¨<br>å…¶ä¸­è¿™ä¸ªæˆå‘˜å˜é‡è·å– <code>ThreadPoolTaskExecutor</code> å¯¹è±¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-type">ScheduledExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> SpringUtils.getBean(<span class="hljs-string">&quot;scheduledExecutorService&quot;</span>);<br></code></pre></td></tr></table></figure><p>å…¶ä¸­ SpringUtils æ˜¯ ruoyi å°è£…çš„ä¸€ä¸ªå·¥å…·ç±»å®ç°äº† <code>BeanFactoryPostProcessor å’Œ ApplicationContextAware</code> ä¸¤ä¸ªæ¥å£</p><ul><li>BeanFactoryPostProcessor æ¥å£æ˜¯ä¸ºäº†æ‹¿åˆ° <code>ConfigurableListableBeanFactory</code> å¯¹è±¡</li><li>ApplicationContextAware æ¥å£æ˜¯ä¸ºäº†æ‹¿åˆ° <code>ApplicationContext</code><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringUtils</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BeanFactoryPostProcessor</span>, ApplicationContextAware <br>&#123;<br>    <span class="hljs-comment">/** Springåº”ç”¨ä¸Šä¸‹æ–‡ç¯å¢ƒ */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ConfigurableListableBeanFactory beanFactory;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ApplicationContext applicationContext;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">postProcessBeanFactory</span><span class="hljs-params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="hljs-keyword">throws</span> BeansException <br>    &#123;<br>        SpringUtils.beanFactory = beanFactory;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setApplicationContext</span><span class="hljs-params">(ApplicationContext applicationContext)</span> <span class="hljs-keyword">throws</span> BeansException <br>    &#123;<br>        SpringUtils.applicationContext = applicationContext;<br>    &#125;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * è·å–å¯¹è±¡</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> name</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> Object ä¸€ä¸ªä»¥æ‰€ç»™åå­—æ³¨å†Œçš„beançš„å®ä¾‹</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> org.springframework.beans.BeansException</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; T <span class="hljs-title function_">getBean</span><span class="hljs-params">(String name)</span> <span class="hljs-keyword">throws</span> BeansException<br>    &#123;<br>        <span class="hljs-keyword">return</span> (T) beanFactory.getBean(name);<br>    &#125;<br>    <span class="hljs-comment">// ä¸‹é¢è¿˜æœ‰æ–¹æ³•, æ„Ÿå…´è¶£å¯ä»¥ç¿»çœ‹ ruoyi æºç </span><br>&#125;<br></code></pre></td></tr></table></figure></li></ul><p>å›åˆ° <code>AsyncManager</code> å¯¹è±¡é‡Œ, å¾—åˆ°äº† <code>ScheduledExecutorService</code> è¿™ä¸ª bean, è¿™ä¸ª bean å®šä¹‰åœ¨<code>ThreadPoolConfig</code> ä¸­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-type">ScheduledExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> SpringUtils.getBean(<span class="hljs-string">&quot;scheduledExecutorService&quot;</span>);<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * æ‰§è¡Œå‘¨æœŸæ€§æˆ–å®šæ—¶ä»»åŠ¡</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Bean(name = &quot;scheduledExecutorService&quot;)</span><br><span class="hljs-keyword">protected</span> ScheduledExecutorService <span class="hljs-title function_">scheduledExecutorService</span><span class="hljs-params">()</span><br>&#123;<br><span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ScheduledThreadPoolExecutor</span>(corePoolSize,<br><span class="hljs-keyword">new</span> <span class="hljs-title class_">BasicThreadFactory</span>.Builder().namingPattern(<span class="hljs-string">&quot;schedule-pool-%d&quot;</span>).daemon(<span class="hljs-literal">true</span>).build(),<br><span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>.CallerRunsPolicy())<br>&#123;<br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterExecute</span><span class="hljs-params">(Runnable r, Throwable t)</span><br>&#123;<br><span class="hljs-built_in">super</span>.afterExecute(r, t);<br>Threads.printException(r, t);<br>&#125;<br>&#125;;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œ new äº†ä¸€ä¸ª <code>ScheduledThreadPoolExecutor</code> å¯¹è±¡<br>å¹¶ä¸”é‡å†™äº†ä¸€ä¸ª <code>afterExecute</code> æ–¹æ³•, è¿™ä¸ªæ–¹æ³•æ˜¯ <code>ScheduledThreadPoolExecutor</code> ç±»ç»§æ‰¿è‡ª <code>ThreadPoolExecutor</code> ç±»çš„<br>è¿™ç§å†™æ³•ç¬¬ä¸€æ¬¡è§</p><p>å›åˆ° <code>AsyncManager</code> é‡‡ç”¨å•ä¾‹æ¨¡å¼ç”Ÿæˆå¯¹è±¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * å•ä¾‹æ¨¡å¼</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">private</span> <span class="hljs-title function_">AsyncManager</span><span class="hljs-params">()</span>&#123;&#125;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">AsyncManager</span> <span class="hljs-variable">me</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AsyncManager</span>();<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> AsyncManager <span class="hljs-title function_">me</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-keyword">return</span> me;<br>&#125;<br></code></pre></td></tr></table></figure><p>æœ‰ä¸ªæ–¹æ³•æ‰§è¡Œçš„å‡½æ•°, ä¼ å…¥ä»»åŠ¡, å»¶æ—¶æ—¶é—´, å»¶æ—¶æ—¶é—´çš„å•ä½</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">(TimerTask task)</span><br>&#123;<br>executor.schedule(task, OPERATE_DELAY_TIME, TimeUnit.MILLISECONDS);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="10-å¼‚æ­¥å·¥å‚ï¼ˆäº§ç”Ÿä»»åŠ¡ç”¨ï¼‰"><a href="#10-å¼‚æ­¥å·¥å‚ï¼ˆäº§ç”Ÿä»»åŠ¡ç”¨ï¼‰" class="headerlink" title="10 å¼‚æ­¥å·¥å‚ï¼ˆäº§ç”Ÿä»»åŠ¡ç”¨ï¼‰"></a>10 å¼‚æ­¥å·¥å‚ï¼ˆäº§ç”Ÿä»»åŠ¡ç”¨ï¼‰</h2><p>è¿™ä¸ªå·¥å‚æ˜¯ä¸“é—¨è®°å½•ç™»å½•æ—¥å¿—çš„, å­˜å‚¨åˆ° sys_logininfor è¡¨ä¸­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * å¼‚æ­¥å·¥å‚ï¼ˆäº§ç”Ÿä»»åŠ¡ç”¨ï¼‰</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> ruoyi</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncFactory</span><br>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">sys_user_logger</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(<span class="hljs-string">&quot;sys-user&quot;</span>);<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * è®°å½•ç™»å½•ä¿¡æ¯</span><br><span class="hljs-comment">     * </span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> username ç”¨æˆ·å</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> status çŠ¶æ€</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> message æ¶ˆæ¯</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> args åˆ—è¡¨</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> ä»»åŠ¡task</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> TimerTask <span class="hljs-title function_">recordLogininfor</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String username, <span class="hljs-keyword">final</span> String status, <span class="hljs-keyword">final</span> String message,</span><br><span class="hljs-params">            <span class="hljs-keyword">final</span> Object... args)</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="11-æ—¥å¿—è®°å½•-LogAspect-ç±»"><a href="#11-æ—¥å¿—è®°å½•-LogAspect-ç±»" class="headerlink" title="11 æ—¥å¿—è®°å½• LogAspect ç±»"></a>11 æ—¥å¿—è®°å½• LogAspect ç±»</h2><p>é¦–å…ˆåˆ›å»ºä¸€ä¸ªæ—¥å¿—è®°å½•å¯¹è±¡, å…¶ä¸­ LogAspect.class æ˜¯ä¸ºäº†æ ‡è¯†è¿™ä¸ªæ—¥å¿—å¯¹è±¡, ç›¸å½“äºç»™è¿™ä¸ªæ—¥å¿—å¯¹è±¡èµ·äº†ä¸ªåå­—</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">log</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(LogAspect.class);<br></code></pre></td></tr></table></figure><h3 id="getLogger-åˆ›å»ºå¯¹è±¡è·Ÿ-Slf4j-æœ‰ä»€ä¹ˆåŒºåˆ«"><a href="#getLogger-åˆ›å»ºå¯¹è±¡è·Ÿ-Slf4j-æœ‰ä»€ä¹ˆåŒºåˆ«" class="headerlink" title="getLogger åˆ›å»ºå¯¹è±¡è·Ÿ @Slf4j æœ‰ä»€ä¹ˆåŒºåˆ«"></a>getLogger åˆ›å»ºå¯¹è±¡è·Ÿ @Slf4j æœ‰ä»€ä¹ˆåŒºåˆ«</h3><ul><li>getLogger åˆ›å»ºå¯¹è±¡æ˜¯ç›´æ¥ä½¿ç”¨ SLF4J çš„ api åˆ›å»ºä¸€ä¸ª Logger å¯¹è±¡, ç”¨äºè®°å½•æ—¥å¿—, LogAspect.class æ˜¯è¿™ä¸ª Logger çš„åå­—, é€šå¸¸ç”¨äºåŒºåˆ†ä¸åŒç±»</li><li>@Slf4j æ˜¯ lombok æä¾›çš„ä¸€ä¸ªæ³¨è§£, ç”¨äºåœ¨ç¼–è¯‘æ—¶è‡ªåŠ¨åœ¨ç±»ä¸­å£°æ˜ä¸€ä¸ªåä¸º log çš„ Logger å¯¹è±¡, åˆ›å»ºæ–¹å¼ä¸ä¸Šè¿°ä»£ç ç›¸åŒ</li></ul><p>æ—¥å¿—ç±»ä¸­å®šä¹‰äº†ä¸€ä¸ª ThreadLocal, ç”¨äºè®¡ç®—æ“ä½œæ¶ˆè€—çš„æ—¶é—´, åœ¨æ–¹æ³•æ‰§è¡Œå‰ set å½“å‰æ—¶é—´, æ–¹æ³•è¿”å›æ—¶ç”¨å½“å‰æ—¶é—´å‡å»ä¹‹å‰ set çš„æ—¶é—´, æœ€ååœ¨ finally ä»£ç å—ä¸­ remove æ‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/** è®¡ç®—æ“ä½œæ¶ˆè€—æ—¶é—´ */</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ThreadLocal&lt;Long&gt; TIME_THREADLOCAL = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NamedThreadLocal</span>&lt;&gt;(<span class="hljs-string">&quot;Cost Time&quot;</span>);<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * å¤„ç†è¯·æ±‚å‰æ‰§è¡Œ</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">// ä»£è¡¨æœ‰ä¸Šé¢æœ‰ @Log æ³¨è§£çš„æ–¹æ³•ï¼Œéœ€è¦ä»£ç†</span><br><span class="hljs-meta">@Before(value = &quot;@annotation(controllerLog)&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">boBefore</span><span class="hljs-params">(JoinPoint joinPoint, Log controllerLog)</span><br>&#123;<br>TIME_THREADLOCAL.set(System.currentTimeMillis());<br>&#125;<br></code></pre></td></tr></table></figure><p>å¤„ç†å®Œè¯·æ±‚æ‰§è¡Œ<br>å…¶ä¸­æ³¨è§£ä¸Šçš„ <code>returning = jsonResult</code> åº”è¯¥æ˜¯ä¸ºäº†è·Ÿæ–¹æ³•å‚æ•°ä¸­çš„ <code>jsonResult</code> ç»‘å®š, ä¸ºäº†è·å–ç›®æ ‡æ–¹æ³•çš„æ‰§è¡Œç»“æœ<br>æ³¨è§£ä¸Šçš„ <code>pointcut = &quot;@annotation(controllerLog)&quot;</code> åº”è¯¥æ˜¯ä¸ºäº†è·Ÿæ–¹æ³•å‚æ•°ä¸­ <code>Log controllerLog</code> ç»‘å®š, åªè¦æ˜¯æ–¹æ³•ä¸Šæœ‰ <code>@Log</code> æ³¨è§£çš„, éƒ½è¦è¢«ä»£ç†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * å¤„ç†å®Œè¯·æ±‚åæ‰§è¡Œ</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> joinPoint åˆ‡ç‚¹</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">// returning æ˜¯ä¸ºäº†è·å–ç›®æ ‡æ–¹æ³•çš„æ‰§è¡Œç»“æœ</span><br><span class="hljs-meta">@AfterReturning(pointcut = &quot;@annotation(controllerLog)&quot;, returning = &quot;jsonResult&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doAfterReturning</span><span class="hljs-params">(JoinPoint joinPoint, Log controllerLog, Object jsonResult)</span><br>&#123;<br>handleLog(joinPoint, controllerLog, <span class="hljs-literal">null</span>, jsonResult);<br>&#125;<br></code></pre></td></tr></table></figure><p>å°†åˆ‡ç‚¹, @Log æ³¨è§£, è¿”å›å€¼éƒ½ä¼ é€’ç»™ handleLog æ–¹æ³•</p><p>handleLog æ–¹æ³•æ¥æ”¶ 4 ä¸ªå‚æ•°</p><ul><li>åˆ‡ç‚¹</li><li>æ³¨è§£</li><li>å¼‚å¸¸</li><li>è¿”å›å€¼<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleLog</span><span class="hljs-params">(<span class="hljs-keyword">final</span> JoinPoint joinPoint, Log controllerLog, <span class="hljs-keyword">final</span> Exception e, Object jsonResult)</span><br></code></pre></td></tr></table></figure></li></ul><p>åˆ›å»ºæ•°æ®åº“æ—¥å¿—å¯¹è±¡, å°è£…å±æ€§<br>å…ˆç»™æ“ä½œçŠ¶æ€è®¾ç½®æˆæˆåŠŸ,</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">SysOperLog</span> <span class="hljs-variable">operLog</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SysOperLog</span>();<br>operLog.setStatus(BusinessStatus.SUCCESS.ordinal());<br></code></pre></td></tr></table></figure><ul><li>BusinessStatus æ˜¯ä¸€ä¸ªæšä¸¾ç±»å‹, é‡Œé¢æœ‰ä¸¤ä¸ªå€¼</li><li>æšä¸¾ç±»å‹æœ¬èº«é‡Œé¢æœ‰å±æ€§<ul><li>name æšä¸¾çš„åå­—, æ¯”å¦‚ <code>BusinessStatus.SUCCESS.name()</code> å¾—åˆ°çš„å°±æ˜¯å­—ç¬¦ä¸² <code>SUCCESS</code></li><li>ordinal æ˜¯æšä¸¾çš„åºæ•°, ä» 0 å¼€å§‹<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">BusinessStatus</span><br>&#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * æˆåŠŸ</span><br><span class="hljs-comment">     */</span><br>    SUCCESS,<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * å¤±è´¥</span><br><span class="hljs-comment">     */</span><br>    FAIL,<br>&#125;<br></code></pre></td></tr></table></figure></li></ul></li></ul><p>RequestContextHolder æ˜¯ Spring çš„ä¸€ä¸ªç±», ç”¨äºå­˜å‚¨å½“å‰çº¿ç¨‹çš„ RequestAttributes å¯¹è±¡<br>RequestAttributes å¯¹è±¡åŒ…å«äº†ä¸å½“å‰ HTTP è¯·æ±‚ç›¸å…³çš„å±æ€§ï¼Œä¾‹å¦‚è¯·æ±‚å‚æ•°ã€è¯·æ±‚å¤´ã€ä¼šè¯å±æ€§ç­‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RequestContextHolder</span> &#123;<br><span class="hljs-comment">// ... ä¸€äº›å±æ€§</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ThreadLocal&lt;RequestAttributes&gt; requestAttributesHolder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NamedThreadLocal</span>(<span class="hljs-string">&quot;Request attributes&quot;</span>);<br><span class="hljs-comment">// ... ä¸€äº›æ–¹æ³•</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ä»–å¾—åˆ°è¯·æ±‚å‚æ•°ä¹‹å, è¿™æ¡è¯­å¥å¯ä»¥å¾—åˆ° ip</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">ip</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">&quot;x-forwarded-for&quot;</span>);<br></code></pre></td></tr></table></figure><p>å¦‚æœè·å–ä¸åˆ°, ä¸‹é¢è¿˜æœ‰åˆ¤æ–­è¯­å¥</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (ip == <span class="hljs-literal">null</span> || ip.length() == <span class="hljs-number">0</span> || <span class="hljs-string">&quot;unknown&quot;</span>.equalsIgnoreCase(ip))<br>&#123;<br>ip = request.getHeader(<span class="hljs-string">&quot;Proxy-Client-IP&quot;</span>);<br>&#125;<br><span class="hljs-keyword">if</span> (ip == <span class="hljs-literal">null</span> || ip.length() == <span class="hljs-number">0</span> || <span class="hljs-string">&quot;unknown&quot;</span>.equalsIgnoreCase(ip))<br>&#123;<br>ip = request.getHeader(<span class="hljs-string">&quot;X-Forwarded-For&quot;</span>);<br>&#125;<br><span class="hljs-keyword">if</span> (ip == <span class="hljs-literal">null</span> || ip.length() == <span class="hljs-number">0</span> || <span class="hljs-string">&quot;unknown&quot;</span>.equalsIgnoreCase(ip))<br>&#123;<br>ip = request.getHeader(<span class="hljs-string">&quot;WL-Proxy-Client-IP&quot;</span>);<br>&#125;<br><span class="hljs-keyword">if</span> (ip == <span class="hljs-literal">null</span> || ip.length() == <span class="hljs-number">0</span> || <span class="hljs-string">&quot;unknown&quot;</span>.equalsIgnoreCase(ip))<br>&#123;<br>ip = request.getHeader(<span class="hljs-string">&quot;X-Real-IP&quot;</span>);<br>&#125;<br><br><span class="hljs-keyword">if</span> (ip == <span class="hljs-literal">null</span> || ip.length() == <span class="hljs-number">0</span> || <span class="hljs-string">&quot;unknown&quot;</span>.equalsIgnoreCase(ip))<br>&#123;<br>ip = request.getRemoteAddr();<br>&#125;<br><br><span class="hljs-keyword">return</span> <span class="hljs-string">&quot;0:0:0:0:0:0:0:1&quot;</span>.equals(ip) ? <span class="hljs-string">&quot;127.0.0.1&quot;</span> : getMultistageReverseProxyIp(ip);<br></code></pre></td></tr></table></figure><p>é€šè¿‡è¿™ä¸ªè·å– URI</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">ServletUtils.getRequest().getRequestURI()<br></code></pre></td></tr></table></figure><p>åç»­çš„ä¸€äº›æ“ä½œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// è®¾ç½®æ–¹æ³•åç§°</span><br><span class="hljs-type">String</span> <span class="hljs-variable">className</span> <span class="hljs-operator">=</span> joinPoint.getTarget().getClass().getName();<br><span class="hljs-type">String</span> <span class="hljs-variable">methodName</span> <span class="hljs-operator">=</span> joinPoint.getSignature().getName();<br>operLog.setMethod(className + <span class="hljs-string">&quot;.&quot;</span> + methodName + <span class="hljs-string">&quot;()&quot;</span>);<br><span class="hljs-comment">// è®¾ç½®è¯·æ±‚æ–¹å¼</span><br>operLog.setRequestMethod(ServletUtils.getRequest().getMethod());<br><span class="hljs-comment">// å¤„ç†è®¾ç½®æ³¨è§£ä¸Šçš„å‚æ•°</span><br>getControllerMethodDescription(joinPoint, controllerLog, operLog, jsonResult);<br><span class="hljs-comment">// è®¾ç½®æ¶ˆè€—æ—¶é—´</span><br>operLog.setCostTime(System.currentTimeMillis() - TIME_THREADLOCAL.get());<br></code></pre></td></tr></table></figure><p>æœ€åå¼‚æ­¥æ’å…¥æ•°æ®åº“</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">AsyncManager.me().execute(AsyncFactory.recordOper(operLog));<br><br></code></pre></td></tr></table></figure><p>è°ƒç”¨å¼‚æ­¥å·¥å‚é‡Œçš„ä¸€ä¸ªæ–¹æ³•, æŠŠæ—¥å¿—è®°å½•åˆ°æ•°æ®åº“é‡Œ<br>ä»–è¿™ä¸ª TimerTask ç»§æ‰¿äº† Runnable æ¥å£, æ‰€ä»¥è¦é‡å†™é‡Œé¢çš„ run æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * æ“ä½œæ—¥å¿—è®°å½•</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> operLog æ“ä½œæ—¥å¿—ä¿¡æ¯</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> ä»»åŠ¡task</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> TimerTask <span class="hljs-title function_">recordOper</span><span class="hljs-params">(<span class="hljs-keyword">final</span> SysOperLog operLog)</span><br>&#123;<br><span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TimerTask</span>()<br>&#123;<br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span><br>&#123;<br><span class="hljs-comment">// è¿œç¨‹æŸ¥è¯¢æ“ä½œåœ°ç‚¹</span><br>operLog.setOperLocation(AddressUtils.getRealAddressByIP(operLog.getOperIp()));<br>SpringUtils.getBean(ISysOperLogService.class).insertOperlog(operLog);<br>&#125;<br>&#125;;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="12-é…ç½®å¤šæ•°æ®æº"><a href="#12-é…ç½®å¤šæ•°æ®æº" class="headerlink" title="12 é…ç½®å¤šæ•°æ®æº"></a>12 é…ç½®å¤šæ•°æ®æº</h2><p>é¦–å…ˆ ruoyi ç”¨çš„æ˜¯ Druid æ•°æ®æº<br>ä¸‹é¢ä¸»ä»åº“æ˜¯ Druid ä¸»ä»åº“çš„é…ç½®æ–¹å¼</p><p>é¦–å…ˆ Spring Boot çš„ application.yml ä¸­æ¿€æ´»äº† druid, å®ƒçš„æ„æ€æ˜¯æŠŠåä¸º <code>application-druid.yml</code> çš„é…ç½®æ–‡ä»¶åŠ è½½è¿›æ¥</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">profiles:</span><br>    <span class="hljs-attr">active:</span> <span class="hljs-string">druid</span><br></code></pre></td></tr></table></figure><p>å…¶ä¸­ <code>application-druid.yml</code> ä¸­å¯ä»¥é…ä¸»ä»æ•°æ®åº“</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"># æ•°æ®æºé…ç½®<br>spring:<br>    datasource:<br>        type: com.alibaba.druid.pool.DruidDataSource<br>        driverClassName: com.mysql.cj.jdbc.Driver<br>        druid:<br>            # ä¸»åº“æ•°æ®æº<br>            master:<br>                url: jdbc:mysql:<span class="hljs-comment">//localhost:3306/ruoyi-vue?useUnicode=true&amp;characterEncoding=utf8&amp;zeroDateTimeBehavior=convertToNull&amp;useSSL=true&amp;serverTimezone=GMT%2B8</span><br>                username: root<br>                password: sudong8016<br>            # ä»åº“æ•°æ®æº<br>            slave:<br>                # ä»æ•°æ®æºå¼€å…³/é»˜è®¤å…³é—­<br>                enabled: <span class="hljs-literal">false</span><br>                url: <br>                username: <br>                password: <br></code></pre></td></tr></table></figure><p>åœ¨ DruidConfig ä¸­ä¼šæœ‰å¯¹åº”çš„ bean<br><code>@ConfigurationProperties(&quot;spring.datasource.druid.slave&quot;)</code> ï¼Œç”¨äºå°†é…ç½®æ–‡ä»¶ä¸­çš„å±æ€§å€¼ç»‘å®šåˆ°Javaå¯¹è±¡ä¸Š<br>å®ƒå°† <code>application-druid.yml</code> é…ç½®æ–‡ä»¶ä¸­ä»¥ <code>spring.datasource.druid.slave</code> ä¸ºå‰ç¼€çš„å±æ€§å€¼ç»‘å®šåˆ°äº†å½“å‰çš„Beanï¼ˆå³DataSourceï¼‰ä¸Š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DruidConfig</span><br>&#123;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-meta">@ConfigurationProperties(&quot;spring.datasource.druid.master&quot;)</span><br>    <span class="hljs-keyword">public</span> DataSource <span class="hljs-title function_">masterDataSource</span><span class="hljs-params">(DruidProperties druidProperties)</span><br>    &#123;<br>        <span class="hljs-type">DruidDataSource</span> <span class="hljs-variable">dataSource</span> <span class="hljs-operator">=</span> DruidDataSourceBuilder.create().build();<br>        <span class="hljs-keyword">return</span> druidProperties.dataSource(dataSource);<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-meta">@ConfigurationProperties(&quot;spring.datasource.druid.slave&quot;)</span><br>    <span class="hljs-meta">@ConditionalOnProperty(prefix = &quot;spring.datasource.druid.slave&quot;, name = &quot;enabled&quot;, havingValue = &quot;true&quot;)</span><br>    <span class="hljs-keyword">public</span> DataSource <span class="hljs-title function_">slaveDataSource</span><span class="hljs-params">(DruidProperties druidProperties)</span><br>    &#123;<br>        <span class="hljs-type">DruidDataSource</span> <span class="hljs-variable">dataSource</span> <span class="hljs-operator">=</span> DruidDataSourceBuilder.create().build();<br>        <span class="hljs-keyword">return</span> druidProperties.dataSource(dataSource);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="DataSourceAspect"><a href="#DataSourceAspect" class="headerlink" title="DataSourceAspect"></a>DataSourceAspect</h3><p>å®šä¹‰äº†ä¸€ä¸ªåˆ‡ç‚¹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Pointcut(&quot;@annotation(com.ruoyi.common.annotation.DataSource)&quot;</span><br><span class="hljs-meta">+ &quot;|| @within(com.ruoyi.common.annotation.DataSource)&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">dsPointCut</span><span class="hljs-params">()</span> &#123;&#125;<br></code></pre></td></tr></table></figure><p><code>@within(com.ruoyi.common.annotation.DataSource)</code> å°†ä¼šåŒ¹é…æ‰€æœ‰åœ¨ç±»ä¸Šæ ‡æ³¨äº† @DataSource æ³¨è§£çš„ç±»ä¸­çš„æ‰€æœ‰æ–¹æ³•</p><p>åœ¨è¿™é‡ŒæŠŠæ³¨è§£ä¼ å…¥çš„ DataSourceType è®¾ç½®åˆ° ThreadLocal ä¸­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Around(&quot;dsPointCut()&quot;)</span><br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">around</span><span class="hljs-params">(ProceedingJoinPoint point)</span> <span class="hljs-keyword">throws</span> Throwable<br>&#123;<br><span class="hljs-type">DataSource</span> <span class="hljs-variable">dataSource</span> <span class="hljs-operator">=</span> getDataSource(point);<br><br><span class="hljs-keyword">if</span> (StringUtils.isNotNull(dataSource))<br>&#123;<br>DynamicDataSourceContextHolder.setDataSourceType(dataSource.value().name());  <span class="hljs-comment">// è®¾ç½®åˆ° ThreadLocal ä¸­</span><br>&#125;<br><br><span class="hljs-keyword">try</span><br>&#123;<br><span class="hljs-keyword">return</span> point.proceed();<br>&#125;<br><span class="hljs-keyword">finally</span><br>&#123;<br><span class="hljs-comment">// é”€æ¯æ•°æ®æº åœ¨æ‰§è¡Œæ–¹æ³•ä¹‹å</span><br>DynamicDataSourceContextHolder.clearDataSourceType();<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>é€šè¿‡ <code>AbstractRoutingDataSource</code> ç”¨äºåŠ¨æ€è·¯ç”±æ•°æ®æºã€‚è¿™ä¸ªç±»çš„ä¸»è¦ä½œç”¨æ˜¯æ ¹æ®æŸç§ç­–ç•¥ï¼ŒåŠ¨æ€åœ°é€‰æ‹©ä¸€ä¸ªæ•°æ®æºï¼Œç„¶åå°†å½“å‰çš„æ•°æ®åº“æ“ä½œè·¯ç”±åˆ°è¿™ä¸ªæ•°æ®æºä¸Š<br>è¿™ç§æœºåˆ¶åœ¨å®ç°æ•°æ®åº“è¯»å†™åˆ†ç¦»ã€å¤šæ•°æ®æºåˆ‡æ¢ç­‰åœºæ™¯æ—¶éå¸¸æœ‰ç”¨</p><p><code>AbstractRoutingDataSource</code> ç±»æœ¬èº«å¹¶ä¸çŸ¥é“åº”è¯¥é€‰æ‹©å“ªä¸ªæ•°æ®æºï¼Œè¿™ä¸ªå†³å®šç”±å­ç±»é€šè¿‡å®ç° <code>determineCurrentLookupKey()</code> æ–¹æ³•æ¥åšå‡ºã€‚è¿™ä¸ªæ–¹æ³•åº”è¯¥è¿”å›ä¸€ä¸ªèƒ½å”¯ä¸€æ ‡è¯†æ•°æ®æºçš„ keyï¼Œç„¶å <code>AbstractRoutingDataSource</code> å°±ä¼šä½¿ç”¨è¿™ä¸ª key æ¥æŸ¥æ‰¾å¹¶é€‰æ‹©å¯¹åº”çš„æ•°æ®æº</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DynamicDataSource</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractRoutingDataSource</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">DynamicDataSource</span><span class="hljs-params">(DataSource defaultTargetDataSource, Map&lt;Object, Object&gt; targetDataSources)</span><br>    &#123;<br>        <span class="hljs-built_in">super</span>.setDefaultTargetDataSource(defaultTargetDataSource);<br>        <span class="hljs-built_in">super</span>.setTargetDataSources(targetDataSources);<br>        <span class="hljs-built_in">super</span>.afterPropertiesSet();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">determineCurrentLookupKey</span><span class="hljs-params">()</span><br>    &#123;<br>        <span class="hljs-keyword">return</span> DynamicDataSourceContextHolder.getDataSourceType();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="13-æ³¨è§£"><a href="#13-æ³¨è§£" class="headerlink" title="13 æ³¨è§£"></a>13 æ³¨è§£</h2><h3 id="PostConstruct"><a href="#PostConstruct" class="headerlink" title="@PostConstruct"></a>@PostConstruct</h3><p>åœ¨åˆå§‹åŒ–ä¹‹åä¼šæ‰§è¡Œè¿™é‡Œçš„ä»£ç , é€šå¸¸ç”¨äºæ‰§è¡Œä¸€äº›åˆå§‹åŒ–å·¥ä½œ, æ¯”å¦‚åŠ è½½ç¼“å­˜, å¯åŠ¨æŸä¸ªåå°çº¿ç¨‹ç­‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * é¡¹ç›®å¯åŠ¨æ—¶ï¼Œåˆå§‹åŒ–å‚æ•°åˆ°ç¼“å­˜</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@PostConstruct</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span><br>&#123;<br>loadingConfigCache();<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>è‹¥ä¾</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Memcachedä¸ºä»€ä¹ˆæ¯”Redisæ›´èƒ½æŠ—çƒ­ç‚¹</title>
    <link href="/2024/10/17/Memcached%E4%B8%BA%E4%BB%80%E4%B9%88%E6%AF%94Redis%E6%9B%B4%E8%83%BD%E6%8A%97%E7%83%AD%E7%82%B9/"/>
    <url>/2024/10/17/Memcached%E4%B8%BA%E4%BB%80%E4%B9%88%E6%AF%94Redis%E6%9B%B4%E8%83%BD%E6%8A%97%E7%83%AD%E7%82%B9/</url>
    
    <content type="html"><![CDATA[<h1 id="Memcachedä¸ºä»€ä¹ˆæ¯”Redisæ›´èƒ½æŠ—çƒ­ç‚¹"><a href="#Memcachedä¸ºä»€ä¹ˆæ¯”Redisæ›´èƒ½æŠ—çƒ­ç‚¹" class="headerlink" title="Memcachedä¸ºä»€ä¹ˆæ¯”Redisæ›´èƒ½æŠ—çƒ­ç‚¹"></a>Memcachedä¸ºä»€ä¹ˆæ¯”Redisæ›´èƒ½æŠ—çƒ­ç‚¹</h1><h2 id="çƒ­ç‚¹é—®é¢˜çš„æœ¬è´¨"><a href="#çƒ­ç‚¹é—®é¢˜çš„æœ¬è´¨" class="headerlink" title="çƒ­ç‚¹é—®é¢˜çš„æœ¬è´¨"></a>çƒ­ç‚¹é—®é¢˜çš„æœ¬è´¨</h2><p>çƒ­ç‚¹ key æœ€ä¸»è¦çš„é—®é¢˜è¿˜æ˜¯å®ƒä¼šå¯¼è‡´ç¼“å­˜çš„æµé‡ä¸å‡è¡¡ï¼Œä¼šå¯¼è‡´å•èŠ‚ç‚¹æµé‡è¿‡é«˜ï¼Œæ— æ³•å‘æŒ¥é›†ç¾¤çš„ä½œç”¨ï¼Œæ•´ä¸ªRedisé›†ç¾¤èƒ½æ”¯æ’‘çš„QPSå°±é€€åŒ–æˆäº†å•ä¸ªå®ä¾‹èƒ½æ”¯æ’‘çš„QPSäº†</p><h2 id="Memcached-ä¸ºä»€ä¹ˆæŠ—çƒ­ç‚¹æ€§èƒ½æ›´å¥½"><a href="#Memcached-ä¸ºä»€ä¹ˆæŠ—çƒ­ç‚¹æ€§èƒ½æ›´å¥½" class="headerlink" title="Memcached ä¸ºä»€ä¹ˆæŠ—çƒ­ç‚¹æ€§èƒ½æ›´å¥½"></a>Memcached ä¸ºä»€ä¹ˆæŠ—çƒ­ç‚¹æ€§èƒ½æ›´å¥½</h2><p>ç¬¬ä¸€ä¸ªæ˜¯ Memcached é€šè¿‡å¤šçº¿ç¨‹å¯ä»¥åˆ©ç”¨å¤šæ ¸ï¼Œä»è€Œå¯ä»¥æ˜¾è‘—æå‡å•ä¸ªå®ä¾‹çš„ååï¼Œé’ˆå¯¹è¿™ç§æµé‡å€¾æ–œçš„æƒ…å†µå¯ä»¥æ›´å¥½çš„åº”å¯¹</p><p>ä¸‹å›¾æ˜¯ä¸€ä¸ªä¾‹å­ï¼Œå‡è®¾æ¯ä¸ªCPUæ ¸èƒ½æ”¯æ’‘5W QPSï¼ˆä¸è€ƒè™‘å…¶ä»–çš„å¼€é”€ï¼Œæ¯”å¦‚å¤šçº¿ç¨‹çš„å¼€é”€ï¼Œå®ç°çš„ä¸åŒï¼‰ï¼ŒMemcachedå’ŒRedisä»é›†ç¾¤ç»´åº¦éƒ½å¯ä»¥æŠ—10W QPSï¼Œä½†æ˜¯å…·ä½“åˆ°çƒ­ç‚¹è¯·æ±‚ï¼Œå•ä¸ªRediså®ä¾‹å°±åªèƒ½æŠ—5W QPSäº†ï¼Œè¿™æ ·ä¸¤è€…çš„æŠ—çƒ­ç‚¹èƒ½åŠ›å°±å·®äº†ä¸€å€ï¼Œçº¿ä¸Šæˆ‘ä»¬çš„Memcachedå®ä¾‹é€šå¸¸ä¼šå¼€10ä¸ªçº¿ç¨‹æˆ–è€…æ›´å¤šï¼ŒMemcachedå’ŒRediså•å®ä¾‹çš„ååèƒ½åŠ›ä¼šæœ‰æ›´å¤§çš„å·®å¼‚</p><p><img src="https://gitee.com/AWallFlower/picture/raw/master/img/20250109222030.png"></p><p>å¦‚æœæˆ‘ä»¬çš„æœºå™¨åªæœ‰1æ ¸ï¼Œå¯¹äºget&#x2F;setçš„æ“ä½œMemcachedçš„æŠ—çƒ­ç‚¹èƒ½åŠ›å¯èƒ½è¿˜ä¸å¦‚Redisï¼Œå› ä¸ºå¤šçº¿ç¨‹è¿˜ä¼šæœ‰ä¸€äº›éƒ¨åˆ†é¢å¤–çš„å¼€é”€</p><p>ç¬¬äºŒä¸ªæ˜¯Redisçš„ä¸€äº›æ•°æ®ç»“æ„çš„æ“ä½œå¤æ‚åº¦å¹¶ä¸æ˜¯O(1)ï¼Œæ¯”å¦‚zrangeï¼Œå¤æ‚åº¦æ˜¯O(log(N) + M)ï¼Œå¦‚æœå¯¹äºæœ‰1000(å¯¹åº”N)ä¸ªå…ƒç´ çš„zsetå–100(å¯¹åº”M)ä¸ªï¼Œé‚£å®ƒçš„å¼€é”€è‚¯å®šè¦è¿œå¤§äºgetï¼Œå¯¹äºè¿™äº›æ“ä½œå•ä¸ªrediså®ä¾‹èƒ½æ”¯æ’‘QPSä¼šé™ä½å¾ˆå¤šï¼Œé‚£ç›¸åº”çš„æŠ—çƒ­ç‚¹èƒ½åŠ›ä¹Ÿä¼šæ›´å·®</p><h2 id="Memcached-ä¸€å®šèƒ½æŠ—çƒ­ç‚¹å—"><a href="#Memcached-ä¸€å®šèƒ½æŠ—çƒ­ç‚¹å—" class="headerlink" title="Memcached ä¸€å®šèƒ½æŠ—çƒ­ç‚¹å—"></a>Memcached ä¸€å®šèƒ½æŠ—çƒ­ç‚¹å—</h2><p>ç»å¤§éƒ¨åˆ†åœºæ™¯ä¸‹MemcachedæŠ—çƒ­ç‚¹èƒ½åŠ›è¿˜æ˜¯èƒ½è¾¾åˆ°é¢„æœŸæ•ˆæœçš„ï¼Œä½†æ˜¯å¦‚æœä½ çš„Keyæ¯”è¾ƒå¤§ï¼Œé‚£è¿™ä¸ªç»“è®ºå°±å¯èƒ½ä¸æˆç«‹äº†ï¼Œå¯¹äºå¤§Key å®ƒçš„ç“¶é¢ˆå¯èƒ½ä¸åœ¨CPUè€Œæ˜¯åœ¨ç½‘å¡çš„å¸¦å®½ä¸Šäº†</p><p>å¯¹äºä¸€äº›å¤§Keyçš„è®¿é—®ï¼Œå¯èƒ½å‡ ä¸‡QPSå°±èƒ½æŠŠç½‘å¡çš„å¸¦å®½ç”¨æ»¡äº†ï¼Œè€Œä¸”è¿™ä¸ªæœ€å‘çš„åœ°æ–¹æ˜¯ï¼Œå¦‚æœå•ä¸ªMemcachedå®ä¾‹æŠŠç½‘å¡å æ»¡äº†ï¼Œéƒ¨ç½²åœ¨è¿™å°æœºå™¨ä¸Šçš„å…¶ä»–å®ä¾‹ä¹Ÿä¼šå—å½±å“ï¼Œæ‰€ä»¥æˆ‘ä»¬å°½é‡è¿˜æ˜¯è¦é¿å…ä¸€äº›å¤§Keyçš„æƒ…å†µï¼Œå¦‚æœKeyæ¯”è¾ƒå¤§é‚£Memcachedçš„æŠ—çƒ­ç‚¹èƒ½åŠ›ä¹Ÿä¼šæ˜¾è‘—ä¸‹é™</p><h2 id="çƒ­ç‚¹å¤„ç†æ–¹æ¡ˆ"><a href="#çƒ­ç‚¹å¤„ç†æ–¹æ¡ˆ" class="headerlink" title="çƒ­ç‚¹å¤„ç†æ–¹æ¡ˆ"></a>çƒ­ç‚¹å¤„ç†æ–¹æ¡ˆ</h2><h3 id="æœ¬åœ°ç¼“å­˜"><a href="#æœ¬åœ°ç¼“å­˜" class="headerlink" title="æœ¬åœ°ç¼“å­˜"></a>æœ¬åœ°ç¼“å­˜</h3><p>é€šè¿‡ <code>LoadingCache</code> å°†æ•°æ®æš‚å­˜åˆ°ä¸»è°ƒå†…å­˜ä¸­ï¼Œå¯ä»¥æœ‰æ•ˆé™ä½å¯¹ç¼“å­˜çš„å‹åŠ›</p><p>æœ¬åœ°ç¼“å­˜å¯¹äºçš„get&#x2F;setçš„æ“ä½œå®ç°æ¯”è¾ƒç®€å•ï¼Œä½†æ˜¯å¯¹äºzrangeè¿™äº›æ¶‰åŠå¤šä¸ªå‚æ•°å‘½ä»¤ä¼šéº»çƒ¦ä¸€äº›ï¼Œé™¤äº†Keyè¿˜éœ€è¦ä¼ å…¥ä¸€äº›å…¶ä»–çš„å‚æ•°ï¼Œæ¯”å¦‚from,limitç­‰ï¼Œå¦‚æœå°†è¿™äº›å‚æ•°ä½œä¸ºæœ¬åœ°ç¼“å­˜çš„keyï¼Œé‚£å¯èƒ½å‡ºç°å‚æ•°å˜åŒ–æœ¬åœ°ç¼“å­˜keyå¤±æ•ˆçš„æƒ…å†µï¼Œæ¯”å¦‚æœ‰ä¸ªzsetä½¿ç”¨æ—¶é—´ä½œä¸ºscoreï¼Œæˆ‘ä»¬éœ€è¦æŒ‰ç…§æ—¶é—´å€’åºå–å‰100ä¸ªå…ƒç´ ï¼Œå¦‚æœfromç”¨Double.MAX_VALUEæ²¡ä»€ä¹ˆé—®é¢˜ï¼Œä½†æ˜¯å¦‚æœfromä½¿ç”¨çš„æ˜¯System.currentTimeMillisï¼Œé‚£æ¯æ¬¡è¯·æ±‚å‚æ•°éƒ½ä¼šå˜åŒ–ï¼Œæœ¬åœ°ç¼“å­˜å°±å¤±æ•ˆäº†</p>]]></content>
    
    
    
    <tags>
      
      <tag>Redis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Caffeine æ·˜æ±°ç­–ç•¥</title>
    <link href="/2024/09/30/Caffeine%20%E6%B7%98%E6%B1%B0%E7%AD%96%E7%95%A5/"/>
    <url>/2024/09/30/Caffeine%20%E6%B7%98%E6%B1%B0%E7%AD%96%E7%95%A5/</url>
    
    <content type="html"><![CDATA[<h1 id="Caffeine-æ·˜æ±°ç­–ç•¥"><a href="#Caffeine-æ·˜æ±°ç­–ç•¥" class="headerlink" title="Caffeine æ·˜æ±°ç­–ç•¥"></a>Caffeine æ·˜æ±°ç­–ç•¥</h1><p>ä½¿ç”¨äº† W-TinyLFU ç®—æ³•ï¼Œè¯¥ç®—æ³•ä¸»è¦æœ‰ä¸¤éƒ¨åˆ†</p><ol><li>é‡‡ç”¨ Count-Min Sketch ç®—æ³•é™ä½é¢‘ç‡ä¿¡æ¯å¸¦æ¥çš„å†…å­˜æ¶ˆè€—</li><li>é€šè¿‡ç»´æŠ¤ä¸€ä¸ª PK æœºåˆ¶ä¿éšœæ–°ä¸Šçš„çƒ­ç‚¹æ•°æ®èƒ½å¤Ÿè¢«ç¼“å­˜</li></ol><h2 id="Count-Min-Sketch-ç®—æ³•"><a href="#Count-Min-Sketch-ç®—æ³•" class="headerlink" title="Count-Min Sketch ç®—æ³•"></a>Count-Min Sketch ç®—æ³•</h2><p>è¯¥ç®—æ³•é¦–å…ˆè®¤ä¸ºï¼šå¯¹äºé¢‘ç‡ç»Ÿè®¡ï¼Œæˆ‘ä»¬å…¶å®ä¸éœ€è¦ä¸€ä¸ªç²¾ç¡®å€¼ã€‚åœ¨å­˜å‚¨æ•°æ®æ—¶ï¼Œå®ƒé¦–å…ˆå¯¹ key è¿›è¡Œå¤šç§ hash å‡½æ•°è¿ç®—ï¼Œç„¶ååœ¨å„ä¸ª hash å‡½æ•°å¯¹åº”çš„äºŒç»´æ•°ç»„ç´¢å¼•ä½ç½®çš„è®°å½•å€¼ +1</p><p>å¤šä¸ª hash ç®—æ³•æ˜¯ä¸ºäº†é¿å… hash å†²çª</p><p><img src="https://gitee.com/AWallFlower/picture/raw/master/img/20250109213928.png"></p><p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œé‡‡ç”¨å¤šä¸ª hash ç®—æ³•ï¼Œå‡è®¾ä½¿ç”¨å››ç§ hash ç®—æ³•ä»è¯¥ key åœ¨æ‰€æœ‰ hash ç®—æ³•ä¸‹æ˜ å°„çš„ä½ç½®å–æ•°å€¼æœ€ä½çš„ä¸€ä¸ªæ•°ä½œä¸ºè®¿é—®é¢‘ç‡ï¼ˆä¸Šå›¾è®¿é—®é¢‘ç‡ä¸º 1ï¼‰</p><p>Caffeine ä¹Ÿåˆ©ç”¨äº† Count-Min Sketch çš„æ€æƒ³ï¼Œä½†æ˜¯å®ƒæœ‰ç¨å¾®çš„å˜åŒ–</p><p>Caffeine ä½¿ç”¨ä¸€ç»´ long æ•°ç»„ç”¨æ¥è®°å½•æ•°æ®çš„è®¿é—®é¢‘ç‡ï¼Œæ•°ç»„çš„å¤§å°ä¸º2çš„ N æ¬¡æ–¹ï¼Œç”±ç¼“å­˜å¤§å°å†³å®šã€‚å‡è®¾ç¼“å­˜å¤§å°æ˜¯ 100ï¼Œæ•°ç»„çš„å¤§å°éœ€è¦æ»¡è¶³ï¼š</p><p>ç®€å•æ¥è¯´å°±æ˜¯ï¼Œæ•°ç»„çš„å¤§å°å°±æ˜¯ç¬¬ä¸€ä¸ªå¤§äºç­‰äºç¼“å­˜å¤§å°çš„ 2 çš„ N æ¬¡æ–¹ã€‚å¦‚æœç¼“å­˜å¤§å°ä¸º 100ï¼Œé‚£ä¹ˆç”¨äºè®°å½•æ•°æ®è®¿é—®é¢‘ç‡çš„æ•°ç»„å¤§å°å°±æ˜¯128</p><h2 id="PK-æœºåˆ¶"><a href="#PK-æœºåˆ¶" class="headerlink" title="PK æœºåˆ¶"></a>PK æœºåˆ¶</h2><p>Caffeine æ‰€æœ‰çš„æ•°æ®éƒ½å­˜å‚¨åœ¨ ConcurrentHashMap ä¸­ã€‚åœ¨ Caffeine ä¸­æœ‰ä¸‰ä¸ªç”¨äºå­˜å‚¨å¼•ç”¨çš„ LRU é˜Ÿåˆ—ï¼Œåˆ†åˆ«æ˜¯</p><ul><li>Window Cache</li><li>Probation Cache</li><li>Protected Cache</li></ul><p>å…¶ä¸­Probation Cache å’Œ Protected Cache ç»„æˆäº† Main Cacheã€‚æ­£å¸¸æƒ…å†µä¸‹ï¼ŒWindow Cache å æ¯”å¤§å°ä¸º 1%ï¼ŒProbation Cache å¤§å°ä¸ºå‰©ä¸‹çš„ 99% çš„ 20%ï¼ŒProtected Cache å¤§å°ä¸ºå‰©ä¸‹çš„ 99% çš„ 80%</p><p>æ–°æ•°æ®ç›´æ¥è¿›å…¥ Window åŒºï¼Œå½“ Window åŒºæ»¡äº†ï¼Œå°±ä¼šæ ¹æ® LRU ç®—æ³•æŠŠ Candidateï¼ˆå³æ·˜æ±°å‡ºæ¥çš„å…ƒç´ ï¼‰æ”¾åˆ° Probation åŒº</p><p>å¦‚æœåœ¨ Probation åŒºçš„æ•°æ®è¢«è®¿é—®åˆ°ï¼Œä¼šç›´æ¥è¿›å…¥åˆ°ProtectedåŒºã€‚å¦‚æœProtectedåŒºæ»¡äº†ï¼Œè¯¥åŒºæ·˜æ±°å‡ºçš„æ•°æ®å°†é™çº§åˆ°ProbationåŒº</p><p>å¦‚æœ Probation åŒºæ»¡äº†ï¼Œå°±æŠŠ Candidate å’Œ Probation åŒºçš„ Victimï¼ˆå°†è¦æ·˜æ±°çš„å…ƒç´ ï¼‰ï¼Œä¸¤ä¸ªè¿›è¡Œ â€œPKâ€ï¼ˆæ¯”è¾ƒä¸¤è€…é¢‘ç‡å¤§å°ï¼‰ï¼Œèƒœè€…å°†ç•™åœ¨ Probationï¼Œè¾“è€…å°±è¦è¢«æ·˜æ±°äº†ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå®é™…ä¸Šçš„æ•°æ®æ·˜æ±°ï¼Œåªåœ¨ Probation åŒºå‘ç”Ÿ</p>]]></content>
    
    
    
    <tags>
      
      <tag>æœ¬åœ°ç¼“å­˜</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Memcached å’Œ Redis å†…å­˜ç®¡ç†</title>
    <link href="/2024/09/20/Memcached%20%E5%92%8C%20Redis%20%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/"/>
    <url>/2024/09/20/Memcached%20%E5%92%8C%20Redis%20%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/</url>
    
    <content type="html"><![CDATA[<h1 id="Memcached-å’Œ-Redis-å†…å­˜ç®¡ç†"><a href="#Memcached-å’Œ-Redis-å†…å­˜ç®¡ç†" class="headerlink" title="Memcached å’Œ Redis å†…å­˜ç®¡ç†"></a>Memcached å’Œ Redis å†…å­˜ç®¡ç†</h1><p>ä¼ ç»Ÿçš„ C è¯­è¨€çš„ malloc&#x2F;free å‡½æ•°æ˜¯æœ€å¸¸ç”¨çš„åˆ†é…å’Œé‡Šæ”¾å†…å­˜çš„æ–¹æ³•ï¼Œä½†æ˜¯è¿™ç§æ–¹æ³•å­˜åœ¨ç€å¾ˆå¤§çš„ç¼ºé™·</p><ol><li>ä¸åŒ¹é…çš„mallocå’Œfreeå®¹æ˜“é€ æˆå†…å­˜æ³„éœ²</li><li>é¢‘ç¹è°ƒç”¨ä¼šé€ æˆå¤§é‡å†…å­˜ç¢ç‰‡æ— æ³•å›æ”¶é‡æ–°åˆ©ç”¨ï¼Œé™ä½å†…å­˜åˆ©ç”¨ç‡</li><li>ä½œä¸ºç³»ç»Ÿè°ƒç”¨ï¼Œå…¶ç³»ç»Ÿå¼€é”€è¿œè¿œå¤§äºä¸€èˆ¬å‡½æ•°è°ƒç”¨</li></ol><h2 id="Memcached"><a href="#Memcached" class="headerlink" title="Memcached"></a>Memcached</h2><p>Memcachedé»˜è®¤ä½¿ç”¨Slab Allocationæœºåˆ¶ç®¡ç†å†…å­˜ï¼Œå…¶ä¸»è¦æ€æƒ³æ˜¯æŒ‰ç…§é¢„å…ˆè§„å®šçš„å¤§å°ï¼Œå°†åˆ†é…çš„å†…å­˜åˆ†å‰²æˆç‰¹å®šé•¿åº¦çš„å—ä»¥å­˜å‚¨ç›¸åº”é•¿åº¦çš„key-valueæ•°æ®è®°å½•ï¼Œä»¥å®Œå…¨è§£å†³å†…å­˜ç¢ç‰‡é—®é¢˜<br><img src="https://gitee.com/AWallFlower/picture/raw/master/img/20241202224158.png"><br>é¦–å…ˆä»æ“ä½œç³»ç»Ÿç”³è¯·ä¸€å¤§å—å†…å­˜ï¼Œå¹¶å°†å…¶åˆ†å‰²æˆå„ç§å°ºå¯¸çš„å—Chunkï¼Œå¹¶æŠŠå°ºå¯¸ç›¸åŒçš„å—åˆ†æˆç»„Slab Class<br>å½“Memcachedæ¥æ”¶åˆ°å®¢æˆ·ç«¯å‘é€è¿‡æ¥çš„æ•°æ®æ—¶é¦–å…ˆä¼šæ ¹æ®æ”¶åˆ°æ•°æ®çš„å¤§å°é€‰æ‹©ä¸€ä¸ªæœ€åˆé€‚çš„Slab Classï¼Œç„¶åé€šè¿‡æŸ¥è¯¢Memcachedä¿å­˜ç€çš„è¯¥Slab Classå†…ç©ºé—²Chunkçš„åˆ—è¡¨å°±å¯ä»¥æ‰¾åˆ°ä¸€ä¸ªå¯ç”¨äºå­˜å‚¨æ•°æ®çš„Chunkã€‚å½“ä¸€æ¡æ•°æ®åº“è¿‡æœŸæˆ–è€…ä¸¢å¼ƒæ—¶ï¼Œè¯¥è®°å½•æ‰€å ç”¨çš„Chunkå°±å¯ä»¥å›æ”¶ï¼Œé‡æ–°æ·»åŠ åˆ°ç©ºé—²åˆ—è¡¨ä¸­<br>Memcachedçš„å†…å­˜ç®¡ç†åˆ¶æ•ˆç‡é«˜ï¼Œè€Œä¸”ä¸ä¼šé€ æˆå†…å­˜ç¢ç‰‡ï¼Œä½†æ˜¯å®ƒæœ€å¤§çš„ç¼ºç‚¹å°±æ˜¯ä¼šå¯¼è‡´ç©ºé—´æµªè´¹ã€‚æ¯”å¦‚å°†100ä¸ªå­—èŠ‚çš„æ•°æ®ç¼“å­˜åˆ°128ä¸ªå­—èŠ‚çš„Chunkä¸­ï¼Œå‰©ä½™çš„28ä¸ªå­—èŠ‚å°±æµªè´¹æ‰äº†</p><h2 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h2><p>Redisä¸ºäº†æ–¹ä¾¿å†…å­˜çš„ç®¡ç†ï¼Œåœ¨åˆ†é…ä¸€å—å†…å­˜ä¹‹åï¼Œä¼šå°†è¿™å—å†…å­˜çš„å¤§å°å­˜å…¥å†…å­˜å—çš„å¤´éƒ¨<br>åœ¨Redisä¸­ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„æ•°æ®éƒ½ä¸€ç›´å­˜å‚¨åœ¨å†…å­˜ä¸­çš„ã€‚è¿™æ˜¯å’ŒMemcachedç›¸æ¯”ä¸€ä¸ªæœ€å¤§çš„åŒºåˆ«<br>å½“ç‰©ç†å†…å­˜ç”¨å®Œæ—¶ï¼ŒRediså¯ä»¥å°†ä¸€äº›å¾ˆä¹…æ²¡ç”¨åˆ°çš„valueäº¤æ¢åˆ°ç£ç›˜ï¼ŒRedis åªä¼šç¼“å­˜æ‰€æœ‰ key çš„ä¿¡æ¯<br>å¦‚æœ Redis å‘ç°å†…å­˜çš„ä½¿ç”¨é‡è¶…è¿‡äº†æŸä¸€ä¸ªé˜ˆå€¼ï¼Œå°†ä¼šè§¦å‘ swap æ“ä½œï¼Œå°†æŸäº› key å¯¹åº”çš„ value æŒä¹…åŒ–åˆ°ç£ç›˜ä¸­ï¼ŒåŒæ—¶åœ¨å†…å­˜ä¸­æ¸…é™¤ã€‚</p>]]></content>
    
    
    
    <tags>
      
      <tag>Redis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Redis èƒ½å­˜å¤šå°‘ä¸ª Key</title>
    <link href="/2024/09/07/Redis%20%E8%83%BD%E5%AD%98%E5%A4%9A%E5%B0%91%E4%B8%AA%20Key/"/>
    <url>/2024/09/07/Redis%20%E8%83%BD%E5%AD%98%E5%A4%9A%E5%B0%91%E4%B8%AA%20Key/</url>
    
    <content type="html"><![CDATA[<h2 id="æ•°æ®ç»“æ„"><a href="#æ•°æ®ç»“æ„" class="headerlink" title="æ•°æ®ç»“æ„"></a>æ•°æ®ç»“æ„</h2><p>Redis çš„é”®å€¼å¯¹å­˜åœ¨å“ªé‡Œï¼Ÿ å“ˆå¸Œè¡¨</p><p>dictEntry å­˜å‚¨çš„æ˜¯å®é™…é”®å€¼å¯¹ï¼Œå®šä¹‰å¦‚ä¸‹</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">dictEntry</span> &#123;<br>    <span class="hljs-type">void</span> *key;<br>    <span class="hljs-keyword">union</span> &#123;<br>        <span class="hljs-type">void</span> *val;<br>        <span class="hljs-type">uint64_t</span> u64;<br>        <span class="hljs-type">int64_t</span> s64;<br>        <span class="hljs-type">double</span> d;<br>    &#125; v;<br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">dictEntry</span> *next;<br>&#125; dictEntry;<br></code></pre></td></tr></table></figure><p>dicthtæ˜¯å“ˆå¸Œè¡¨ï¼Œå®ƒçš„å®šä¹‰å¦‚ä¸‹</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">dictht</span> &#123;<br><br>    <span class="hljs-comment">//dictEntryæ•°ç»„é“¾è¡¨</span><br>    dictEntry **table;<br>    <br>    <span class="hljs-comment">//æ•°ç»„çš„é•¿åº¦</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> size;<br>    <br>    <span class="hljs-comment">//æ•°ç»„æ©ç ï¼Œç­‰äºsize-1</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> sizemask;<br>    <br>    <span class="hljs-comment">//é”®å€¼ä¸ªæ•°</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> used;<br>&#125; dictht;<br></code></pre></td></tr></table></figure><p>Redis çš„ kv é‡Œé¢ä¸æ˜¯ç›´æ¥å­˜å­—ç¬¦ä¸² key æ˜¯ sdsï¼Œvalue æ˜¯ redisObject</p><h2 id="å†²çªå¤„ç†"><a href="#å†²çªå¤„ç†" class="headerlink" title="å†²çªå¤„ç†"></a>å†²çªå¤„ç†</h2><p>å› ä¸ºæ¯ä¸ªæ•°ç»„ä¸‹æ ‡å¯¹åº”ä¸€ä¸ªé“¾è¡¨ï¼Œå¦‚æœä¸€ä¸ªæ–°çš„ key ç®—å‡ºçš„æ•°ç»„ä¸‹æ ‡å·²ç»åŒ…å«äº†å…¶ä»–çš„ dictEntryï¼Œåªéœ€è¦æŠŠæ–°çš„ key å¯¹åº”çš„ dictEntry æŒ‚åœ¨é“¾è¡¨çš„ç¬¬ä¸€ä¸ªä½ç½®å³å¯ï¼ˆå› ä¸ºæ˜¯æ–°æ’å…¥çš„ï¼Œå¯èƒ½é©¬ä¸Šä¼šç”¨åˆ°ï¼‰</p><h2 id="æ‰©ç¼©å®¹"><a href="#æ‰©ç¼©å®¹" class="headerlink" title="æ‰©ç¼©å®¹"></a>æ‰©ç¼©å®¹</h2><p>å•çº¯ä¾èµ–é“¾è¡¨åšå†²çªå¤„ç†ï¼Œé“¾è¡¨ä¼šè¶Šæ¥è¶Šé•¿ï¼Œè¯»å†™æ•ˆç‡å·®ï¼Œæ‰€ä»¥éœ€è¦å¯¹å“ˆå¸Œè¡¨æ‰©å®¹</p><p>å¯¹äº Redis æ¥è¯´ï¼Œä¸€ä¸ªå“ˆå¸Œç»“æ„å†…ç½®äº†ä¸¤ä¸ªå“ˆå¸Œè¡¨ï¼Œä¸€ä¸ªç”¨äºä½¿ç”¨ï¼Œå¦ä¸€ä¸ªå¹³æ—¶é—²ç½®ï¼Œå¾…æ—¶æœºæˆç†Ÿï¼Œæ‰©å®¹ä¸€å€ï¼Œå°†æ•°æ®è¿ç§»åˆ°å¦ä¸€ä¸ªå“ˆå¸Œè¡¨ä¸­</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">dict</span> &#123;<br>    dictType *type;<br>    <span class="hljs-type">void</span> *privdata;<br>    dictht ht[<span class="hljs-number">2</span>];<br>    <span class="hljs-type">long</span> rehashidx; <span class="hljs-comment">/* rehashing not in progress if rehashidx == -1 */</span><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> iterators; <span class="hljs-comment">/* number of iterators currently running */</span><br>&#125; dict;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­ rehashidx è¡¨ç¤ºå½“å‰ dict æ˜¯å¦æ­£åœ¨åš rehashï¼Œå¦‚æœä¸º -1 è¡¨ç¤ºæ²¡æœ‰ rehashï¼Œå½“ used &gt; 2^n æ—¶å€™ï¼Œéœ€è¦æ‰©å®¹ï¼ˆrehashidx è¡¨ç¤ºht[0] åœ¨ rehash çš„æ—¶å€™æ‰€åœ¨çš„ç´¢å¼•å€¼ï¼‰</p><p>ä¸ºäº†ä¿è¯ Redis å•çº¿ç¨‹çš„é«˜æ•ˆæ€§ï¼Œæ•´ä¸ª rehash æ˜¯æ¸è¿›å¼çš„ï¼Œå…¨éƒ¨è¿ç§»å®Œæˆä¹‹å rehashidx ç½®ä¸º -1 å¯¹äºkeyçš„è·¯ç”±æ¥è¯´ï¼Œå®ƒä¾ç„¶å…ˆä»dict[0]å»æ‰¾ï¼Œå¦‚æœæ‰¾åˆ°äº†ï¼Œå°±é¡ºä¾¿æŠŠå®ƒè¿ç§»åˆ°dict[1]ã€‚å¦‚æœæ²¡æ‰¾åˆ°å°±è¦ä»dict[1]å»æ‰¾</p><h2 id="èƒ½å­˜å¤šå°‘-key"><a href="#èƒ½å­˜å¤šå°‘-key" class="headerlink" title="èƒ½å­˜å¤šå°‘ key?"></a>èƒ½å­˜å¤šå°‘ key?</h2><p>å…ˆè¯´ç»“è®ºï¼šæœ€å¥½åƒä¸‡çº§åˆ«</p><p>size å®šä¹‰äº†æ•°ç»„çš„é•¿åº¦ï¼Œç”±äºå®ƒæ˜¯ <code>unsigned long</code> ï¼ˆ4 ä¸ªå­—èŠ‚ï¼‰æ‰€ä»¥ç†è®ºä¸Šå¯ä»¥å­˜ 2 ^ 32 ä¸ªå…ƒç´ </p><p>å®˜æ–¹å›ç­”è¯´æœ€å¥½æ”¾ 2.5 äº¿ä¸ªé”®å€¼å¯¹</p><p>åŸå› ï¼š</p><ol><li>rehash é—®é¢˜ï¼Œå¯¼è‡´å†…å­˜å¼‚å¸¸å¢é•¿ï¼Œç”±äºè¦ä¸º <code>ht[1]</code> åˆ†é…ç©ºé—´ï¼Œå¤§å°å–å†³äº <code>ht[0]</code> å½“å‰åŒ…å«çš„æ•°é‡</li><li>æ­»é”®é—®é¢˜ï¼ŒRedis å°†æ‰€æœ‰é”®å€¼å¯¹ä¿å­˜åœ¨ dict ä¸­ï¼Œè¿˜æœ‰ä¸€ä¸ª <code>dict *expires</code> ç”¨æ¥ä¿å­˜è¿‡æœŸé”®ï¼Œå¦‚æœé”®å€¼æ•°é‡è¿‡å¤šï¼Œå¹¶è®¾ç½®äº†è¿‡æœŸæ—¶é—´ï¼Œä¼šå¯¼è‡´å†…å­˜å ç”¨</li></ol><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">redisDb</span> &#123;<br>    dict *dict;    <span class="hljs-comment">/* The keyspace for this DB */</span><br>    dict *expires; <span class="hljs-comment">/* Timeout of keys with a timeout set */</span><br>    ......<br>&#125; redisDb;<br></code></pre></td></tr></table></figure><ol start="3"><li>Redisæœ‰æœ€å¤§å†…å­˜æ·˜æ±°æœºåˆ¶(maxmemory-policy)ï¼Œå¦‚æœé”®å€¼ä¸ªæ•°è¿‡å¤šï¼Œé‚£ä¹ˆå¯èƒ½é€å‡ºçš„å°±ä¼šæ›´å¤šï¼Œä¹Ÿå°±æ„å‘³æ®µæ—¶é—´å†…æœ‰å¤§é‡çš„åˆ é™¤æ“ä½œï¼Œç”šè‡³ä¼šé€ æˆRedisæ®µæ—¶é—´ä¸å¯ç”¨</li></ol>]]></content>
    
    
    
    <tags>
      
      <tag>Redis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MyBatis ç¼“å­˜è®¾è®¡æ€æƒ³</title>
    <link href="/2024/08/30/MyBatis%20%E7%BC%93%E5%AD%98%E8%AE%BE%E8%AE%A1%E6%80%9D%E6%83%B3/"/>
    <url>/2024/08/30/MyBatis%20%E7%BC%93%E5%AD%98%E8%AE%BE%E8%AE%A1%E6%80%9D%E6%83%B3/</url>
    
    <content type="html"><![CDATA[<p>ç¼“å­˜æœ¬è´¨å…¶å®å°±æ˜¯ä¸€ä¸ª Mapï¼ŒMyBatis çš„ç¼“å­˜æœ€åŸºæœ¬çš„å®ç°æ˜¯ PerpetualCacheï¼Œå†…éƒ¨ä½¿ç”¨äº† HashMap æ¥ä¿å­˜æ•°æ®</p><p>ç¼“å­˜ä¸€èˆ¬è¿˜æœ‰é¢å¤–çš„åŠŸèƒ½æ¯”å¦‚æ·˜æ±°ç­–ç•¥ï¼Œæœ€å¤§æ—¶é•¿ç­‰ï¼Œå¦‚ä½•æ‰©å±•è¿™äº›åŠŸèƒ½ï¼Ÿ</p><p>æ‰©å±•ç±»çš„åŠŸèƒ½æœ‰ 2 ç§ï¼Œç»§æ‰¿å’Œç»„åˆï¼Œä½†æ˜¯ MyBatis æä¾›äº†å¾ˆå¤šåŠŸèƒ½å¹¶ä¸”æœ‰çš„æ˜¯åŠ¨æ€ç»„åˆçš„ï¼Œæ¯”å¦‚å®¹é‡ä¸Šé™ 512ï¼Œæ·˜æ±°ç­–ç•¥ LRUâ€¦ å¦‚æœæ˜¯é›†æˆçš„è¯ï¼Œé‚£è¦æŠŠæ‰€æœ‰æ’åˆ—ç»„åˆéƒ½å®ç°ä¸€éï¼Œä¼šå¯¼è‡´ç±»çˆ†ç‚¸</p><p>MyBatis é‡‡ç”¨äº†<strong>è£…é¥°å™¨æ¨¡å¼</strong>ï¼Œé‡‡ç”¨<strong>ç»„åˆ</strong>çš„æ–¹å¼æ‰©å±•æ–°åŠŸèƒ½</p><blockquote><p>è£…é¥°å™¨æ¨¡å¼ä½¿ç”¨çš„æ˜¯ç»„åˆæ–¹å¼ï¼Œç›¸è¾ƒäºç»§æ‰¿è¿™ç§é™æ€çš„æ‰©å±•æ–¹å¼ï¼Œè£…é¥°å™¨æ¨¡å¼å¯ä»¥åœ¨è¿è¡Œæ—¶æ ¹æ®ç³»ç»ŸçŠ¶æ€ï¼ŒåŠ¨æ€å†³å®šä¸ºä¸€ä¸ªå®ç°ç±»æ·»åŠ å“ªäº›æ‰©å±•åŠŸèƒ½</p></blockquote><p><img src="https://gitee.com/AWallFlower/picture/raw/master/img/20241110110554.png"></p><ul><li>Component æ¥å£ï¼šå·²æœ‰çš„ä¸šåŠ¡æ¥å£ï¼Œæ˜¯<strong>æ•´ä¸ªåŠŸèƒ½çš„æ ¸å¿ƒæŠ½è±¡</strong>ï¼Œå®šä¹‰äº† Decorator å’Œ ComponentImpl è¿™äº›å®ç°ç±»çš„æ ¸å¿ƒè¡Œä¸º<ul><li>JDK ä¸­çš„ IO æµä½“ç³»å°±ä½¿ç”¨äº†è£…é¥°å™¨æ¨¡å¼ï¼Œå…¶ä¸­çš„ InputStream æ¥å£å°±æ‰®æ¼”äº† Component æ¥å£çš„è§’è‰²</li></ul></li><li>ComponentImpl å®ç°ç±»ï¼šå®ç°äº†ä¸Šé¢ä»‹ç»çš„ Component æ¥å£ï¼Œå…¶ä¸­<strong>å®ç°äº† Component æ¥å£æœ€åŸºç¡€ã€æœ€æ ¸å¿ƒçš„åŠŸèƒ½</strong>ï¼Œä¹Ÿå°±æ˜¯è¢«è£…é¥°çš„ã€åŸå§‹çš„åŸºç¡€ç±»<ul><li>JDK IO æµä½“ç³»ä¹‹ä¸­çš„ FileInputStream å°±æ‰®æ¼”äº† ComponentImpl çš„è§’è‰²ï¼Œå®ƒå®ç°äº†è¯»å–æ–‡ä»¶çš„åŸºæœ¬èƒ½åŠ›ï¼Œä¾‹å¦‚ï¼Œè¯»å–å•ä¸ª byteã€è¯»å– byte[] æ•°ç»„</li></ul></li><li>Decorator æŠ½è±¡ç±»ï¼šæ‰€æœ‰è£…é¥°å™¨çš„çˆ¶ç±»ï¼Œå®ç°äº† Component æ¥å£ï¼Œ<strong>å…¶æ ¸å¿ƒä¸æ˜¯æä¾›æ–°çš„æ‰©å±•èƒ½åŠ›ï¼Œè€Œæ˜¯å°è£…ä¸€ä¸ª Component ç±»å‹çš„å­—æ®µï¼Œä¹Ÿå°±æ˜¯è¢«è£…é¥°çš„ç›®æ ‡å¯¹è±¡</strong><ul><li>è¿™é‡Œçš„è¢«è£…é¥°å¯¹è±¡å¯ä»¥æ˜¯ComponentImpl å¯¹è±¡ï¼Œä¹Ÿå¯ä»¥æ˜¯ Decorator å®ç°ç±»çš„å¯¹è±¡</li><li>ä¸‹é¢DecoratorImpl1 è£…é¥°äº† DecoratorImpl2ï¼ŒDecoratorImpl2 è£…é¥°äº† ComponentImplï¼Œç»è¿‡äº†è¿™ä¸€ç³»åˆ—è£…é¥°ä¹‹åå¾—åˆ°çš„ Component å¯¹è±¡ï¼Œé™¤äº†å…·æœ‰ ComponentImpl çš„åŸºç¡€èƒ½åŠ›ä¹‹å¤–ï¼Œè¿˜æ‹¥æœ‰äº† DecoratorImpl1 å’Œ DecoratorImpl2 çš„æ‰©å±•èƒ½åŠ›</li></ul></li></ul><p><img src="https://gitee.com/AWallFlower/picture/raw/master/img/20241110111022.png"></p><p>MyBatis ä¸­<strong>é™¤äº† PerpetualCache ä¹‹å¤–çš„å…¶ä»–æ‰€æœ‰ Cache æ¥å£å®ç°ç±»ï¼Œéƒ½æ˜¯è£…é¥°å™¨å®ç°</strong></p><blockquote><p>Spring ä¸­çš„ IoCå®¹å™¨ï¼Œå®ƒæœ‰å„ç§å„æ ·çš„å®ç°ç±»ï¼Œå®Œå…¨å°±æ˜¯é€šè¿‡ç»§æ‰¿è¿›è¡ŒåŠŸèƒ½çš„æ‰©å±•ï¼Œä¸ MyBatis çš„å®ç°æ€è·¯æˆªç„¶ä¸åŒï¼Œä¸ºä»€ä¹ˆ?</p></blockquote><p><img src="https://gitee.com/AWallFlower/picture/raw/master/img/20241110112245.png"></p><p><img src="https://gitee.com/AWallFlower/picture/raw/master/img/20241110112525.png"></p><p>å¯¹æ¯”MyBatis çš„ Cache ç»§æ‰¿ä½“ç³»å›¾å’Œ BeanFactory çš„ç»§æ‰¿ä½“ç³»å›¾è£…é¥°å™¨æ¨¡å¼å¯ä»¥åŠ¨æ€ã€çµæ´»çš„æ‰©å±•æ–°çš„åŠŸèƒ½ï¼Œä½†æ˜¯å®ƒæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯å®¢æˆ·ç«¯çš„å¯æ§ç¨‹åº¦æ¯”è¾ƒä½ã€‚</p><p>æ— è®ºç¼“å­˜æ‰©å±•äº†å“ªäº›åŠŸèƒ½ï¼Œå¯¹äºå®¢æˆ·ç«¯æ¥è¯´ï¼Œæš´éœ²çš„éƒ½åªæ˜¯ä¸€ä¸ª Cache æ¥å£ï¼Œå®¢æˆ·ç«¯å¹¶ä¸çŸ¥é“æ­¤æ—¶ç¼“å­˜å·²ç»å…·æœ‰äº†å“ªäº›èƒ½åŠ›ï¼Œç”šè‡³å¦‚æœå®¢æˆ·ç«¯å¯¹å†…éƒ¨å®ç°ä¸äº†è§£ï¼Œè‡ªå·±æ‰©å±•äº†ä¸¤ä¸ªäº’æ–¥çš„åŒ…è£…å™¨ï¼Œè¿˜ä¼šå¼•èµ·ç³»ç»Ÿå¼‚å¸¸çš„é£é™©ã€‚ </p><p>å¯¹äº MyBatis æ¥è¯´ï¼Œå®ƒå†…ç½®çš„ç¼“å­˜åŠŸèƒ½åœ¨ç»å¤§éƒ¨åˆ†åœºæ™¯ä¸‹éƒ½æ˜¯ä¸éœ€è¦å®¢æˆ·åº¦è‡ªè¡Œå¼€å‘å’Œæ‰©å±•çš„ï¼Œå®¢æˆ·ç«¯åªéœ€è¦æŒ‡å®šæˆ‘éœ€è¦ç¼“å­˜çš„å“ªäº›åŠŸèƒ½å°±å¥½ã€‚åœ¨è¿™ä¸ªå‰æï¼ŒMyBatis å¯ä»¥æ”¾å¿ƒåœ°ä½¿ç”¨è£…é¥°å™¨æ¨¡å¼ã€‚ </p><p>è€Œ Spring åˆ™ä¸åŒï¼Œå®ƒæä¾›çš„ BeanFactoryã€ApplicationContext è¿™ä¸€æ•´å¥— IoC å®¹å™¨ï¼Œæ˜¯ç›´æ¥æš´éœ²ç»™å®¢æˆ·ç«¯ä½¿ç”¨çš„ï¼Œæœ‰æ—¶è¿˜ä¼šåŸºäºå·²æœ‰çš„å®¹å™¨è¿›è¡ŒäºŒæ¬¡å¼€å‘ã€‚è¿™æ ·å°±éœ€è¦å®¢æˆ·ç«¯æœ‰è¾ƒå¼ºçš„æŠŠæ§èƒ½åŠ›ï¼Œéœ€è¦æ˜ç¡®çš„çŸ¥é“æˆ‘å½“å‰ä½¿ç”¨çš„æ˜¯å“ªç§ BeanFactoryï¼Œå®ƒå…·æœ‰å“ªäº›èƒ½åŠ›ã€‚</p><p>å¦‚æœåƒ MyBatis ä¸€æ ·ï¼Œåªå¯¹å¤–æš´éœ²ä¸€ä¸ª BeanFactory æ¥å£ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯è¿›è¡ŒäºŒæ¬¡å¼€å‘å°±ååˆ†ä¸å‹å¥½äº†ã€‚ </p><p>æ€»ç»“èµ·æ¥ï¼Œé€ æˆ MyBatis å’Œ Spring è¿™ç§æ‰©å±•æ€è·¯çš„å·®å¼‚çš„æœ€é‡è¦åŸå› ä¹‹ä¸€ï¼Œå°±æ˜¯ MyBatis çš„ Cache æ¨¡å—éœ€è¦é™ä½ç”¨æˆ·å­¦ä¹ æˆæœ¬ï¼Œç›´æ¥æŒ‡å®šéœ€è¦å¢åŠ çš„åŠŸèƒ½å³å¯ï¼›è€Œ Spring çš„ IoC å®¹å™¨åˆ™æ˜¯ä¸ºå®¢æˆ·ç«¯çš„ä½¿ç”¨å’ŒäºŒæ¬¡å¼€å‘æä¾›äº†æ›´å¤§çš„ç©ºé—´ã€‚</p>]]></content>
    
    
    
    <tags>
      
      <tag>MyBatis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MyBatis æ—¥å¿—è®¾è®¡æ€æƒ³</title>
    <link href="/2024/08/23/MyBatis%20%E6%97%A5%E5%BF%97%E8%AE%BE%E8%AE%A1%E6%80%9D%E6%83%B3/"/>
    <url>/2024/08/23/MyBatis%20%E6%97%A5%E5%BF%97%E8%AE%BE%E8%AE%A1%E6%80%9D%E6%83%B3/</url>
    
    <content type="html"><![CDATA[<p>æ•´ä½“æ¶æ„ç”¨äº†é—¨é¢æ¨¡å¼ï¼Œå¯¹å¤–æš´éœ² SqlSession æ¥å£</p><p><img src="https://gitee.com/AWallFlower/picture/raw/master/img/20241110104348.png"></p><p>æ—¥å¿—æ¨¡å—ï¼Œé‡‡ç”¨äº†é€‚é…å™¨æ¨¡å¼</p><blockquote><p>å¦‚æœéœ€è¦æ¥å…¥å¤šä¸ªç¬¬ä¸‰æ–¹ SDK æ¥æ»¡è¶³è‡ªå·±çš„ä¸šåŠ¡éœ€æ±‚ï¼Œä½†æ˜¯ SDK çš„æ¥å£å®šä¹‰ä¸ä½ çš„ä¸šåŠ¡ä¸å…¼å®¹ï¼Œåˆä¸èƒ½ä¿®æ”¹ç¬¬ä¸‰æ–¹ SDK çš„ä»£ç ï¼Œå¯ä»¥ç”¨é€‚é…å™¨è®¾è®¡æ¨¡å¼è§£å†³</p></blockquote><p>MyBatis å®šä¹‰äº†è‡ªå·± Log æ¥å£ï¼Œä¸ºå¤§éƒ¨åˆ†ä¸»æµæ—¥å¿—æ¡†æ¶éƒ½å®ç°äº† Adapter é€‚é…å™¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Log</span> &#123;<br><br>  <span class="hljs-type">boolean</span> <span class="hljs-title function_">isDebugEnabled</span><span class="hljs-params">()</span>;<br><br>  <span class="hljs-type">boolean</span> <span class="hljs-title function_">isTraceEnabled</span><span class="hljs-params">()</span>;<br><br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">error</span><span class="hljs-params">(String s, Throwable e)</span>;<br><br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">error</span><span class="hljs-params">(String s)</span>;<br><br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">debug</span><span class="hljs-params">(String s)</span>;<br><br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">trace</span><span class="hljs-params">(String s)</span>;<br><br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">warn</span><span class="hljs-params">(String s)</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>å®šä¹‰äº†å››ç§ Log çº§åˆ«ï¼Œä»¥ Slf4j å®ç°ä¸ºä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Slf4jImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Log</span> &#123;<br><br>  <span class="hljs-keyword">private</span> Log log;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">Slf4jImpl</span><span class="hljs-params">(String clazz)</span> &#123;<br>    <span class="hljs-type">Logger</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(clazz);<br><br>    <span class="hljs-keyword">if</span> (logger <span class="hljs-keyword">instanceof</span> LocationAwareLogger) &#123;<br>      <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// check for slf4j &gt;= 1.6 method signature</span><br>        logger.getClass().getMethod(<span class="hljs-string">&quot;log&quot;</span>, Marker.class, String.class, <span class="hljs-type">int</span>.class, String.class, Object[].class,<br>            Throwable.class);<br>        log = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Slf4jLocationAwareLoggerImpl</span>((LocationAwareLogger) logger);<br>        <span class="hljs-keyword">return</span>;<br>      &#125; <span class="hljs-keyword">catch</span> (SecurityException | NoSuchMethodException e) &#123;<br>        <span class="hljs-comment">// fail-back to Slf4jLoggerImpl</span><br>      &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// Logger is not LocationAwareLogger or slf4j version &lt; 1.6</span><br>    log = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Slf4jLoggerImpl</span>(logger);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isDebugEnabled</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> log.isDebugEnabled();<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isTraceEnabled</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> log.isTraceEnabled();<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">error</span><span class="hljs-params">(String s, Throwable e)</span> &#123;<br>    log.error(s, e);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">error</span><span class="hljs-params">(String s)</span> &#123;<br>    log.error(s);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">debug</span><span class="hljs-params">(String s)</span> &#123;<br>    log.debug(s);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">trace</span><span class="hljs-params">(String s)</span> &#123;<br>    log.trace(s);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">warn</span><span class="hljs-params">(String s)</span> &#123;<br>    log.warn(s);<br>  &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>åŒæ—¶å®šä¹‰äº†ä¸€ä¸ª LogFactory ç±»ï¼Œæ—¥å¿—çš„å®ä¾‹æ˜¯ä»è¿™é‡Œè·å–çš„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LogFactory</span> &#123;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Marker to be used by logging implementations that support markers.</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">MARKER</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;MYBATIS&quot;</span>;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Constructor&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Log</span>&gt; logConstructor;<br><br>  <span class="hljs-keyword">static</span> &#123;<br>    tryImplementation(LogFactory::useSlf4jLogging);<br>    tryImplementation(LogFactory::useCommonsLogging);<br>    tryImplementation(LogFactory::useLog4J2Logging);<br>    tryImplementation(LogFactory::useLog4JLogging);<br>    tryImplementation(LogFactory::useJdkLogging);<br>    tryImplementation(LogFactory::useNoLogging);<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">LogFactory</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// disable construction</span><br>  &#125;<br>  <span class="hljs-comment">//...</span><br>&#125;<br></code></pre></td></tr></table></figure><p>é€šè¿‡é™æ€ä»£ç å—å®šä¹‰äº†ç±»åŠ è½½çš„é¡ºåºï¼Œslf4j -&gt; commons-logging -&gt; log4j2 -&gt; log4j -&gt; jdk-logging -&gt; no-logging</p><p>å¦‚æœé¡¹ç›®ä¸­æœ‰å¯¹åº”çš„ä¾èµ–ï¼Œåˆ™é€šè¿‡åå°„åŠ è½½å¯¹åº”çš„æ—¥å¿—æ¥å£</p><p>By the wayï¼ŒMyBatis é€šè¿‡JDK åŠ¨æ€ä»£ç†è®°å½•æ•°æ®åº“è¿æ¥ï¼Œé¢„ç¼–è¯‘è¯­å¥ï¼Œå’Œç»“æœè®°å½•ï¼Œåˆ†åˆ«æ˜¯ ConnectionLoggerã€PreparedStatementLogger å’Œ ResultSetLogger</p>]]></content>
    
    
    
    <tags>
      
      <tag>MyBatis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ThreadPoolExecutor</title>
    <link href="/2024/08/20/ThreadPoolExecutor/"/>
    <url>/2024/08/20/ThreadPoolExecutor/</url>
    
    <content type="html"><![CDATA[<h2 id="ThreadPoolExecutor"><a href="#ThreadPoolExecutor" class="headerlink" title="ThreadPoolExecutor"></a>ThreadPoolExecutor</h2><p>çº¿ç¨‹æ± å¯¹è±¡ï¼Œå¦‚æœé‡Œé¢æ·»åŠ äº†ä»»åŠ¡ï¼Œå¦‚æœä¸æ‰‹åŠ¨è°ƒç”¨ <code>shutdown</code> æ–¹æ³•ï¼Œé‚£ä¹ˆè¿™ä¸ªå¯¹è±¡æ°¸è¿œä¸ä¼šè¢« GC</p><p>é¦–å…ˆçœ‹ä¸€ä¸‹ <code>ThreadPoolExecutor</code> çš„æºç ç»“æ„</p><p><code>ThreadPoolExecutor</code> é‡Œé¢æœ‰ä¸€ä¸ªå†…éƒ¨ç±» <code>Worker</code> è¿™ä¸ªå†…éƒ¨ç±»å®ç°äº† <code>Runnable</code> æ¥å£</p><p>è¿™ä¸ª <code>Worker</code> ç±»é‡Œæœ‰ä¸€ä¸ª <code>runWorker</code> æ–¹æ³•ï¼Œæ˜¯ä¿è¯çº¿ç¨‹ä¸æ–­è¿è¡Œçš„åŸç†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">runWorker</span><span class="hljs-params">(Worker w)</span> &#123;<br>    <span class="hljs-type">Thread</span> <span class="hljs-variable">wt</span> <span class="hljs-operator">=</span> Thread.currentThread();<br>    <span class="hljs-type">Runnable</span> <span class="hljs-variable">task</span> <span class="hljs-operator">=</span> w.firstTask;<br>    w.firstTask = <span class="hljs-literal">null</span>;<br>    w.unlock(); <span class="hljs-comment">// allow interrupts</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">completedAbruptly</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">while</span> (task != <span class="hljs-literal">null</span> || (task = getTask()) != <span class="hljs-literal">null</span>) &#123;<br>            w.lock();<br>            <span class="hljs-comment">// If pool is stopping, ensure thread is interrupted;</span><br>            <span class="hljs-comment">// if not, ensure thread is not interrupted.  This</span><br>            <span class="hljs-comment">// requires a recheck in second case to deal with</span><br>            <span class="hljs-comment">// shutdownNow race while clearing interrupt</span><br>            <span class="hljs-keyword">if</span> ((runStateAtLeast(ctl.get(), STOP) ||<br>                 (Thread.interrupted() &amp;&amp;<br>                  runStateAtLeast(ctl.get(), STOP))) &amp;&amp;<br>                !wt.isInterrupted())<br>                wt.interrupt();<br>            <span class="hljs-keyword">try</span> &#123;<br>                beforeExecute(wt, task);<br>                <span class="hljs-type">Throwable</span> <span class="hljs-variable">thrown</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    task.run();<br>                &#125; <span class="hljs-keyword">catch</span> (RuntimeException x) &#123;<br>                    thrown = x; <span class="hljs-keyword">throw</span> x;<br>                &#125; <span class="hljs-keyword">catch</span> (Error x) &#123;<br>                    thrown = x; <span class="hljs-keyword">throw</span> x;<br>                &#125; <span class="hljs-keyword">catch</span> (Throwable x) &#123;<br>                    thrown = x; <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(x);<br>                &#125; <span class="hljs-keyword">finally</span> &#123;<br>                    afterExecute(task, thrown);<br>                &#125;<br>            &#125; <span class="hljs-keyword">finally</span> &#123;<br>                task = <span class="hljs-literal">null</span>;<br>                w.completedTasks++;<br>                w.unlock();<br>            &#125;<br>        &#125;<br>        completedAbruptly = <span class="hljs-literal">false</span>;<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>        processWorkerExit(w, completedAbruptly);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p> æœ€å¤–å±‚çš„ while å¾ªç¯ä¸æ–­è°ƒç”¨ <code>getTask()</code> æ–¹æ³•ä»é˜Ÿåˆ—ä¸­å–ä»»åŠ¡ï¼Œå¦‚æœå–ä¸åˆ°ï¼Œå°±å±äºå¼‚å¸¸æƒ…å†µï¼ŒæŠŠ <code>completedAbruptly</code> è®¾ç½®ä¸º falseï¼Œè¿›å…¥ <code>processWorkerExit</code> æ–¹æ³•</p>]]></content>
    
    
    
    <tags>
      
      <tag>æºç </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ä¸€è‡´æ€§å“ˆå¸Œ</title>
    <link href="/2024/08/16/%E4%B8%80%E8%87%B4%E6%80%A7%E5%93%88%E5%B8%8C/"/>
    <url>/2024/08/16/%E4%B8%80%E8%87%B4%E6%80%A7%E5%93%88%E5%B8%8C/</url>
    
    <content type="html"><![CDATA[<p>ä¸€è‡´æ€§å“ˆå¸Œé—®é¢˜æ˜¯ä¸ºäº†è§£å†³è¯·æ±‚è´Ÿè½½å‡è¡¡çš„</p><h2 id="è´Ÿè½½å‡è¡¡ç®—æ³•"><a href="#è´Ÿè½½å‡è¡¡ç®—æ³•" class="headerlink" title="è´Ÿè½½å‡è¡¡ç®—æ³•"></a>è´Ÿè½½å‡è¡¡ç®—æ³•</h2><p>åœ¨å¤šèŠ‚ç‚¹åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¦‚ä½•æœ‰æ•ˆåˆ†é…å®¢æˆ·ç«¯è¯·æ±‚ä»¥å®ç°è´Ÿè½½å‡è¡¡</p><ol><li><p>è½®è¯¢ç®—æ³•</p></li><li><p>åŠ æƒè½®è¯¢ç®—æ³•</p></li><li><p>å“ˆå¸Œç®—æ³•</p><ul><li>ä¸Šé¢ä¸¤ä¸­å¯¹äºæ•°æ®åˆ†ç‰‡å°±ä¸é€‚ç”¨äº†ï¼Œæ¯”å¦‚ç¼“å­˜çš„ key åˆ†å¸ƒåœ¨ä¸åŒçš„èŠ‚ç‚¹ä¸Šï¼Œé€šè¿‡å“ˆå¸Œå‡½æ•°å’Œå–æ¨¡è¿ç®—å¯ä»¥å°†è¯·æ±‚æ˜ å°„åˆ°ç‰¹å®šèŠ‚ç‚¹</li></ul></li><li><p>ä¸€è‡´æ€§å“ˆå¸Œ</p></li></ol><h2 id="ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•"><a href="#ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•" class="headerlink" title="ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•"></a>ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•</h2><p>æ™®é€šå“ˆå¸Œç®—æ³•å­˜åœ¨é—®é¢˜ï¼Œå½“èŠ‚ç‚¹æ•°å¢åŠ çš„æ—¶å€™ï¼Œéœ€è¦é‡æ–°è®¡ç®—æ˜ å°„å…³ç³»ï¼Œä¹Ÿè¦è¿ç§»æ•°æ®</p><p>æ¯”å¦‚ä¸€å¼€å§‹æœ‰ 3 å°æœºå™¨ï¼Œæ¨¡ 3ï¼Œä¹‹åå˜æˆ 4 å°ï¼Œéœ€è¦åšæ•°æ®è¿ç§»å¹¶ä¸”é‡æ–°è®¡ç®—æ˜ å°„å…³ç³»</p><p>ä¸€è‡´æ€§å“ˆå¸Œä¹Ÿæ˜¯ç”¨äº†å–æ¨¡ï¼Œä½†æ˜¯ä¸æ™®é€šå“ˆå¸Œä¸ä¸€æ ·ï¼Œæ™®é€šå“ˆå¸Œå¯¹èŠ‚ç‚¹æ•°è¿›è¡Œå–æ¨¡ï¼Œä¸€è‡´æ€§å“ˆå¸Œæ˜¯å¯¹ <code>2^32</code> è¿›è¡Œå–æ¨¡</p><p>ä¸€è‡´æ€§å“ˆå¸Œæ˜¯å°†ã€å­˜å‚¨èŠ‚ç‚¹ã€‘å’Œã€æ•°æ®ã€‘éƒ½æ˜ å°„åˆ°ä¸€ä¸ªé¦–å°¾ç›¸è¿çš„å“ˆå¸Œç¯ä¸Šï¼Œå¦‚æœå¢åŠ æˆ–ç§»é™¤ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä»…<strong>å½±å“è¯¥èŠ‚ç‚¹åœ¨å“ˆå¸Œç¯ä¸Šé¡ºæ—¶é’ˆç›¸é‚»çš„åç»§ç»“ç‚¹</strong>ï¼ˆå› ä¸ºä»–çš„å¯»å€è§„åˆ™æ˜¯æŠŠæ•°æ®å“ˆå¸Œä¹‹åé¡ºæ—¶é’ˆæ‰¾åˆ°ç¬¬ä¸€ä¸ªå­˜å‚¨èŠ‚ç‚¹ï¼‰ï¼Œå…¶ä»–æ•°æ®ä¸ä¼šæ”¶åˆ°å½±å“</p><img src="https://gitee.com/AWallFlower/picture/raw/master/img/20240906215850.png"  style="zoom: 50%;" /><p>ä½†æ˜¯<strong>ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•ä¸èƒ½å‡åŒ€åˆ†å¸ƒèŠ‚ç‚¹</strong>ï¼Œä¼šå‡ºç°å¤§é‡è¯·æ±‚éƒ½é›†ä¸­åœ¨ä¸€ä¸ªèŠ‚ç‚¹çš„æƒ…å†µï¼Œè¿™ç§æƒ…å†µä¸‹è¿›è¡Œå®¹ç¾æˆ–å¤‡ä»½çš„æ—¶å€™ï¼Œå®¹æ˜“å‡ºç°é›ªå´©</p><img src="https://gitee.com/AWallFlower/picture/raw/master/img/20240819101745.png"  style="zoom: 30%;" /><p>ä¸ºäº†è§£å†³ä¸€è‡´æ€§å“ˆå¸Œä¸èƒ½å‡åŒ€åˆ†å¸ƒèŠ‚ç‚¹çš„é—®é¢˜ï¼Œéœ€è¦å¼•å…¥è™šæ‹ŸèŠ‚ç‚¹ï¼Œå¯¹ä¸€ä¸ªçœŸå®èŠ‚ç‚¹åšå¤šä¸ªå‰¯æœ¬ï¼Œå†å°†è™šæ‹ŸèŠ‚ç‚¹æ˜ å°„åˆ°å®é™…èŠ‚ç‚¹ï¼Œæœ‰ä¸¤å±‚æ˜ å°„å…³ç³»</p><img src="https://gitee.com/AWallFlower/picture/raw/master/img/20240819101754.png"  style="zoom: 30%;" />]]></content>
    
    
    
    <tags>
      
      <tag>åˆ†å¸ƒå¼</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CountDownLatch</title>
    <link href="/2024/08/10/CountDownLatch/"/>
    <url>/2024/08/10/CountDownLatch/</url>
    
    <content type="html"><![CDATA[<p><code>CountDownLatch</code> ç±»å­˜åœ¨ä¸€ä¸ªå†…éƒ¨ç±» <code>Sync</code> ç»§æ‰¿è‡ª <code>AbstractQueueSynchronizer</code> </p><p>æ‰€ä»¥ <code>CountDownLatch</code> ä¹Ÿæ˜¯åŸºäº AQS å®ç°çš„ï¼Œå…¶ä¸­ state è¡¨ç¤ºå‰é¢æœ‰å‡ ä¸ªçº¿ç¨‹éœ€è¦ç­‰å¾…</p><h2 id="æ ¸å¿ƒå‡½æ•°"><a href="#æ ¸å¿ƒå‡½æ•°" class="headerlink" title="æ ¸å¿ƒå‡½æ•°"></a>æ ¸å¿ƒå‡½æ•°</h2><h3 id="å†…éƒ¨ç±»ç»“æ„"><a href="#å†…éƒ¨ç±»ç»“æ„" class="headerlink" title="å†…éƒ¨ç±»ç»“æ„"></a>å†…éƒ¨ç±»ç»“æ„</h3><p>ç±»ä¸­åªæœ‰ä¸€ä¸ªæˆå‘˜å˜é‡ <code>Sync</code> è¿™ä¸ªç±»ç»§æ‰¿äº† <code>AbstractQueueSynchronizer</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CountDownLatch</span> &#123;<br>    <span class="hljs-comment">// åŒæ­¥é˜Ÿåˆ—</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Sync sync;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="ç±»çš„æ„é€ å‡½æ•°"><a href="#ç±»çš„æ„é€ å‡½æ•°" class="headerlink" title="ç±»çš„æ„é€ å‡½æ•°"></a>ç±»çš„æ„é€ å‡½æ•°</h3><p>è°ƒç”¨äº† <code>Sync</code> çš„æ„é€ æ–¹æ³•, <code>Sync</code> åˆè°ƒç”¨äº†çˆ¶ç±» AQS çš„æ–¹æ³•, è®¾ç½®äº† state å€¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">CountDownLatch</span><span class="hljs-params">(<span class="hljs-type">int</span> count)</span> &#123;<br><span class="hljs-keyword">if</span> (count &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;count &lt; 0&quot;</span>);<br><span class="hljs-built_in">this</span>.sync = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Sync</span>(count);<br>&#125;<br><span class="hljs-comment">// å…¶ä¸­ Sync çš„æ„é€ å‡½æ•°è°ƒç”¨äº†çˆ¶ç±» AQS çš„æ–¹æ³•, è®¾ç½®äº† AQS ä¸­çš„ state å€¼</span><br>Sync(<span class="hljs-type">int</span> count) &#123;<br>setState(count);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="await-å‡½æ•°"><a href="#await-å‡½æ•°" class="headerlink" title="await å‡½æ•°"></a>await å‡½æ•°</h3><p>æ­¤å‡½æ•°å°†ä¼šä½¿å½“å‰çº¿ç¨‹åœ¨é”å­˜å™¨å€’è®¡æ•°è‡³ 0 ä¹‹å‰ä¸€ç›´ç­‰å¾…, é™¤éçº¿ç¨‹è¢«ä¸­æ–­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">await</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>sync.acquireSharedInterruptibly(<span class="hljs-number">1</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="countDown-å‡½æ•°"><a href="#countDown-å‡½æ•°" class="headerlink" title="countDown å‡½æ•°"></a>countDown å‡½æ•°</h3><p>æ­¤å‡½æ•°å°†é€’å‡é”å­˜å™¨çš„è®¡æ•°, å¦‚æœè®¡æ•°è¾¾åˆ° 0, åˆ™é‡Šæ”¾æ‰€æœ‰ç­‰å¾…çº¿ç¨‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">countDown</span><span class="hljs-params">()</span> &#123;<br>    sync.releaseShared(<span class="hljs-number">1</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="ä½¿ç”¨æ¡ˆä¾‹"><a href="#ä½¿ç”¨æ¡ˆä¾‹" class="headerlink" title="ä½¿ç”¨æ¡ˆä¾‹"></a>ä½¿ç”¨æ¡ˆä¾‹</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>    <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executorService</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">10</span>);<br>    <span class="hljs-type">CountDownLatch</span> <span class="hljs-variable">countDownLatch</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CountDownLatch</span>(<span class="hljs-number">10</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>        executorService.execute(() -&gt; &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot; is running...&quot;</span>);<br>                <span class="hljs-comment">// æ¯ä¸ªçº¿ç¨‹ç¡ 1s</span><br>                Thread.sleep(<span class="hljs-number">1000</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                <span class="hljs-comment">// ignore</span><br>            &#125; <span class="hljs-keyword">finally</span> &#123;<br>                <span class="hljs-comment">// ä¼‘çœ å®Œä¹‹å countDownLatch - 1</span><br>                countDownLatch.countDown();<br>            &#125;<br>        &#125;);<br>    &#125;<br>    <span class="hljs-comment">// åªæœ‰ countDownLatch å‡åˆ° 0 çš„æ—¶å€™æ‰ä¼šåœæ­¢é˜»å¡</span><br>    countDownLatch.await();<br>    executorService.shutdown();<br>    System.out.println(<span class="hljs-string">&quot;end...&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>è®°å¾—æœ€åè¦è°ƒç”¨ <code>shutdown()</code> å¦åˆ™çº¿ç¨‹æ°¸è¿œä¸ä¼šç»“æŸ</p><p>å› ä¸ºçº¿ç¨‹æ± çš„çº¿ç¨‹å¤„äº waiting çŠ¶æ€ï¼Œä»–ä»¬ä½œä¸º GC Root ä¸ä¼šè¢«å›æ”¶</p>]]></content>
    
    
    
    <tags>
      
      <tag>JUC</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Redisson å»¶è¿Ÿé˜Ÿåˆ—</title>
    <link href="/2024/07/30/Redisson%20%E5%BB%B6%E8%BF%9F%E9%98%9F%E5%88%97/"/>
    <url>/2024/07/30/Redisson%20%E5%BB%B6%E8%BF%9F%E9%98%9F%E5%88%97/</url>
    
    <content type="html"><![CDATA[<h2 id="Redisson-å»¶è¿Ÿé˜Ÿåˆ—"><a href="#Redisson-å»¶è¿Ÿé˜Ÿåˆ—" class="headerlink" title="Redisson å»¶è¿Ÿé˜Ÿåˆ—"></a>Redisson å»¶è¿Ÿé˜Ÿåˆ—</h2><h3 id="åº•å±‚å®ç°"><a href="#åº•å±‚å®ç°" class="headerlink" title="åº•å±‚å®ç°"></a>åº•å±‚å®ç°</h3><p>åº•å±‚ç”¨ 3 ä¸ªé˜Ÿåˆ—å®ç°</p><ol><li>æ¶ˆæ¯å»¶è¿Ÿé˜Ÿåˆ—ï¼ŒZset ç±»å‹ï¼ŒæŒ‰ç…§è¿‡æœŸæ—¶é—´é¡ºåºå­˜æ”¾æ¶ˆæ¯åˆ—è¡¨</li><li>æ¶ˆæ¯é¡ºåºé˜Ÿåˆ—ï¼ŒList ç±»å‹ï¼ŒæŒ‰ç…§æ·»åŠ é¡ºåºå­˜æ”¾æ¶ˆæ¯åˆ—è¡¨</li><li>æ¶ˆæ¯ç›®æ ‡é˜Ÿåˆ—ï¼ŒList ç±»å‹ï¼Œå­˜æ”¾åˆ°æœŸçš„æ¶ˆæ¯ï¼Œä¾›æ¶ˆè´¹è€…è·å–</li></ol><p>æ¶ˆæ¯æ¥çš„æ—¶å€™å…ˆæ’å…¥ã€æ¶ˆæ¯å»¶è¿Ÿé˜Ÿåˆ—ã€‘å’Œã€æ¶ˆæ¯é¡ºåºé˜Ÿåˆ—ã€‘</p><p>æœ€åæ¶ˆè´¹è€…åœ¨ã€æ¶ˆæ¯ç›®æ ‡é˜Ÿåˆ—ã€‘è¿›è¡Œæ¶ˆè´¹çš„ï¼Œæ¶ˆè´¹è€…åªéœ€è¦é˜»å¡ç­‰å¾…ã€æ¶ˆæ¯ç›®æ ‡é˜Ÿåˆ—ã€‘å³å¯</p><h3 id="æ¶ˆæ¯ç§»åŠ¨"><a href="#æ¶ˆæ¯ç§»åŠ¨" class="headerlink" title="æ¶ˆæ¯ç§»åŠ¨"></a>æ¶ˆæ¯ç§»åŠ¨</h3><p>åœ¨åˆå§‹åŒ–å»¶è¿Ÿé˜Ÿåˆ—çš„æ—¶å€™ï¼Œä¼šå®šæ—¶ä»ã€æ¶ˆæ¯å»¶è¿Ÿé˜Ÿåˆ—ã€‘æŸ¥è¯¢åˆ°æœ€æ–°åˆ°æœŸæ—¶é—´ï¼Œå®šæ—¶æŠŠã€æ¶ˆæ¯å»¶è¿Ÿé˜Ÿåˆ—ã€‘çš„æ¶ˆæ¯ç§»åŠ¨åˆ°ã€æ¶ˆæ¯ç›®æ ‡é˜Ÿåˆ—ã€‘</p><p>å¦‚æœã€æ¶ˆæ¯å»¶è¿Ÿé˜Ÿåˆ—ã€‘æ˜¯ç©ºçš„ï¼Œå°±ä¸å†å®šæ—¶å·®ï¼Œè€Œæ˜¯ç­‰å¾…å‘å¸ƒè®¢é˜…æ¶ˆæ¯æé†’ï¼Œå†å®šæ—¶æŠŠã€æ¶ˆæ¯å»¶è¿Ÿé˜Ÿåˆ—ã€‘çš„æ¶ˆæ¯ç§»åŠ¨åˆ°ã€æ¶ˆæ¯ç›®æ ‡é˜Ÿåˆ—ã€‘</p><h3 id="å‘é€å’Œè·å–å»¶è¿Ÿæ¶ˆæ¯"><a href="#å‘é€å’Œè·å–å»¶è¿Ÿæ¶ˆæ¯" class="headerlink" title="å‘é€å’Œè·å–å»¶è¿Ÿæ¶ˆæ¯"></a>å‘é€å’Œè·å–å»¶è¿Ÿæ¶ˆæ¯</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// ç”Ÿäº§è€…</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">produce</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">queuename</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;delay-queue&quot;</span>;<br>    RBlockingQueue&lt;String&gt; blockingQueue = redissonClient.getBlockingQueue(queuename);<br>    RDelayedQueue&lt;String&gt; delayedQueue = redissonClient.getDelayedQueue(blockingQueue);<br>    delayedQueue.offer(<span class="hljs-string">&quot;æµ‹è¯•å»¶è¿Ÿæ¶ˆæ¯&quot;</span>, <span class="hljs-number">5</span>, TimeUnit.SECONDS);<br>&#125;<br><br><span class="hljs-comment">// æ¶ˆè´¹è€…</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">consume</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">queuename</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;delay-queue&quot;</span>;<br>    RBlockingQueue&lt;String&gt; blockingQueue = redissonClient.getBlockingQueue(queuename);<br>    RDelayedQueue&lt;String&gt; delayedQueue = redissonClient.getDelayedQueue(blockingQueue);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> blockingQueue.take();<br>    <span class="hljs-comment">//æ”¶åˆ°æ¶ˆæ¯è¿›è¡Œå¤„ç†...</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="åˆå§‹åŒ–å»¶è¿Ÿé˜Ÿåˆ—"><a href="#åˆå§‹åŒ–å»¶è¿Ÿé˜Ÿåˆ—" class="headerlink" title="åˆå§‹åŒ–å»¶è¿Ÿé˜Ÿåˆ—"></a>åˆå§‹åŒ–å»¶è¿Ÿé˜Ÿåˆ—</h3><p>ä¸»è¦æ˜¯è°ƒç”¨äº† <code>QueueTransferTask</code> çš„ <code>start()</code> æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"> Â  Â <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">start</span><span class="hljs-params">()</span> &#123;<br> Â  Â  Â  Â <span class="hljs-type">RTopic</span> <span class="hljs-variable">schedulerTopic</span> <span class="hljs-operator">=</span> getTopic();<br> Â  Â  Â  Â statusListenerId = schedulerTopic.addListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BaseStatusListener</span>() &#123;<br> Â  Â  Â  Â  Â  Â <span class="hljs-meta">@Override</span><br> Â  Â  Â  Â  Â  Â <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onSubscribe</span><span class="hljs-params">(String channel)</span> &#123;<br> Â  Â  Â  Â  Â  Â  Â  Â pushTask();<br> Â  Â  Â  Â  Â   &#125;<br> Â  Â  Â   &#125;);<br> Â  Â  Â  Â <br> Â  Â  Â  Â messageListenerId = schedulerTopic.addListener(Long.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageListener</span>&lt;Long&gt;() &#123;<br> Â  Â  Â  Â  Â  Â <span class="hljs-meta">@Override</span><br> Â  Â  Â  Â  Â  Â <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onMessage</span><span class="hljs-params">(CharSequence channel, Long startTime)</span> &#123;<br> Â  Â  Â  Â  Â  Â  Â  Â scheduleTask(startTime);<br> Â  Â  Â  Â  Â   &#125;<br> Â  Â  Â   &#125;);<br> Â   &#125;<br><br></code></pre></td></tr></table></figure><p>é˜Ÿåˆ—æœ‰æ–°çš„æ¶ˆè´¹è€…è®¢é˜…æ—¶ï¼Œè°ƒç”¨ <code>pushTask()</code> æ–¹æ³•ï¼ŒæŠŠæ¶ˆæ¯å‘é€å‡ºå»</p><p>æŒ‡å®šä¸»é¢˜æœ‰æ–°æ¶ˆæ¯æ—¶ï¼Œè°ƒç”¨ <code>scheduleTask(startTime)</code> æ–¹æ³•ï¼Œä¼šå®šæ—¶è°ƒç”¨ <code>pushTask()</code> æ–¹æ³•ï¼ŒæŠŠæ¶ˆæ¯å‘é€å‡ºå»</p><h3 id="ä¸ºä»€ä¹ˆåœ¨æ¶ˆè´¹ç«¯ä¹Ÿè¦åˆå§‹åŒ–å»¶è¿Ÿé˜Ÿåˆ—ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆåœ¨æ¶ˆè´¹ç«¯ä¹Ÿè¦åˆå§‹åŒ–å»¶è¿Ÿé˜Ÿåˆ—ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆåœ¨æ¶ˆè´¹ç«¯ä¹Ÿè¦åˆå§‹åŒ–å»¶è¿Ÿé˜Ÿåˆ—ï¼Ÿ"></a>ä¸ºä»€ä¹ˆåœ¨æ¶ˆè´¹ç«¯ä¹Ÿè¦åˆå§‹åŒ–å»¶è¿Ÿé˜Ÿåˆ—ï¼Ÿ</h3><p>æ¥æ”¶æ¶ˆæ¯çš„æ—¶å€™æ˜æ˜ç”¨ä¸åˆ° <code>delayedQueue</code> ä¸ºä»€ä¹ˆè¿˜è¦åŠ ï¼Ÿ</p><ul><li>åˆå§‹åŒ–å»¶è¿Ÿé˜Ÿåˆ—çš„ä½œç”¨æ˜¯ä¼šå®šæ—¶æŠŠã€æ¶ˆæ¯å»¶è¿Ÿé˜Ÿåˆ—ã€‘çš„åˆ°æœŸæ•°æ®ç§»åŠ¨åˆ°ã€æ¶ˆæ¯ç›®æ ‡é˜Ÿåˆ—ã€‘</li><li>å¦‚æœå‘é€æ–¹å‘é€äº†å»¶è¿Ÿæ¶ˆæ¯ï¼Œä½†åœ¨åˆ°æœŸä¹‹å‰ä¸‹çº¿äº†ï¼Œæ¥æ”¶æ–¹å°±æ¥æ”¶ä¸åˆ°äº†</li><li>æ‰€ä»¥æ˜¯ä¸ºäº†é¿å…ä¸€éƒ¨åˆ†æ•°æ®ä¸¢å¤±é—®é¢˜</li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>Redis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>é…ç½®ä¸­å¿ƒçš„é•¿è½®è¯¢</title>
    <link href="/2024/07/23/%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E7%9A%84%E9%95%BF%E8%BD%AE%E8%AF%A2/"/>
    <url>/2024/07/23/%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E7%9A%84%E9%95%BF%E8%BD%AE%E8%AF%A2/</url>
    
    <content type="html"><![CDATA[<h2 id="é…ç½®ä¸­å¿ƒçš„é•¿è½®è¯¢"><a href="#é…ç½®ä¸­å¿ƒçš„é•¿è½®è¯¢" class="headerlink" title="é…ç½®ä¸­å¿ƒçš„é•¿è½®è¯¢"></a>é…ç½®ä¸­å¿ƒçš„é•¿è½®è¯¢</h2><p>é…ç½®ä¸­å¿ƒæ˜¯ä¸ºäº†è§£å†³ä¼ ç»Ÿé™æ€é…ç½®ä¿®æ”¹é‡å¯åº”ç”¨çš„é—®é¢˜ï¼ŒNacos å’Œ Apollo éƒ½æ˜¯é€šè¿‡é•¿è½®è¯¢æ¥å®ç°åŠ¨æ€æ¨é€çš„ï¼Œè€Œä¸æ˜¯é•¿è¿æ¥</p><h2 id="æ¨æ‹‰æ¨¡å¼"><a href="#æ¨æ‹‰æ¨¡å¼" class="headerlink" title="æ¨æ‹‰æ¨¡å¼"></a>æ¨æ‹‰æ¨¡å¼</h2><p>æ•°æ®äº¤äº’æœ‰ä¸¤ç§æ¨¡å¼ï¼šã€æ¨æ¨¡å¼ pushã€‘å’Œã€æ‹‰æ¨¡å¼ pullã€‘</p><ul><li>æ¨æ¨¡å¼æ˜¯å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å»ºç«‹å¥½é•¿é“¾æ¥ï¼ŒæœåŠ¡å™¨çš„æ•°æ®æ¨é€åˆ°å®¢æˆ·ç«¯<ul><li>ä¼˜ç‚¹ï¼ŒåŠæ—¶ï¼Œä¸€æ—¦æœ‰æ•°æ®å˜æ›´ï¼Œå®¢æˆ·ç«¯ç«‹é©¬èƒ½æ„ŸçŸ¥åˆ°</li><li>ç¼ºç‚¹ï¼Œä¸çŸ¥é“å®¢æˆ·ç«¯æ¶ˆè´¹èƒ½åŠ›ï¼Œå¯èƒ½å¯¼è‡´æ•°æ®å †ç§¯</li></ul></li><li>æ‹‰æ¨¡å¼æ˜¯å®¢æˆ·ç«¯ä¸»åŠ¨å‘æœåŠ¡å™¨å‘èµ·è¯·æ±‚</li></ul><h2 id="é•¿è½®è¯¢ä¸è½®è¯¢"><a href="#é•¿è½®è¯¢ä¸è½®è¯¢" class="headerlink" title="é•¿è½®è¯¢ä¸è½®è¯¢"></a>é•¿è½®è¯¢ä¸è½®è¯¢</h2><p>é•¿è½®è¯¢å’Œè½®è¯¢éƒ½æ˜¯æ‹‰æ¨¡å¼å®ç°çš„</p><ul><li>è½®è¯¢æ˜¯æŒ‡ä¸ç®¡æœåŠ¡æ•°æ®æœ‰æ— æ›´æ–°ï¼Œå®¢æˆ·ç«¯æ¯éš”é¡¶é•¿æ—¶é—´å»è¯·æ±‚ä¸€æ¬¡æ•°æ®</li></ul><p>å¦‚æœé…ç½®ä¸­å¿ƒç”¨ã€è½®è¯¢ã€‘æ¨é€ï¼Œä¼šæœ‰ä»¥ä¸‹é—®é¢˜</p><ul><li>æ¨é€å»¶è¿Ÿï¼Œå®¢æˆ·ç«¯æ¯éš” 5s æ‹‰å–ä¸€æ¬¡é…ç½®ï¼Œå¦‚æœé…ç½®å˜æ›´å‘ç”Ÿåœ¨ç¬¬ 6sï¼Œæ¨é€çš„å»¶è¿Ÿå°±æ˜¯ 4s</li><li>æœåŠ¡ç«¯å‹åŠ›ï¼Œå› ä¸ºé…ç½®ä¸€èˆ¬ä¸ä¼šå‘ç”Ÿå˜åŒ–ï¼Œé¢‘ç¹è½®è¯¢ä¼šé€ æˆæœåŠ¡ç«¯å‹åŠ›</li><li>é™ä½è½®è¯¢é—´éš”ï¼Œå»¶è¿Ÿé™ä½ï¼Œå‹åŠ›å¢åŠ ï¼Œåä¹‹äº¦ç„¶</li></ul><p>ã€é•¿è½®è¯¢ã€‘æ˜¯å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚ï¼Œå¦‚æœæœåŠ¡ç«¯æ•°æ®æ²¡æœ‰å˜æ›´ï¼Œä¼š hold ä½è¯·æ±‚ï¼Œç›´åˆ°æœåŠ¡ç«¯æ•°æ®å‘ç”Ÿå˜åŒ–ï¼Œæˆ–è€…ç­‰å¾…ä¸€å®šæ—¶é—´è¶…æ—¶è¿”å›ã€‚å®¢æˆ·ç«¯å†æ¬¡å‘èµ·ä¸‹æ¬¡è¯·æ±‚</p><ul><li>æœåŠ¡ç«¯æ•°æ®å‘ç”Ÿå˜æ›´ä¹‹åï¼Œé•¿è½®è¯¢ç»“æŸï¼Œç«‹åˆ»è¿”å›å“åº”</li><li>é•¿è½®è¯¢é—´éš”ä¸€èˆ¬å¾ˆé•¿ 30s 60sï¼Œå¹¶ä¸”æœåŠ¡ç«¯ hold ä½è¿æ¥ï¼Œä¸ä¼šæ¶ˆè€—å¤ªå¤šèµ„æº</li></ul><p>ä¸ºä»€ä¹ˆè¦ç­‰å¾…ä¸€å®šæ—¶é—´è¶…æ—¶ï¼Œè€Œä¸æ˜¯ä¸€ç›´ hold è¯·æ±‚ï¼Ÿ</p><ul><li>è¿æ¥ç¨³å®šæ€§ï¼Œé•¿è½®è¯¢æœ¬è´¨ä¹Ÿæ˜¯ TCP è¿æ¥ï¼Œä»…ä»…ä¾é  TCP å±‚å¾ˆéš¾ä¿è¯å¯ç”¨æ€§</li><li>ç”¨æˆ·å¯èƒ½éšæ—¶æ–°å¢é…ç½®ç›‘å¬ï¼Œæ‰€ä»¥è¦åœ¨ä¸‹ä¸€æ¬¡é•¿è½®è¯¢ä¸­åŠ å…¥</li></ul><h2 id="é…ç½®ä¸­å¿ƒé•¿è½®è¯¢è®¾è®¡"><a href="#é…ç½®ä¸­å¿ƒé•¿è½®è¯¢è®¾è®¡" class="headerlink" title="é…ç½®ä¸­å¿ƒé•¿è½®è¯¢è®¾è®¡"></a>é…ç½®ä¸­å¿ƒé•¿è½®è¯¢è®¾è®¡</h2><ol><li>å®¢æˆ·ç«¯å‘èµ·é•¿è½®è¯¢ï¼Œå®¢æˆ·ç«¯å‘èµ·ä¸€ä¸ª http è¯·æ±‚ï¼ŒåŒ…å«é…ç½®ä¸­å¿ƒåœ°å€ï¼Œä»¥åŠç›‘å¬çš„ dataIdï¼ˆå®šä½é…ç½®çš„å”¯ä¸€é”®ï¼‰</li><li>æœåŠ¡ç«¯ç›‘å¬æ•°æ®å˜åŒ–ï¼ŒæœåŠ¡ç«¯ç»´æŠ¤ dataId å’Œé•¿è½®è¯¢æ˜ å°„å…³ç³»ï¼Œå¦‚æœé…ç½®å‘ç”Ÿå˜åŒ–ï¼ŒæœåŠ¡ç«¯ä¼šæ‰¾åˆ°å¯¹åº”çš„è¿æ¥ï¼Œåœ¨å“åº”ä½“é‡Œå¡«å…¥æ›´æ–°çš„é…ç½®å†…å®¹ï¼Œå¦‚æœè¶…æ—¶åˆ™è¿”å› 304</li><li>å®¢æˆ·ç«¯æ¥æ”¶å“åº”ï¼Œçœ‹æ˜¯ 200 è¿˜æ˜¯ 304</li></ol><p>é…ç½®ä¸­å¿ƒåœ¨å®ç°é•¿è½®è¯¢çš„æ—¶å€™ä¸åº”è¯¥é˜»å¡ Tomcat ä¸šåŠ¡çº¿ç¨‹ï¼Œæ‰€ä»¥ä¸€èˆ¬é‡‡ç”¨å¼‚æ­¥å“åº”æ–¹å¼å®ç°</p><h2 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h2><p>æœåŠ¡ç«¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// é…ç½®ç›‘å¬æ¥å…¥ç‚¹</span><br><span class="hljs-meta">@RequestMapping(&quot;/listener&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addListener</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;<br><br>    <span class="hljs-type">String</span> <span class="hljs-variable">dataId</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;dataId&quot;</span>);<br><br>    <span class="hljs-comment">// å¼€å¯å¼‚æ­¥</span><br>    <span class="hljs-type">AsyncContext</span> <span class="hljs-variable">asyncContext</span> <span class="hljs-operator">=</span> request.startAsync(request, response);<br>    <span class="hljs-type">AsyncTask</span> <span class="hljs-variable">asyncTask</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AsyncTask</span>(asyncContext, <span class="hljs-literal">true</span>);<br><br>    <span class="hljs-comment">// ç»´æŠ¤ dataId å’Œå¼‚æ­¥è¯·æ±‚ä¸Šä¸‹æ–‡çš„å…³è”</span><br>    dataIdContext.put(dataId, asyncTask);<br><br>    <span class="hljs-comment">// å¯åŠ¨å®šæ—¶å™¨ï¼Œ30s åå†™å…¥ 304 å“åº”</span><br>    timeoutChecker.schedule(() -&gt; &#123;<br>        <span class="hljs-keyword">if</span> (asyncTask.isTimeout()) &#123;<br>            dataIdContext.remove(dataId, asyncTask);<br>            response.setStatus(HttpServletResponse.SC_NOT_MODIFIED);<br>            asyncContext.complete();<br>        &#125;<br>    &#125;, <span class="hljs-number">30000</span>, TimeUnit.MILLISECONDS);<br>&#125;<br><br> <span class="hljs-comment">// é…ç½®å‘å¸ƒæ¥å…¥ç‚¹</span><br><span class="hljs-meta">@RequestMapping(&quot;/publishConfig&quot;)</span><br><span class="hljs-meta">@SneakyThrows</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">publishConfig</span><span class="hljs-params">(String dataId, String configInfo)</span> &#123;<br>    log.info(<span class="hljs-string">&quot;publish configInfo dataId: [&#123;&#125;], configInfo: &#123;&#125;&quot;</span>, dataId, configInfo);<br>    Collection&lt;AsyncTask&gt; asyncTasks = dataIdContext.removeAll(dataId);<br>    <span class="hljs-keyword">for</span> (AsyncTask asyncTask : asyncTasks) &#123;<br>        asyncTask.setTimeout(<span class="hljs-literal">false</span>);<br>        <span class="hljs-type">HttpServletResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> (HttpServletResponse)asyncTask.getAsyncContext().getResponse();<br>        response.setStatus(HttpServletResponse.SC_OK);<br>        response.getWriter().println(configInfo);<br>        asyncTask.getAsyncContext().complete();<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;success&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>é•¿è½®è¯¢è¯·æ±‚ <code>/listener</code> çš„æ—¶å€™è®¾ç½®å®šæ—¶å™¨ï¼Œ30s åå†™å…¥ 304 å“åº”</p><p>å¦‚æœåœ¨å…¶ä¸­é…ç½®å˜äº† <code>/publishConfig</code> å†™å…¥å˜æ›´ï¼Œå¹¶ä¸”å–æ¶ˆå®šæ—¶ä»»åŠ¡</p>]]></content>
    
    
    
    <tags>
      
      <tag>é…ç½®ä¸­å¿ƒ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MyBatis-step02</title>
    <link href="/2024/07/22/MyBatis-step02/"/>
    <url>/2024/07/22/MyBatis-step02/</url>
    
    <content type="html"><![CDATA[<p>è¿™æ˜¯ä¸€ä¸ªæµç¨‹ï¼Œ</p><ul><li>é€šè¿‡ <code>SqlSessionFactory</code> å¼€å¯ä¸€ä¸ª <code>SqlSession</code> </li><li><code>SqlSession</code> é‡Œæœ‰æˆå‘˜å˜é‡ <code>MapperRegistry</code> </li><li><code>MapperRegistry</code> é‡Œé¢é€šè¿‡åŒ…è·¯å¾„æ‰«æï¼Œå¾—åˆ°äº†ä¸€ä¸ª map</li><li>è¿™ä¸ª map å°è£…äº†æ¥å£ï¼Œè·Ÿå®ƒçš„ä»£ç†ç±»å·¥å‚</li><li>å¯ä»¥é€šè¿‡ get çš„æ–¹å¼è·å¾—ä»£ç†ç±»å·¥å‚ï¼Œç”¨å·¥å‚çš„é™æ€æ–¹æ³• new å‡ºæ¥ä¸€ä¸ªä»£ç†å¯¹è±¡</li><li><strong>ä½¿ç”¨å·¥å‚æ¨¡å¼å¯ä»¥å±è”½åˆ›å»ºç»†èŠ‚ï¼Œå»¶è¿Ÿåˆ›å»ºè¿‡ç¨‹</strong></li></ul><p>![image-20240818141349865](&#x2F;Users&#x2F;sudong&#x2F;Library&#x2F;Application Support&#x2F;typora-user-images&#x2F;image-20240818141349865.png)</p><p>ç›®å‰è¿™ä¸ªæ¥å£ä¸­å¯¹äºæ•°æ®åº“çš„æ“ä½œä»…ä»…åªæä¾›äº† selectOneï¼Œåç»­è¿˜ä¼šæœ‰ç›¸åº”å…¶ä»–æ–¹æ³•çš„å®šä¹‰</p><h2 id="ç›®å½•ç»“æ„å’Œä»£ç "><a href="#ç›®å½•ç»“æ„å’Œä»£ç " class="headerlink" title="ç›®å½•ç»“æ„å’Œä»£ç "></a>ç›®å½•ç»“æ„å’Œä»£ç </h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java">mybatis-step-<span class="hljs-number">02</span><br>â””â”€â”€ src<br>    â”œâ”€â”€ main<br>    â”‚   â””â”€â”€ java<br>    â”‚       â””â”€â”€ cn.bugstack.mybatis<br>    â”‚           â”œâ”€â”€ binding<br>    â”‚           â”‚   â”œâ”€â”€ MapperProxy.java<br>    â”‚           â”‚   â”œâ”€â”€ MapperProxyFactory.java<br>    â”‚           â”‚   â””â”€â”€ MapperRegistry.java<br>    â”‚           â””â”€â”€ session<br>    â”‚               â”œâ”€â”€ defaults<br>    â”‚               â”‚   â”œâ”€â”€ DefaultSqlSession.java<br>    â”‚               â”‚   â””â”€â”€ DefaultSqlSessionFactory.java<br>    â”‚               â”œâ”€â”€ SqlSession.java<br>    â”‚               â””â”€â”€ SqlSessionFactory.java<br>    â””â”€â”€ test<br>        â””â”€â”€ java<br>            â””â”€â”€ cn.bugstack.mybatis.test.dao<br>                â”œâ”€â”€ dao<br>                â”‚   â”œâ”€â”€ ISchoolDao.java<br>                â”‚   â””â”€â”€ IUserDao.java<br>                â””â”€â”€ ApiTest.java<br><br></code></pre></td></tr></table></figure><p>MapperProxy</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MapperProxy</span>&lt;T&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InvocationHandler</span>, Serializable &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> -<span class="hljs-number">6424540398559729838L</span>;<br><br>    <span class="hljs-comment">// æ‰€æœ‰çš„æ•°æ®åº“æ“ä½œè¯­å¥éƒ½æ˜¯é€šè¿‡ æ¥å£åç§°+æ–¹æ³•åç§°ä½œä¸º keyï¼Œæ“ä½œé€»è¾‘ä½œä¸º value</span><br>    <span class="hljs-comment">// åœ¨åå°„ä¸­è°ƒç”¨å°±æ˜¯è·å–å¯¹åº”çš„æ“ä½œç›´æ¥æ‰§è¡Œå¹¶è¿”å›ç»“æœ</span><br>    <span class="hljs-keyword">private</span> SqlSession sqlSession;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Class&lt;T&gt; mapperInterface;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MapperProxy</span><span class="hljs-params">(SqlSession sqlSession, Class&lt;T&gt; mapperInterface)</span> &#123;<br>        <span class="hljs-built_in">this</span>.sqlSession = sqlSession;<br>        <span class="hljs-built_in">this</span>.mapperInterface = mapperInterface;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>        <span class="hljs-comment">// Object ç±»é‡Œçš„æ–¹æ³•ä¸ä»£ç†</span><br>        <span class="hljs-keyword">if</span> (Object.class.equals(method.getDeclaringClass())) &#123;<br>            <span class="hljs-keyword">return</span> method.invoke(<span class="hljs-built_in">this</span>, args);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;ä½ çš„è¢«ä»£ç†äº†ï¼&quot;</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>MapperProxyFactory</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MapperProxyFactory</span>&lt;T&gt; &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Class&lt;T&gt; mapperInterface;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MapperProxyFactory</span><span class="hljs-params">(Class&lt;T&gt; mapperInterface)</span> &#123;<br>        <span class="hljs-built_in">this</span>.mapperInterface = mapperInterface;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> T <span class="hljs-title function_">newInstance</span><span class="hljs-params">(SqlSession sqlSession)</span> &#123;<br>        <span class="hljs-keyword">final</span> MapperProxy&lt;T&gt; mapperProxy = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MapperProxy</span>&lt;&gt;(sqlSession, mapperInterface);<br>        <span class="hljs-keyword">return</span> (T) Proxy.newProxyInstance(mapperInterface.getClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;mapperInterface&#125;, mapperProxy);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>MapperRegistry</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MapperRegistry</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * å°†å·²æ·»åŠ çš„æ˜ å°„å™¨ä»£ç†åŠ å…¥åˆ° HashMap</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;Class&lt;?&gt;, MapperProxyFactory&lt;?&gt;&gt; knownMappers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * æ ¹æ®ç±»å‹ï¼Œè¿”å›å·¥å‚ï¼Œå†ç”¨å·¥å‚ç”Ÿæˆä»£ç†å¯¹è±¡</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> type</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> sqlSession</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> &lt;T&gt;</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">getMapper</span><span class="hljs-params">(Class&lt;T&gt; type, SqlSession sqlSession)</span> &#123;<br>        <span class="hljs-keyword">final</span> MapperProxyFactory&lt;T&gt; mapperProxyFactory = (MapperProxyFactory&lt;T&gt;) knownMappers.get(type);<br>        <span class="hljs-keyword">if</span> (mapperProxyFactory == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;Type &quot;</span> + type + <span class="hljs-string">&quot; is not known to the MapperRegistry.&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">return</span> mapperProxyFactory.newInstance(sqlSession);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;Error getting mapper instance. Cause: &quot;</span> + e, e);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * æŠŠ type ç±»å‹çš„æ·»åŠ åˆ° knownMappers è¿™ä¸ª map é‡Œ</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> &lt;T&gt; <span class="hljs-keyword">void</span> <span class="hljs-title function_">addMapper</span><span class="hljs-params">(Class&lt;T&gt; type)</span> &#123;<br>        <span class="hljs-comment">/* Mapper å¿…é¡»æ˜¯æ¥å£æ‰ä¼šæ³¨å†Œ */</span><br>        <span class="hljs-keyword">if</span> (type.isInterface()) &#123;<br>            <span class="hljs-keyword">if</span> (hasMapper(type)) &#123;<br>                <span class="hljs-comment">// å¦‚æœé‡å¤æ·»åŠ äº†ï¼ŒæŠ¥é”™</span><br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;Type &quot;</span> + type + <span class="hljs-string">&quot; is already known to the MapperRegistry.&quot;</span>);<br>            &#125;<br>            <span class="hljs-comment">// æ³¨å†Œæ˜ å°„å™¨ä»£ç†å·¥å‚</span><br>            knownMappers.put(type, <span class="hljs-keyword">new</span> <span class="hljs-title class_">MapperProxyFactory</span>&lt;&gt;(type));<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * åˆ¤æ–­æ˜¯å¦å­˜åœ¨è¿‡</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> &lt;T&gt; <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasMapper</span><span class="hljs-params">(Class&lt;T&gt; type)</span> &#123;<br>        <span class="hljs-keyword">return</span> knownMappers.containsKey(type);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * æŠŠåŒ…ä¸‹çš„æ‰€æœ‰çš„ç±»æ·»åŠ åˆ° knownMappers é‡Œ</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> packageName</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addMappers</span><span class="hljs-params">(String packageName)</span> &#123;<br>        <span class="hljs-comment">// ç”¨äºæ‰«ææŒ‡å®šåŒ…åä¸‹çš„æ‰€æœ‰ç±»ï¼Œå¹¶è¿”å›è¿™äº›ç±»çš„é›†åˆ</span><br>        Set&lt;Class&lt;?&gt;&gt; mapperSet = ClassScanner.scanPackage(packageName);<br>        <span class="hljs-keyword">for</span> (Class&lt;?&gt; mapperClass : mapperSet) &#123;<br>            addMapper(mapperClass);<br>        &#125;<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure><p>DefaultSqlSession</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultSqlSession</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SqlSession</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * æ˜ å°„å™¨æ³¨å†Œæœº</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> MapperRegistry mapperRegistry;<br><br>    DefaultSqlSession(MapperRegistry mapperRegistry)&#123;<br>        <span class="hljs-built_in">this</span>.mapperRegistry = mapperRegistry;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">selectOne</span><span class="hljs-params">(String statement)</span> &#123;<br>        <span class="hljs-keyword">return</span> (T) (<span class="hljs-string">&quot;ä½ è¢«ä»£ç†äº†ï¼&quot;</span> + <span class="hljs-string">&quot;æ–¹æ³•ï¼š&quot;</span> + statement);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">selectOne</span><span class="hljs-params">(String statement, Object parameter)</span> &#123;<br>        <span class="hljs-keyword">return</span> (T) (<span class="hljs-string">&quot;ä½ è¢«ä»£ç†äº†ï¼&quot;</span> + <span class="hljs-string">&quot;æ–¹æ³•ï¼š&quot;</span> + statement + <span class="hljs-string">&quot; å…¥å‚ï¼š&quot;</span> + parameter);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">getMapper</span><span class="hljs-params">(Class&lt;T&gt; type)</span> &#123;<br>        <span class="hljs-keyword">return</span> mapperRegistry.getMapper(type, <span class="hljs-built_in">this</span>);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>DefaultSqlSessionFactory</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultSqlSessionFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SqlSessionFactory</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> MapperRegistry mapperRegistry;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">DefaultSqlSessionFactory</span><span class="hljs-params">(MapperRegistry mapperRegistry)</span> &#123;<br>        <span class="hljs-built_in">this</span>.mapperRegistry = mapperRegistry;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> SqlSession <span class="hljs-title function_">openSession</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultSqlSession</span>(mapperRegistry);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>SqlSession</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">SqlSession</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Retrieve a single row mapped from the statement key</span><br><span class="hljs-comment">     * æ ¹æ®æŒ‡å®šçš„SqlIDè·å–ä¸€æ¡è®°å½•çš„å°è£…å¯¹è±¡</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> &lt;T&gt;       the returned object type å°è£…ä¹‹åçš„å¯¹è±¡ç±»å‹</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> statement sqlID</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> Mapped object å°è£…ä¹‹åçš„å¯¹è±¡</span><br><span class="hljs-comment">     */</span><br>    &lt;T&gt; T <span class="hljs-title function_">selectOne</span><span class="hljs-params">(String statement)</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Retrieve a single row mapped from the statement key and parameter.</span><br><span class="hljs-comment">     * æ ¹æ®æŒ‡å®šçš„SqlIDè·å–ä¸€æ¡è®°å½•çš„å°è£…å¯¹è±¡ï¼Œåªä¸è¿‡è¿™ä¸ªæ–¹æ³•å®¹è®¸æˆ‘ä»¬å¯ä»¥ç»™sqlä¼ é€’ä¸€äº›å‚æ•°</span><br><span class="hljs-comment">     * ä¸€èˆ¬åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œè¿™ä¸ªå‚æ•°ä¼ é€’çš„æ˜¯pojoï¼Œæˆ–è€…Mapæˆ–è€…ImmutableMap</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> &lt;T&gt;       the returned object type</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> statement Unique identifier matching the statement to use.</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> parameter A parameter object to pass to the statement.</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> Mapped object</span><br><span class="hljs-comment">     */</span><br>    &lt;T&gt; T <span class="hljs-title function_">selectOne</span><span class="hljs-params">(String statement, Object parameter)</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Retrieves a mapper.</span><br><span class="hljs-comment">     * å¾—åˆ°æ˜ å°„å™¨ï¼Œè¿™ä¸ªå·§å¦™çš„ä½¿ç”¨äº†æ³›å‹ï¼Œä½¿å¾—ç±»å‹å®‰å…¨</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> &lt;T&gt;  the mapper type</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> type Mapper interface class</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> a mapper bound to this SqlSession</span><br><span class="hljs-comment">     */</span><br>    &lt;T&gt; T <span class="hljs-title function_">getMapper</span><span class="hljs-params">(Class&lt;T&gt; type)</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>SqlSessionFactory</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">SqlSessionFactory</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * æ‰“å¼€ä¸€ä¸ª session</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> SqlSession</span><br><span class="hljs-comment">     */</span><br>    SqlSession <span class="hljs-title function_">openSession</span><span class="hljs-params">()</span>;<br><br>&#125;<br><br></code></pre></td></tr></table></figure><p>Dao å±‚æ¥å£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ISchoolDao</span> &#123;<br><br>    String <span class="hljs-title function_">querySchoolName</span><span class="hljs-params">(String uId)</span>;<br><br>&#125;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IUserDao</span> &#123;<br><br>    String <span class="hljs-title function_">queryUserName</span><span class="hljs-params">(String uId)</span>;<br><br>    Integer <span class="hljs-title function_">queryUserAge</span><span class="hljs-params">(String uId)</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>æµ‹è¯•æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test_MapperProxyFactory</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// 1. æ³¨å†Œ Mapper</span><br>    <span class="hljs-type">MapperRegistry</span> <span class="hljs-variable">registry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MapperRegistry</span>();<br>    registry.addMappers(<span class="hljs-string">&quot;cn.bugstack.mybatis.test.dao&quot;</span>);<br><br>    <span class="hljs-comment">// 2. ä» SqlSession å·¥å‚è·å– Session</span><br>    <span class="hljs-type">SqlSessionFactory</span> <span class="hljs-variable">sqlSessionFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultSqlSessionFactory</span>(registry);<br>    <span class="hljs-type">SqlSession</span> <span class="hljs-variable">sqlSession</span> <span class="hljs-operator">=</span> sqlSessionFactory.openSession();<br><br>    <span class="hljs-comment">// 3. è·å–æ˜ å°„å™¨å¯¹è±¡</span><br>    <span class="hljs-type">IUserDao</span> <span class="hljs-variable">userDao</span> <span class="hljs-operator">=</span> sqlSession.getMapper(IUserDao.class);<br><br>    <span class="hljs-comment">// 4. æµ‹è¯•éªŒè¯</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">res</span> <span class="hljs-operator">=</span> userDao.queryUserName(<span class="hljs-string">&quot;10001&quot;</span>);<br>    logger.info(<span class="hljs-string">&quot;æµ‹è¯•ç»“æœï¼š&#123;&#125;&quot;</span>, res);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="ç­”ç–‘"><a href="#ç­”ç–‘" class="headerlink" title="ç­”ç–‘"></a>ç­”ç–‘</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Retrieves a mapper.</span><br><span class="hljs-comment"> * å¾—åˆ°æ˜ å°„å™¨ï¼Œè¿™ä¸ªå·§å¦™çš„ä½¿ç”¨äº†æ³›å‹ï¼Œä½¿å¾—ç±»å‹å®‰å…¨</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &lt;T&gt;  the mapper type</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> type Mapper interface class</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> a mapper bound to this SqlSession</span><br><span class="hljs-comment"> */</span><br>&lt;T&gt; T <span class="hljs-title function_">getMapper</span><span class="hljs-params">(Class&lt;T&gt; type)</span>;<br></code></pre></td></tr></table></figure><p>å¦‚ä½•ç†è§£ â€œå·§å¦™åœ°ä½¿ç”¨äº†æ³›å‹ï¼Œä½¿å¾—ç±»å‹å®‰å…¨â€</p><p>åœ¨è¿™ä¸ªæ–¹æ³•é‡Œï¼Œ<code>&lt;T&gt;</code> è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªæ³›å‹æ–¹æ³•ï¼Œå…¶ä¸­ä¼ å…¥çš„å‚æ•°æ˜¯ <code>Class&lt;T&gt;</code> è¿™è¯´æ˜å‚æ•°çš„ç±»å‹ä¸è¿”å›å€¼çš„ç±»å‹åº”è¯¥ç›¸ç­‰</p><p>ç±»å‹å®‰å…¨æ„å‘³ç€ç¼–è¯‘å™¨ä¼šåœ¨ç¼–è¯‘æ—¶è¿›è¡Œç±»å‹æ£€æŸ¥ï¼Œä»¥é˜²æ­¢ç±»å‹é”™è¯¯ï¼Œé€šè¿‡æ³›å‹ï¼Œ<code>getMapper</code> æ–¹æ³•èƒ½å¤Ÿç¡®ä¿è¿”å›çš„å¯¹è±¡ç±»å‹ä¸è°ƒç”¨è€…æœŸæœ›çš„ç±»å‹ä¸€è‡´ï¼Œé¿å…äº†å¼ºåˆ¶ç±»å‹è½¬æ¢</p><p>åœ¨è°ƒç”¨çš„æ—¶å€™å¯ä»¥è¿™æ ·</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">UserMapper</span> <span class="hljs-variable">userMapper</span> <span class="hljs-operator">=</span> sqlSesson.getMapepr(UserMapper.class);<br></code></pre></td></tr></table></figure><p>ä¸éæ³›å‹æ–¹æ³•å¯¹æ¯”</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getMapper</span><span class="hljs-params">(Class&lt;?&gt; type)</span>;<br></code></pre></td></tr></table></figure><p>åœ¨è°ƒç”¨çš„æ—¶å€™éœ€è¦å¼ºåˆ¶ç±»å‹è½¬æ¢ï¼Œç¼–è¯‘å™¨æ— æ³•éªŒè¯ç±»å‹è½¬æ¢æ˜¯å¦æ­£ç¡®ï¼Œå¯èƒ½åœ¨è¿è¡Œæ—¶æŠ›å‡º <code>ClassCastException</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">UserMapper</span> <span class="hljs-variable">userMapper</span> <span class="hljs-operator">=</span> (UserMapper) sqlSession.getMapper(UserMapper.class);<br></code></pre></td></tr></table></figure><p>æœ¬ç¯‡æ–‡ç« æ˜¯åœ¨å°å‚…å“¥çš„åŸºç¡€ä¸Šï¼Œæ·»åŠ äº†è‡ªå·±çš„ç†è§£å†™ä¸‹çš„<br>å°å‚…å“¥åšå®¢ï¼š<a href="https://bugstack.cn/">https://bugstack.cn</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>MyBatis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MyBatis-step01</title>
    <link href="/2024/07/21/MyBatis-step01/"/>
    <url>/2024/07/21/MyBatis-step01/</url>
    
    <content type="html"><![CDATA[<h2 id="InvocationHandler"><a href="#InvocationHandler" class="headerlink" title="InvocationHandler"></a>InvocationHandler</h2><p><code>InvocationHandler</code> æ¥å£æ˜¯ Java åŠ¨æ€ä»£ç†çš„æ ¸å¿ƒéƒ¨åˆ†ï¼Œå®ƒé‡Œé¢æœ‰ä¸€ä¸ªæ–¹æ³• <code>invoke</code> </p><p>å½“ä½¿ç”¨åŠ¨æ€ä»£ç†åˆ›å»ºä¸€ä¸ªä»£ç†å¯¹è±¡æ—¶ï¼Œæ‰€æœ‰å¯¹ä»£ç†å¯¹è±¡çš„æ–¹æ³•è°ƒç”¨éƒ½ä¼šè¢«è·¯ç”±åˆ°å®ç°äº† <code>InvocationHandler</code> æ¥å£çš„ <code>invoke</code> æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MapperProxy</span>&lt;T&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InvocationHandler</span>, Serializable &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> -<span class="hljs-number">6424540398559729838L</span>;<br>    <span class="hljs-comment">// æ­¤å¤„çœç•¥ä¸€äº›ï¼Œç›®çš„æ˜¯ä¸ºäº†ç»“æ„æ›´æ¸…æ™° ...</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>        <span class="hljs-comment">// Object ç±»é‡Œçš„æ–¹æ³•ä¸ä»£ç†</span><br>        <span class="hljs-keyword">if</span> (Object.class.equals(method.getDeclaringClass())) &#123;<br>            <span class="hljs-keyword">return</span> method.invoke(<span class="hljs-built_in">this</span>, args);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;ä½ çš„è¢«ä»£ç†äº†ï¼&quot;</span> + sqlSession.get(mapperInterface.getName() + <span class="hljs-string">&quot;.&quot;</span> + method.getName());<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¦‚æœåˆ›å»ºäº†ä¸€ä¸ª <code>MapperProxy</code> ä»£ç†å¯¹è±¡ï¼Œé‚£ä¹ˆå°±ä¼šè°ƒç”¨ <code>invoke</code> æ–¹æ³•</p><p><code>invoke</code> æ–¹æ³•é‡Œï¼Œå®ƒåšäº†ä¸€äº›åˆ¤æ–­ï¼Œå¯¹äº <code>Object</code> ç±»é‡Œçš„æ–¹æ³•ï¼Œä¸è¿›è¡Œä»£ç†</p><h2 id="Proxy-newProxyInstanse"><a href="#Proxy-newProxyInstanse" class="headerlink" title="Proxy.newProxyInstanse"></a>Proxy.newProxyInstanse</h2><p>æ˜¯ Java ä¸­ç”¨äºåˆ›å»ºåŠ¨æ€ä»£ç†å¯¹è±¡çš„ä¸€ä¸ªé™æ€æ–¹æ³•ï¼Œå‚æ•°åˆ—è¡¨å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">newProxyInstance</span><span class="hljs-params">(ClassLoader loader, Class&lt;?&gt;[] interfaces, InvocationHandler h)</span><br>        <span class="hljs-keyword">throws</span> IllegalArgumentException<br></code></pre></td></tr></table></figure><ul><li><code>ClassLoader loade</code>rï¼šæŒ‡å®šç±»åŠ è½½å™¨ï¼Œé€šå¸¸ä¼ å…¥<strong>ç›®æ ‡å¯¹è±¡çš„ç±»åŠ è½½å™¨</strong></li><li><code>Class&lt;?&gt;[] interfaces</code> ï¼šæ¥å£æ•°ç»„ï¼Œä»£ç†ç±»ä¼šå®ç°è¿™äº›æ¥å£ï¼Œ<strong>è¿™äº›æ¥å£å†³å®šäº†ä»£ç†ç±»å¯ä»¥è°ƒç”¨çš„æ–¹æ³•</strong></li><li><code>InvocationHandler h</code> ï¼š ä¸€ä¸ªæ¥å£ï¼Œä»£ç†å¯¹è±¡ä¸Šçš„æ‰€æœ‰æ–¹æ³•è°ƒç”¨éƒ½ä¼šå§”æ‰˜ç»™å®ƒçš„ <code>invoke</code> æ–¹æ³•</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MapperProxyFactory</span>&lt;T&gt; &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Class&lt;T&gt; mapperInterface;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MapperProxyFactory</span><span class="hljs-params">(Class&lt;T&gt; mapperInterface)</span> &#123;<br>        <span class="hljs-built_in">this</span>.mapperInterface = mapperInterface;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> T <span class="hljs-title function_">newInstance</span><span class="hljs-params">(Map&lt;String, String&gt; sqlSession)</span> &#123;<br>        <span class="hljs-keyword">final</span> MapperProxy&lt;T&gt; mapperProxy = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MapperProxy</span>&lt;&gt;(sqlSession, mapperInterface);<br>        <span class="hljs-keyword">return</span> (T) Proxy.newProxyInstance(mapperInterface.getClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;mapperInterface&#125;, mapperProxy);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªå·¥å‚ç±»éœ€è¦ä¼ å…¥ä¸€ä¸ªæ¥å£ <code>mapperInterface</code>ï¼Œè¿™ä¸ªæ¥å£å°±æ˜¯è¦ä»£ç†çš„æ¥å£</p><p>è°ƒç”¨ <code>Proxy.newProxyInstance</code> æ–¹æ³•ï¼Œä¼ å…¥ç±»åŠ è½½å™¨ï¼Œè¦å®ç°çš„æ¥å£ï¼Œå®ç°äº† <code>InvovationHandler</code> çš„æ¥å£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java">mybatis-step-<span class="hljs-number">01</span><br>â””â”€â”€ src<br>    â”œâ”€â”€ main<br>    â”‚   â””â”€â”€ java<br>    â”‚       â””â”€â”€ cn.bugstack.mybatis.binding<br>    â”‚           â”œâ”€â”€ MapperProxy.java<br>    â”‚           â””â”€â”€ MapperProxyFactory.java<br>    â””â”€â”€ test<br>        â””â”€â”€ java<br>            â””â”€â”€ cn.bugstack.mybatis.test.dao<br>                â”œâ”€â”€ dao<br>                â”‚   â””â”€â”€ IUserDao.java<br>                â””â”€â”€ ApiTest.java<br></code></pre></td></tr></table></figure><p>MapperProxy</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MapperProxy</span>&lt;T&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InvocationHandler</span>, Serializable &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> -<span class="hljs-number">6424540398559729838L</span>;<br><br>    <span class="hljs-keyword">private</span> Map&lt;String, String&gt; sqlSession;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Class&lt;T&gt; mapperInterface;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MapperProxy</span><span class="hljs-params">(Map&lt;String, String&gt; sqlSession, Class&lt;T&gt; mapperInterface)</span> &#123;<br>        <span class="hljs-built_in">this</span>.sqlSession = sqlSession;<br>        <span class="hljs-built_in">this</span>.mapperInterface = mapperInterface;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>        <span class="hljs-keyword">if</span> (Object.class.equals(method.getDeclaringClass())) &#123;<br>            <span class="hljs-keyword">return</span> method.invoke(<span class="hljs-built_in">this</span>, args);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;ä½ çš„è¢«ä»£ç†äº†ï¼&quot;</span> + sqlSession.get(mapperInterface.getName() + <span class="hljs-string">&quot;.&quot;</span> + method.getName());<br>        &#125;<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure><p>MapperProxyFactory</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MapperProxyFactory</span>&lt;T&gt; &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Class&lt;T&gt; mapperInterface;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MapperProxyFactory</span><span class="hljs-params">(Class&lt;T&gt; mapperInterface)</span> &#123;<br>        <span class="hljs-built_in">this</span>.mapperInterface = mapperInterface;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> T <span class="hljs-title function_">newInstance</span><span class="hljs-params">(Map&lt;String, String&gt; sqlSession)</span> &#123;<br>        <span class="hljs-keyword">final</span> MapperProxy&lt;T&gt; mapperProxy = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MapperProxy</span>&lt;&gt;(sqlSession, mapperInterface);<br>        <span class="hljs-keyword">return</span> (T) Proxy.newProxyInstance(mapperInterface.getClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;mapperInterface&#125;, mapperProxy);<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure><p>IUserDao</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IUserDao</span> &#123;<br><br>    String <span class="hljs-title function_">queryUserName</span><span class="hljs-params">(String uId)</span>;<br><br>    Integer <span class="hljs-title function_">queryUserAge</span><span class="hljs-params">(String uId)</span>;<br><br>&#125;<br><br></code></pre></td></tr></table></figure><p>æµ‹è¯•ç”¨ä¾‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test_MapperProxyFactory</span><span class="hljs-params">()</span> &#123;<br>    MapperProxyFactory&lt;IUserDao&gt; factory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MapperProxyFactory</span>&lt;&gt;(IUserDao.class);<br>    Map&lt;String, String&gt; sqlSession = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br><br>    sqlSession.put(<span class="hljs-string">&quot;cn.bugstack.mybatis.test.dao.IUserDao.queryUserName&quot;</span>, <span class="hljs-string">&quot;æ¨¡æ‹Ÿæ‰§è¡Œ Mapper.xml ä¸­ SQL è¯­å¥çš„æ“ä½œï¼šæŸ¥è¯¢ç”¨æˆ·å§“å&quot;</span>);<br>    sqlSession.put(<span class="hljs-string">&quot;cn.bugstack.mybatis.test.dao.IUserDao.queryUserAge&quot;</span>, <span class="hljs-string">&quot;æ¨¡æ‹Ÿæ‰§è¡Œ Mapper.xml ä¸­ SQL è¯­å¥çš„æ“ä½œï¼šæŸ¥è¯¢ç”¨æˆ·å¹´é¾„&quot;</span>);<br>    <span class="hljs-type">IUserDao</span> <span class="hljs-variable">userDao</span> <span class="hljs-operator">=</span> factory.newInstance(sqlSession);<br><br>    <span class="hljs-type">String</span> <span class="hljs-variable">res</span> <span class="hljs-operator">=</span> userDao.queryUserName(<span class="hljs-string">&quot;10001&quot;</span>);<br>    logger.info(<span class="hljs-string">&quot;æµ‹è¯•ç»“æœï¼š&#123;&#125;&quot;</span>, res);<br>&#125;<br><br><span class="hljs-comment">// cn.bugstack.mybatis.test.ApiTest - æµ‹è¯•ç»“æœï¼šä½ çš„è¢«ä»£ç†äº†ï¼æ¨¡æ‹Ÿæ‰§è¡Œ Mapper.xml ä¸­ SQL è¯­å¥çš„æ“ä½œï¼šæŸ¥è¯¢ç”¨æˆ·å§“å</span><br></code></pre></td></tr></table></figure><p>æœ¬ç¯‡æ–‡ç« æ˜¯åœ¨å°å‚…å“¥çš„åŸºç¡€ä¸Šï¼Œæ·»åŠ äº†è‡ªå·±çš„ç†è§£å†™ä¸‹çš„<br>å°å‚…å“¥åšå®¢ï¼š<a href="https://bugstack.cn/">https://bugstack.cn</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>MyBatis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å®‰å…¨ç‚¹ SafePoint</title>
    <link href="/2024/07/17/%E5%AE%89%E5%85%A8%E7%82%B9SafePoint/"/>
    <url>/2024/07/17/%E5%AE%89%E5%85%A8%E7%82%B9SafePoint/</url>
    
    <content type="html"><![CDATA[<h1 id="å®‰å…¨ç‚¹"><a href="#å®‰å…¨ç‚¹" class="headerlink" title="å®‰å…¨ç‚¹"></a>å®‰å…¨ç‚¹</h1><p>HotSpot è™šæ‹Ÿæœºå¹¶éåœ¨ä»£ç æŒ‡ä»¤æµçš„ä»»æ„ä½ç½®éƒ½èƒ½åœä¸‹æ¥å¼€å§‹åƒåœ¾å›æ”¶çš„ï¼Œè€Œæ˜¯å¼ºåˆ¶è¦æ±‚å¿…é¡»æ‰§è¡Œåˆ°<strong>å®‰å…¨ç‚¹</strong>åæ‰èƒ½å¤Ÿæš‚åœ</p><p>å®‰å…¨ç‚¹çš„é€‰å®šåŸºæœ¬ä¸Šæ˜¯ä»¥â€œæ˜¯å¦å…·æœ‰è®©ç¨‹åºé•¿æ—¶é—´æ‰§è¡Œçš„ç‰¹å¾â€ ä¸ºæ ‡å‡†è¿›è¡Œé€‰å®šçš„ï¼Œæœ€æ˜æ˜¾çš„ç‰¹å¾æ˜¯æŒ‡ä»¤ç³»åˆ—çš„å¤ç”¨ï¼Œæ‰€ä»¥åªæœ‰å…·æœ‰è¿™äº›åŠŸèƒ½çš„æŒ‡ä»¤æ‰ä¼šäº§ç”Ÿå®‰å…¨ç‚¹</p><ul><li>æ–¹æ³•è°ƒç”¨</li><li>å¾ªç¯è·³è½¬</li><li>å¼‚å¸¸è·³è½¬</li></ul><h2 id="å¾ªç¯"><a href="#å¾ªç¯" class="headerlink" title="å¾ªç¯"></a>å¾ªç¯</h2><p>HotSpot è™šæ‹Ÿæœºä¸ºäº†é¿å…å®‰å…¨ç‚¹è¿‡å¤šå¸¦æ¥è¿‡é‡çš„è´Ÿæ‹…ï¼Œå¯¹å¾ªç¯æœ‰ä¸€é¡¹ä¼˜åŒ–æªæ–½ï¼Œè®¤ä¸ºå¾ªç¯æ¬¡æ•°è¾ƒå°‘çš„è¯ï¼Œæ‰§è¡Œæ—¶é—´åº”è¯¥ä¹Ÿä¸ä¼šå¤ªé•¿</p><ul><li>ä½¿ç”¨ int æˆ–è€…æ›´å°èŒƒå›´çš„æ•°æ®ç±»å‹ä½œä¸ºç´¢å¼•çš„å¾ªç¯é»˜è®¤æ˜¯ä¸ä¼šæ”¾ç½®å®‰å…¨ç‚¹çš„ï¼Œè¿™ç§å¾ªç¯è¢«ç§°ä¸ºå¯æ•°å¾ªç¯ï¼›</li><li>ä½¿ç”¨ long æˆ–è€…èŒƒå›´æ›´å¤§çš„æ•°æ®ç±»å‹ä½œä¸ºç´¢å¼•å€¼çš„å¾ªç¯å°±è¢«ç§°ä¸ºä¸å¯æ•°å¾ªç¯ï¼ˆUncounted Loopï¼‰å°†ä¼šè¢«æ”¾ç½®å®‰å…¨ç‚¹</li></ul><h2 id="nativeæ–¹æ³•ï¼ˆJNIï¼‰"><a href="#nativeæ–¹æ³•ï¼ˆJNIï¼‰" class="headerlink" title="nativeæ–¹æ³•ï¼ˆJNIï¼‰"></a>nativeæ–¹æ³•ï¼ˆJNIï¼‰</h2><p>å½“æŸä¸ªçº¿ç¨‹åœ¨æ‰§è¡Œ native å‡½æ•°çš„æ—¶å€™ï¼Œæ­¤æ—¶è¯¥çº¿ç¨‹åœ¨æ‰§è¡Œ JVM ç®¡ç†ä»¥å¤–çš„ä»£ç ï¼Œä¸èƒ½å¯¹ JVM çš„æ‰§è¡ŒçŠ¶æ€åšä»»ä½•ä¿®æ”¹ï¼Œå› è€Œ JVM è¦è¿›å…¥ SafePointï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥æŠŠæ­£åœ¨æ‰§è¡Œ native å‡½æ•°çš„çº¿ç¨‹çœ‹åš â€œå·²ç»è¿›å…¥äº† SafePointâ€ æˆ–è€…æŠŠè¿™ç§æƒ…å†µå«åš â€œåœ¨ safe-region é‡Œâ€</p><p>Thread.sleep(0) æ–¹æ³•å°±æ˜¯ä¸€ä¸ª native æ–¹æ³•ï¼Œæ˜¯ä¸€ä¸ª JNI è°ƒç”¨ï¼Œåœ¨è¿”å› Java è¿™è¾¹çš„æ—¶å€™ä¼šè¿›å…¥ SafePoint</p><p>RocketMQ çš„æºç ä¸­ <code>Thread.sleep(0)</code> çš„æ“ä½œå°±æ˜¯è®©ä»–è¿›å…¥å®‰å…¨ç‚¹</p><p><img src="https://gitee.com/AWallFlower/picture/raw/master/img/20240716223334.png" alt="image.png"></p><h2 id="GCçš„æ—¶æœº"><a href="#GCçš„æ—¶æœº" class="headerlink" title="GCçš„æ—¶æœº"></a>GCçš„æ—¶æœº</h2><p>HotSpotä¼šåœ¨æ‰€æœ‰æ–¹æ³•çš„ä¸´è¿”å›ä¹‹å‰ï¼Œä»¥åŠæ‰€æœ‰écounted loopçš„å¾ªç¯çš„å›è·³ä¹‹å‰æ”¾ç½®å®‰å…¨ç‚¹</p><p>JVM åœ¨åš GC ä¹‹å‰è¦ç­‰æ‰€æœ‰çš„åº”ç”¨çº¿ç¨‹è¿›å…¥åˆ°å®‰å…¨ç‚¹ä¹‹å VM çº¿ç¨‹æ‰èƒ½åˆ†æ´¾ GC ä»»åŠ¡ï¼Œå¦‚æœæœ‰çº¿ç¨‹ä¸€ç›´æ²¡æœ‰è¿›å…¥åˆ°å®‰å…¨ç‚¹ï¼Œå°±ä¼šå¯¼è‡´ GC æ—¶JVM åœé¡¿æ—¶é—´å»¶é•¿</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">for</span>ï¼ˆ<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>ï¼›i&lt;<span class="hljs-number">1000000000</span>ï¼›i++)<br></code></pre></td></tr></table></figure><p>æ˜¯ä¸€ä¸ªå…¸å‹çš„ Counted Loops å°±æ˜¯æœ‰æ˜ç¡®çš„å¾ªç¯è®¡æ•°å™¨å˜é‡ï¼Œè€Œä¸”è¯¥å˜é‡æœ‰æ˜ç¡®çš„èµ·å§‹å€¼ã€ç»ˆæ­¢å€¼ã€æ­¥è¿›é•¿åº¦çš„å¾ªç¯æ‰€ä»¥å½“è¿™ä¸ªå¾ªç¯è¿è¡Œæ—¶ï¼ŒJVMå°†æ— æ³•åœæ­¢çº¿ç¨‹</p><h2 id="GCè¦ç­‰æ‰€æœ‰çº¿ç¨‹è¿›å…¥å®‰å…¨ç‚¹çš„ä¾‹å­"><a href="#GCè¦ç­‰æ‰€æœ‰çº¿ç¨‹è¿›å…¥å®‰å…¨ç‚¹çš„ä¾‹å­" class="headerlink" title="GCè¦ç­‰æ‰€æœ‰çº¿ç¨‹è¿›å…¥å®‰å…¨ç‚¹çš„ä¾‹å­"></a>GCè¦ç­‰æ‰€æœ‰çº¿ç¨‹è¿›å…¥å®‰å…¨ç‚¹çš„ä¾‹å­</h2><ol><li>å¯åŠ¨äº†ä¸¤ä¸ªé•¿çš„ã€ä¸é—´æ–­çš„å¾ªç¯ï¼ˆå†…éƒ¨æ²¡æœ‰å®‰å…¨ç‚¹æ£€æŸ¥ï¼‰ã€‚</li><li>ä¸»çº¿ç¨‹è¿›å…¥ç¡çœ çŠ¶æ€ 1 ç§’é’Ÿã€‚</li><li>åœ¨1000 msä¹‹åï¼ŒJVMå°è¯•åœ¨Safepointåœæ­¢ï¼Œä»¥ä¾¿Javaçº¿ç¨‹è¿›è¡Œå®šæœŸæ¸…ç†ï¼Œä½†æ˜¯ç›´åˆ°å¯æ•°å¾ªç¯å®Œæˆåæ‰èƒ½æ‰§è¡Œæ­¤æ“ä½œã€‚</li><li>ä¸»çº¿ç¨‹çš„ Thread.sleep æ–¹æ³•ä» native è¿”å›ï¼Œå‘ç°å®‰å…¨ç‚¹æ“ä½œæ­£åœ¨è¿›è¡Œä¸­ï¼Œäºæ˜¯æŠŠè‡ªå·±æŒ‚èµ·ï¼Œç›´åˆ°æ“ä½œç»“æŸã€‚<br>ç”±äºVMThreadçš„æŸäº›æ“ä½œéœ€è¦STWï¼Œä¸»çº¿ç¨‹åœ¨sleepç»“æŸå‰è¿›å…¥äº†JVMå…¨å±€å®‰å…¨ç‚¹ï¼Œç„¶åä¸»çº¿ç¨‹è¦ç­‰å¾…å…¶ä»–çº¿ç¨‹å…¨éƒ¨è¿›å…¥å®‰å…¨ç‚¹ï¼Œæ‰€ä»¥ä¸»çº¿ç¨‹è¢«é•¿æ—¶é—´æ²¡æœ‰è¿›å…¥å®‰å…¨ç‚¹çš„å…¶ä»–çº¿ç¨‹ç»™é˜»å¡äº†</li></ol><p><img src="https://gitee.com/AWallFlower/picture/raw/master/img/20240716223347.png" alt="image.png"></p>]]></content>
    
    
    
    <tags>
      
      <tag>JVM</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Redis å®ç°å»¶è¿Ÿé˜Ÿåˆ—</title>
    <link href="/2024/07/10/Redis%20%E5%AE%9E%E7%8E%B0%E5%BB%B6%E8%BF%9F%E9%98%9F%E5%88%97/"/>
    <url>/2024/07/10/Redis%20%E5%AE%9E%E7%8E%B0%E5%BB%B6%E8%BF%9F%E9%98%9F%E5%88%97/</url>
    
    <content type="html"><![CDATA[<p>Redis åšå»¶è¿Ÿé˜Ÿåˆ—æœ‰ä¸¤ç§æ–¹æ¡ˆï¼š</p><ul><li>Redis è¿‡æœŸæ—¶é—´ç›‘å¬</li><li>Redisson å†…ç½®çš„å»¶è¿Ÿé˜Ÿåˆ—</li></ul><h2 id="Redis-è¿‡æœŸäº‹ä»¶ç›‘å¬å®ç°å»¶è¿Ÿé˜Ÿåˆ—"><a href="#Redis-è¿‡æœŸäº‹ä»¶ç›‘å¬å®ç°å»¶è¿Ÿé˜Ÿåˆ—" class="headerlink" title="Redis è¿‡æœŸäº‹ä»¶ç›‘å¬å®ç°å»¶è¿Ÿé˜Ÿåˆ—"></a>Redis è¿‡æœŸäº‹ä»¶ç›‘å¬å®ç°å»¶è¿Ÿé˜Ÿåˆ—</h2><p>Redis æœ‰å‘å¸ƒè®¢é˜…ï¼ˆpub&#x2F;subï¼‰åŠŸèƒ½ï¼Œåœ¨ pub&#x2F;subï¼Œå¼•å…¥äº† <code>channelï¼ˆé¢‘é“ï¼‰</code>ï¼Œç±»ä¼¼äºæ¶ˆæ¯é˜Ÿåˆ—çš„ topic ï¼ˆä¸»é¢˜ï¼‰</p><p>pub&#x2F;sub æ¶‰åŠå‘å¸ƒè€…<code>publisher</code> å’Œ è®¢é˜…è€… <code>subscriber</code> ä¸¤ä¸ªè§’è‰²</p><ul><li>å‘å¸ƒè€…é€šè¿‡ <code>publish</code> æŠ•é€’ç»™æŒ‡å®šçš„ channel</li><li>è®¢é˜…è€…é€šè¿‡ subscribe è®¢é˜…ä¸€ä¸ªæˆ–å¤šä¸ªçš„ channel</li></ul><p><img src="https://gitee.com/AWallFlower/picture/raw/master/img/20240811213610.png"></p><p>ç”Ÿäº§è€…æŒ‡å®šæ¶ˆæ¯åˆ° channelï¼Œæ¶ˆè´¹è€…è®¢é˜…å¯¹åº”çš„ channel</p><p>Redis ä¸­æœ‰å¾ˆå¤šé»˜è®¤çš„ channelï¼Œè¿™äº› channel æ˜¯ç”± Redis æœ¬èº«å‘å®ƒä»¬å‘é€æ¶ˆæ¯ï¼Œ<code>__keyevent@0__:expired</code> å°±æ˜¯ä¸€ä¸ªé»˜è®¤çš„ channelï¼Œè´Ÿè´£ç›‘å¬ key çš„è¿‡æœŸäº‹ä»¶</p><p>å½“ä¸€ä¸ª key è¿‡æœŸä¹‹åï¼ŒRedis ä¼šå‘å¸ƒä¸€ä¸ª key è¿‡æœŸçš„äº‹ä»¶åˆ°è¿™ä¸ª channel ä¸­</p><p>åªéœ€è¦ç›‘å¬è¿™ä¸ª channelï¼Œå°±å¯ä»¥æ‹¿åˆ°è¿‡æœŸçš„ key çš„æ¶ˆæ¯ï¼Œè¿›è€Œå®ç°äº†å»¶è¿Ÿé˜Ÿåˆ—</p><h3 id="ç¼ºç‚¹-1ï¼šæ—¶æ•ˆæ€§å·®"><a href="#ç¼ºç‚¹-1ï¼šæ—¶æ•ˆæ€§å·®" class="headerlink" title="ç¼ºç‚¹ 1ï¼šæ—¶æ•ˆæ€§å·®"></a>ç¼ºç‚¹ 1ï¼šæ—¶æ•ˆæ€§å·®</h3><p>è¿‡æœŸäº‹ä»¶æ˜¯åœ¨ Redis åˆ é™¤ key æ—¶å‘å¸ƒçš„ï¼Œä¸æ˜¯è®¾ç½®çš„è¿‡æœŸæ—¶é—´åˆ°çš„æ—¶å€™ç›´æ¥å‘å¸ƒ</p><p>è¿‡æœŸåˆ é™¤ç­–ç•¥æœ‰ 2 ä¸ª</p><ul><li>æƒ°æ€§åˆ é™¤ï¼Œå¯¹ CPU å‹å¥½ï¼Œä½†æ˜¯å¯èƒ½å¯¼è‡´è¿‡æœŸçš„ key æ²¡æœ‰åˆ é™¤</li><li>å®šæœŸåˆ é™¤ï¼Œæ¯éš”ä¸€æ®µæ—¶é—´æŠ½å–ä¸€æ‰¹ key æ‰§è¡Œåˆ é™¤ï¼Œå¯¹å†…å­˜å‹å¥½</li></ul><p>Redis é‡‡ç”¨çš„æ˜¯ å®šæœŸåˆ é™¤+æƒ°æ€§åˆ é™¤ï¼Œå› æ­¤ä¼šå­˜åœ¨ key è¿‡æœŸäº†ï¼Œä½†æ˜¯äº‹ä»¶è¿˜æœªå‘å¸ƒ</p><h3 id="ç¼ºç‚¹2ï¼šä¸¢æ¶ˆæ¯"><a href="#ç¼ºç‚¹2ï¼šä¸¢æ¶ˆæ¯" class="headerlink" title="ç¼ºç‚¹2ï¼šä¸¢æ¶ˆæ¯"></a>ç¼ºç‚¹2ï¼šä¸¢æ¶ˆæ¯</h3><p>Redis ä¸­æ¶ˆæ¯ä¸æ”¯æŒæŒä¹…åŒ–ï¼Œå½“ channel æ²¡æœ‰è®¢é˜…è€…æ—¶ï¼Œæ¶ˆæ¯ä¼šè¢«ç›´æ¥ä¸¢å¼ƒ</p><h3 id="ç¼ºç‚¹3ï¼šå¤šæœåŠ¡å®ä¾‹ä¸‹å­˜åœ¨æ¶ˆæ¯é‡å¤é—®é¢˜"><a href="#ç¼ºç‚¹3ï¼šå¤šæœåŠ¡å®ä¾‹ä¸‹å­˜åœ¨æ¶ˆæ¯é‡å¤é—®é¢˜" class="headerlink" title="ç¼ºç‚¹3ï¼šå¤šæœåŠ¡å®ä¾‹ä¸‹å­˜åœ¨æ¶ˆæ¯é‡å¤é—®é¢˜"></a>ç¼ºç‚¹3ï¼šå¤šæœåŠ¡å®ä¾‹ä¸‹å­˜åœ¨æ¶ˆæ¯é‡å¤é—®é¢˜</h3><p>Redis çš„æ¶ˆæ¯é˜Ÿåˆ—åªæœ‰å¹¿æ’­æ¨¡å¼ï¼Œæ‰€æœ‰è®¢é˜…æŒ‡å®š channel çš„å®ä¾‹å…¨éƒ½èƒ½æ”¶åˆ°æ¶ˆæ¯ï¼Œéœ€è¦å¤„ç†é‡å¤æ¶ˆè´¹é—®é¢˜</p><h2 id="Redisson-å†…ç½®çš„å»¶è¿Ÿé˜Ÿåˆ—å®ç°"><a href="#Redisson-å†…ç½®çš„å»¶è¿Ÿé˜Ÿåˆ—å®ç°" class="headerlink" title="Redisson å†…ç½®çš„å»¶è¿Ÿé˜Ÿåˆ—å®ç°"></a>Redisson å†…ç½®çš„å»¶è¿Ÿé˜Ÿåˆ—å®ç°</h2><p>Redissonçš„å»¶è¿Ÿé˜Ÿåˆ— RDelayedQueue æ˜¯åŸºäº ZSet å®ç°çš„ï¼Œéœ€è¦æ‰§è¡Œå»¶è¿Ÿçš„ä»»åŠ¡æ’å…¥åˆ° ZSet ä¸­ï¼Œå¹¶ç»™ä»–ä»¬è®¾ç½®ç›¸åº”çš„è¿‡æœŸæ—¶é—´ä½œä¸ºåˆ†æ•°</p><p>ä½¿ç”¨ <code>zrangebyscore</code> å‘½ä»¤æ‰«æ ZSet ä¸­è¿‡æœŸçš„å…ƒç´ ï¼Œç„¶åå°†è¿™äº›è¿‡æœŸå…ƒç´ ä» ZSet ä¸­ç§»é™¤ï¼Œå¹¶å°†å®ƒä»¬åŠ å…¥åˆ°å°±ç»ªæ¶ˆæ¯åˆ—è¡¨ä¸­ã€‚å°±ç»ªæ¶ˆæ¯åˆ—è¡¨æ˜¯ä¸€ä¸ªé˜»å¡é˜Ÿåˆ—ï¼Œæœ‰æ¶ˆæ¯è¿›å…¥å°±ä¼šè¢«ç›‘å¬åˆ°ã€‚è¿™æ ·åšå¯ä»¥é¿å…å¯¹æ•´ä¸ª ZSet è¿›è¡Œè½®è¯¢ï¼Œæé«˜äº†æ‰§è¡Œæ•ˆç‡</p><p>ä¼˜åŠ¿ï¼š</p><ul><li>å‡å°‘äº†ä¸¢æ¶ˆæ¯çš„å¯èƒ½ï¼šDelayedQueue ä¸­çš„æ¶ˆæ¯ä¼šè¢«æŒä¹…åŒ–ï¼Œå³ä½¿Rediså®•æœºäº†ï¼Œæ ¹æ®æŒä¹…åŒ–æœºåˆ¶ï¼Œä¹Ÿåªå¯èƒ½ä¸¢å¤±ä¸€ç‚¹æ¶ˆæ¯ï¼Œå½±å“ä¸å¤§ã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨æ‰«ææ•°æ®åº“çš„æ–¹æ³•ä½œä¸ºè¡¥å¿æœºåˆ¶ã€‚</li><li>æ¶ˆæ¯ä¸å­˜åœ¨é‡å¤æ¶ˆè´¹é—®é¢˜ï¼šæ¯ä¸ªå®¢æˆ·ç«¯éƒ½æ˜¯ä»åŒä¸€ä¸ªç›®æ ‡é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡çš„ï¼Œä¸å­˜åœ¨é‡å¤æ¶ˆè´¹çš„é—®é¢˜ã€‚</li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>Redis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Feed æµ â€”â€” Timeline</title>
    <link href="/2024/07/06/Timeline/"/>
    <url>/2024/07/06/Timeline/</url>
    
    <content type="html"><![CDATA[<h1 id="Timeline"><a href="#Timeline" class="headerlink" title="Timeline"></a>Timeline</h1><p>æœ¬æ–‡ä»‹ç»åŸºäºå…³æ³¨å…³ç³»å¹¶æŒ‰æ—¶é—´æ’åˆ—çš„ Feed æµ</p><p>Feed æµæœ‰ä¸¤ç§å·¥ä½œæ¨¡å¼ï¼Œæ¨æ¨¡å¼å’Œæ‹‰æ¨¡å¼</p><h2 id="æ‹‰æ¨¡å¼"><a href="#æ‹‰æ¨¡å¼" class="headerlink" title="æ‹‰æ¨¡å¼"></a>æ‹‰æ¨¡å¼</h2><p>åœ¨ç”¨æˆ·æŸ¥è¯¢æ—¶åº”è¯¥é¦–å…ˆæŸ¥è¯¢ç”¨æˆ·å…³æ³¨çš„æ‰€æœ‰åšä¸»çš„ <code>uid</code> æŸ¥è¯¢ä»–ä»¬å‘å¸ƒçš„ä½œå“ï¼Œæœ€åæŒ‰ç…§å‘å¸ƒæ—¶é—´é™åºæ’åˆ—</p><p>æ‹‰æ¨¡å¼ç”¨æˆ·æ¯æ‰“å¼€ä¸€æ¬¡ â€œå…³æ³¨é¡µâ€ ç³»ç»Ÿå°±éœ€è¦è¯»å– N ä¸ªäººçš„æ–‡ç« ï¼ˆN ä¸ºç”¨æˆ·å…³æ³¨çš„åšä¸»æ•°ï¼‰æ‰€ä»¥æ‹‰æ¨¡å¼åˆè¢«ç§°ä¸º<strong>è¯»æ‰©æ•£</strong></p><p>æ‹‰æ¨¡å¼ä¸éœ€è¦é¢å¤–å­˜å‚¨æ•°æ®</p><ul><li>å‘å¸ƒæ–‡ç« åœ¨ <code>articles</code> è¡¨å¢åŠ ä¸€æ¡æ•°æ®</li><li>ç”¨æˆ·å…³æ³¨åœ¨ <code>followings</code> è¡¨ä¸­å¢åŠ ä¸€æ¡æ•°æ®</li></ul><p>åœ¨ç²‰ä¸æ•°ç‰¹åˆ«å¤šçš„åšä¸»å‘å¸ƒå†…å®¹æ—¶ï¼Œä¸éœ€è¦è¿›è¡Œç‰¹æ®Šå¤„ç†ï¼Œç­‰åˆ°ç”¨æˆ·è¿›å…¥å…³æ³¨é¡µå†è®¡ç®—å°±å¥½</p><p>ä½†æ˜¯æ¯æ¬¡è¿›å…¥å…³æ³¨é¡µéƒ½è¦è¿›è¡Œå¤§é‡è¯»å–å’Œæ’åºæ“ä½œï¼Œå¦‚æœç”¨æˆ·å…³æ³¨çš„äººæ¯”è¾ƒå¤šï¼Œä¸€æ¬¡æ‹‰å–è€—æ—¶ä¼šå¾ˆå¤§</p><h2 id="æ¨æ¨¡å¼"><a href="#æ¨æ¨¡å¼" class="headerlink" title="æ¨æ¨¡å¼"></a>æ¨æ¨¡å¼</h2><p>åšä¸»åœ¨å‘å¸ƒæ–‡ç« çš„æ—¶å€™å°±è¦æŠŠæ–°æ–‡ç« å†™å…¥ç²‰ä¸çš„ <code>Timeline</code> ä¸­ï¼Œç”¨æˆ·æ¯æ¬¡åªéœ€è¦åˆ°è‡ªå·±å…³æ³¨çš„ <code>Timeline</code> ä¸­</p><p>æ¨æ¨¡å¼æ¯æ¬¡å‘å¸ƒæ–‡ç« éƒ½è¦å†™å…¥ M æ¡æ•°æ®ï¼ˆM æ˜¯ç²‰ä¸æ•°ï¼‰æ‰€ä»¥æ¨æ¨¡å¼ä¹Ÿå«<strong>å†™æ‰©æ•£</strong></p><p>åœ¨ç²‰ä¸æ•°æ¯”è¾ƒå¤šçš„åšä¸»ï¼Œæ¯æ¬¡å‘å¸ƒä½œå“éƒ½è¦æ¨é€å¾ˆå¤šï¼Œä½“éªŒä¸å¤Ÿå‹å¥½</p><p>ä¸€èˆ¬å‘å¸ƒæ–‡ç« ä¹‹åï¼Œå‰ç«¯è¿”å›æˆåŠŸï¼Œç”¨ MQ å¼‚æ­¥å‘ç²‰ä¸ <code>Timeline</code> æ¨é€</p><h2 id="åœ¨çº¿æ¨ï¼Œç¦»çº¿æ‹‰"><a href="#åœ¨çº¿æ¨ï¼Œç¦»çº¿æ‹‰" class="headerlink" title="åœ¨çº¿æ¨ï¼Œç¦»çº¿æ‹‰"></a>åœ¨çº¿æ¨ï¼Œç¦»çº¿æ‹‰</h2><p><code>Timeline</code> å®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªç¼“å­˜</p><p>ç»™ <code>Timeline</code> çš„å­˜å‚¨è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œå¦‚æœç”¨æˆ·ä¸€æ®µæ—¶é—´æ²¡æœ‰æ‰“å¼€ APPï¼Œ<code>Timeline</code> ä¼šå¤±æ•ˆï¼Œåœ¨ä»–å›å½’ä¹‹åé€šè¿‡æ‹‰æ¨¡å¼é‡å»ºç¼“å­˜å³å¯</p><p>åˆ¤æ–­ç”¨æˆ·æ˜¯å¦åœ¨çº¿ï¼Œä¹Ÿå°±å¯ä»¥é€šè¿‡ <code>Timeline</code> ç¼“å­˜æ˜¯å¦å­˜åœ¨ä½œä¸ºåˆ¤æ–­ä¾æ®</p><p>å¹¶ä¸”ç”¨æˆ·æ€»æ˜¯å…³å¿ƒå…³æ³¨é¡µä¸­æœ€æ–°çš„å†…å®¹ï¼Œæ‰€ä»¥ <code>Timeline</code> ä¹Ÿæ²¡å¿…è¦å­˜å®Œæ•´çš„æ•°æ®ï¼Œå­˜æœ€è¿‘ä¸€æ®µæ—¶é—´çš„å³å¯ï¼Œæ—§æ•°æ®ç­‰ç”¨æˆ·ç¿»é˜…æ—¶é‡å»º</p><h2 id="å­˜å‚¨"><a href="#å­˜å‚¨" class="headerlink" title="å­˜å‚¨"></a>å­˜å‚¨</h2><p>ç”¨ ZSet å­˜å‚¨ï¼Œ<code>article_id</code> ä½œä¸ºé›†åˆçš„ memberï¼Œå‘å¸ƒæ—¶é—´æˆ³ä½œä¸º score</p><p>æ¨é€çš„æ—¶å€™å¯¹ç›®æ ‡ <code>Timeline</code> çš„ ZSet è¿›è¡Œ ZAdd æ“ä½œï¼Œè‹¥ç¼“å­˜æ²¡æœ‰æŸä¸ª <code>Timeline</code> å°±ç”¨æ‹‰æ¨¡å¼é‡å»º</p><p>å­˜åœ¨çš„é—®é¢˜</p><ul><li><p>å¦‚æœæ²¡æœ‰æŸä¸ª <code>Timeline</code> çš„ç¼“å­˜æ—¶ï¼Œæ— æ³•åˆ¤æ–­ç¼“å­˜æ˜¯å¦å¤±æ•ˆäº†ï¼Œè¿˜æ˜¯è¿™ä¸ªç”¨æˆ·çš„<code>Timeline</code> æœ¬æ¥å°±æ˜¯ç©ºçš„ï¼Œåªèƒ½é€šè¿‡è¯»å– MySQL æ•°æ®æ‰èƒ½åˆ¤æ–­ï¼Œä¼šé€ æˆç¼“å­˜ç©¿é€</p></li><li><p>ç”±äºåªå­˜å‚¨ä¸€æ®µæ—¶é—´çš„ <code>Timeline</code> æ‰€ä»¥å½“è¯»å®Œäº† Redis ä¸­çš„æ•°æ®ä¹‹åï¼Œæ— æ³•åˆ¤æ–­æ•°æ®åº“ä¸­æ˜¯å¦æœ‰æ›´ä¹…çš„æ•°æ®</p></li></ul><p>è§£å†³åŠæ³•ï¼š</p><ul><li>åœ¨ ZSet ä¸­æ”¾ä¸€ä¸ª <code>noMore</code> æ ‡å¿—ï¼Œè¡¨ç¤ºæ•°æ®åº“ä¸­æ²¡æœ‰æ›´å¤šçš„æ•°æ®äº†ï¼Œå¯¹äº <code>Timeline</code> æœ¬æ¥å°±ä¸ºç©ºçš„ç”¨æˆ·ï¼Œä»–ä»¬ ZSet ä¸­åªæœ‰ä¸€ä¸ª <code>noMor</code> æ ‡å¿—</li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>ç³»ç»Ÿè®¾è®¡</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ç‚¹èµä¸šåŠ¡è®¾è®¡</title>
    <link href="/2024/07/03/%E7%82%B9%E8%B5%9E%E4%B8%9A%E5%8A%A1%E8%AE%BE%E8%AE%A1/"/>
    <url>/2024/07/03/%E7%82%B9%E8%B5%9E%E4%B8%9A%E5%8A%A1%E8%AE%BE%E8%AE%A1/</url>
    
    <content type="html"><![CDATA[<h1 id="ç‚¹èµ"><a href="#ç‚¹èµ" class="headerlink" title="ç‚¹èµ"></a>ç‚¹èµ</h1><p>å†…å®¹ç‚¹èµæ˜¯ä¸€ä¸ªéå¸¸é«˜é¢‘çš„ä¸šåŠ¡åœºæ™¯ï¼ŒåŠŸèƒ½æœ¬èº«å¤æ‚åº¦ä¸é«˜ï¼Œä½†æ˜¯ä¸šåŠ¡åœºæ™¯å¤šï¼ŒQPS é«˜ï¼Œè€Œä¸”ç”±äºç¤¾åŒºçš„ç”¨æˆ·ä½“é‡ï¼Œæ•´ä½“ç‚¹èµçš„æ•°æ®é‡éå¸¸å¤§</p><p>ç‚¹èµæœåŠ¡éœ€è¦æä¾›çš„æ¥å£æœ‰</p><ul><li>å¯¹æŸä¸ªå†…å®¹ç‚¹èµï¼ˆå–æ¶ˆç‚¹èµï¼‰ã€ç‚¹è¸©ï¼ˆå–æ¶ˆç‚¹è¸©ï¼‰</li><li>æŸ¥è¯¢æ˜¯å¦å¯¹ å•ä¸ª æˆ–è€… ä¸€æ‰¹å†…å®¹ ç‚¹è¿‡èµï¼ˆè¸©ï¼‰ - å³ç‚¹èµçŠ¶æ€æŸ¥è¯¢</li><li>æŸ¥è¯¢æŸä¸ªå†…å®¹çš„ç‚¹èµæ•°</li><li>æŸ¥è¯¢æŸä¸ªç”¨æˆ·çš„ç‚¹èµåˆ—è¡¨</li><li>æŸ¥è¯¢æŸä¸ªå†…å®¹çš„ç‚¹èµäººåˆ—è¡¨</li><li>æŸ¥è¯¢ç”¨æˆ·æ”¶åˆ°çš„æ€»ç‚¹èµæ•°</li></ul><p>å…¶ä¸­æœ€æ ¸å¿ƒçš„ä¸»è¦æ˜¯</p><ul><li>ç”¨æˆ·æ˜¯å¦ç‚¹èµå†…å®¹</li><li>å†…å®¹ç‚¹èµæ•°</li></ul><p>åœ¨åˆ· Feed æµæ—¶ï¼Œæ¯ä¸€æ¬¡ä¸‹æ»‘ï¼Œéƒ½éœ€è¦å¯¹æ•°åç¯‡å†…å®¹è¿›è¡Œç™»å½•ç”¨æˆ·æ˜¯å¦ç‚¹èµçš„åˆ¤æ–­</p><h2 id="æ–¹æ¡ˆ1"><a href="#æ–¹æ¡ˆ1" class="headerlink" title="æ–¹æ¡ˆ1"></a>æ–¹æ¡ˆ1</h2><p>ç”¨ Redis çš„ set ç»“æ„è¿›è¡Œå­˜å‚¨ç”¨æˆ· id</p><p><code>contentId: [userId1, userId2, ...]</code></p><p>ç”¨ set çš„ <code>Sismember</code> åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ç‚¹èµï¼Œç”¨ <code>Scard</code> åˆ¤æ–­ç‚¹èµæ•°é‡</p><p>é—®é¢˜ï¼š</p><ul><li>å¦‚æœæ˜¯çƒ­ç‚¹æ•°æ®ï¼Œç‚¹èµç”¨æˆ·å¾ˆå¤šï¼Œå®¹æ˜“å‡ºç°<strong>å¤§ Key</strong> é—®é¢˜</li><li>ç¼“å­˜é‡å»ºçš„æ—¶å€™éœ€è¦æŸ¥è¯¢å…¨éƒ¨ç‚¹èµç”¨æˆ·ï¼Œå®¹æ˜“å‡ºç°<strong>æ…¢æŸ¥è¯¢</strong>é—®é¢˜</li></ul><h3 id="å¤§-key-çš„å±å®³"><a href="#å¤§-key-çš„å±å®³" class="headerlink" title="å¤§ key çš„å±å®³"></a>å¤§ key çš„å±å®³</h3><ul><li>å¯¹å¤§ key æ‰§è¡Œè¯»è¯·æ±‚ï¼Œä¼šä½¿Redis å®ä¾‹çš„å¸¦å®½ä½¿ç”¨ç‡è¢«å æ»¡ï¼Œå¯¼è‡´è‡ªèº«æœåŠ¡å˜æ…¢</li><li>å¯¹å¤§ key è¿›è¡Œåˆ é™¤æ“ä½œï¼Œæ˜“é€ æˆä¸»åº“é•¿æ—¶é—´é˜»å¡</li></ul><h2 id="æ–¹æ¡ˆ-2"><a href="#æ–¹æ¡ˆ-2" class="headerlink" title="æ–¹æ¡ˆ 2"></a>æ–¹æ¡ˆ 2</h2><p>å¯¹å¤§ Key è¿›è¡Œåˆ†ç‰‡å¤„ç†ï¼Œå¯¹åŒä¸€åŠ¨æ€ä¸‹çš„ç‚¹èµç”¨æˆ·ï¼Œè¿›è¡Œåˆ†ç‰‡å†æ”¾åˆ°ç¼“å­˜é‡Œï¼Œæ¯æ¬¡æ“ä½œç¼“å­˜æ—¶å…ˆæ ¹æ® <code>userId</code> è®¡ç®—åˆ†ç‰‡å€¼</p><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs pf">contentId-<span class="hljs-number">1</span>: [<span class="hljs-keyword">user</span>Id1, <span class="hljs-keyword">user</span>Id11...]  // æŠŠç”¨æˆ·ç»“å°¾ä¸º <span class="hljs-number">1</span> çš„å…¨æ”¾åˆ°è¿™é‡Œ<br>contentId-<span class="hljs-number">2</span>: [<span class="hljs-keyword">user</span>Id2, <span class="hljs-keyword">user</span>Id22...]<br>contentId-<span class="hljs-number">3</span>: [<span class="hljs-keyword">user</span>Id3, <span class="hljs-keyword">user</span>Id33...]<br></code></pre></td></tr></table></figure><p>é—®é¢˜</p><ul><li>ç¼“å­˜åˆ†ç‰‡ä»ç„¶ç»´æŠ¤äº†è¢«æµè§ˆåŠ¨æ€ä¸‹å…¨éƒ¨ç‚¹èµæ•°æ®ï¼ŒFeed æµåœºæ™¯ä¸‹ï¼Œç”¨æˆ·æµè§ˆè¿‡çš„åŠ¨æ€ï¼Œå‡ ä¹ä¸ä¼šå†æ¬¡è¢«æµè§ˆ</li><li>ä¸€äº›ç‚¹èµé‡å¤šçš„å†å²åŠ¨æ€ï¼Œæœ‰äººè®¿é—®æ—¶ä¼šé‡å»ºç¼“å­˜ï¼Œé‡å»ºæˆæœ¬é«˜ï¼Œä½†æ˜¯ç”¨ç‡ä¸é«˜</li><li>åˆ†ç‰‡å¢åŠ äº†ä¸šåŠ¡å¤æ‚æ€§ï¼Œå¢åŠ äº†ç»´æŠ¤ç¼“å­˜çš„éš¾åº¦</li><li>åˆ†ç‰‡ä¼šå¯¼è‡´äº§ç”Ÿå¤§é‡çš„ Keyï¼ŒKey ä¹Ÿä¼šå ç”¨å†…å­˜ç©ºé—´</li></ul><h2 id="æ–¹æ¡ˆ-3"><a href="#æ–¹æ¡ˆ-3" class="headerlink" title="æ–¹æ¡ˆ 3"></a>æ–¹æ¡ˆ 3</h2><p>ä½¿ç”¨ <code>Hash</code> ç»“æ„ï¼Œ<code>userId</code> ä½œä¸º key</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br><span class="hljs-attr">&quot;userId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br><span class="hljs-attr">&quot;ttl&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1653532653</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;contentId1&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">//ç”¨æˆ·è¿‘ä¸€æ®µæ—¶é—´ç‚¹èµè¿‡çš„åŠ¨æ€id</span><br><span class="hljs-attr">&quot;contentId2&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">//ç”¨æˆ·è¿‘ä¸€æ®µæ—¶é—´ç‚¹èµè¿‡çš„åŠ¨æ€id</span><br><span class="hljs-attr">&quot;contentIdn&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">//ç”¨æˆ·è¿‘ä¸€æ®µæ—¶é—´ç‚¹èµè¿‡çš„åŠ¨æ€id</span><br><span class="hljs-attr">&quot;minContentId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3540575</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">//ç¼“å­˜ä¸­æœ€å°çš„åŠ¨æ€idï¼Œç”¨ä»¥åŒºåˆ†å†·çƒ­ï¼Œ</span><br><span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><ul><li>ä¹‹å‰çš„æ–¹æ¡ˆè®¿é—®è€æ—§å†…å®¹ä¼šé‡å»ºç¼“å­˜ï¼Œæ€§ä»·æ¯”ä½ï¼Œè€Œä¸”å†…å®¹ä¸‹ç‚¹èµç”¨æˆ·å¹¶ä¸æ˜¯ä¸€ç›´æ´»è·ƒæˆ–é‡æ–°è®¿é—®çš„ï¼Œæ‰€ä»¥å…ˆæ–¹æ¡ˆè¦åŒºåˆ†å†·çƒ­æ•°æ®</li><li><code>contentId</code> å†…å®¹ idï¼Œæ˜¯é€’å¢çš„ï¼Œä¸€å®šç¨‹åº¦ä¸Šååº”äº†æ•°æ®çš„å†·çƒ­</li><li>ç¼“å­˜ä¸­åªç»´æŠ¤ä¸€å®šæ—¶é—´å’Œä¸€å®šæ•°é‡çš„ <code>contentId</code> ï¼Œå¹¶å¢åŠ  <code>minContentId</code> å­—æ®µç”¨äºåŒºåˆ†å†·çƒ­æ•°æ®</li><li>å¯¹äºå†·æ•°æ®ï¼Œç›´æ¥è®¿é—® DBï¼Œä¸å†é‡å»ºç¼“å­˜</li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>ç³»ç»Ÿè®¾è®¡</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>è§‚å¯Ÿè€…æ¨¡å¼</title>
    <link href="/2024/06/29/%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F/"/>
    <url>/2024/06/29/%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F/</url>
    
    <content type="html"><![CDATA[<p>è§‚å¯Ÿè€…æ¨¡å¼æ˜¯ä¸€ç§ä¸€å¯¹å¤šçš„å…³ç³»ï¼Œå½“ä¸€ä¸ªå¯¹è±¡çŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶ï¼Œæ‰€æœ‰ä¾èµ–äºå®ƒçš„å¯¹è±¡éƒ½å¾—åˆ°é€šçŸ¥å¹¶å®Œæˆæ›´æ–°</p><ul><li>è¢«è§‚å¯Ÿè€…ï¼ˆObserverableï¼‰ï¼šç›®æ ‡å¯¹è±¡ï¼ŒçŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼Œé€šçŸ¥æ‰€æœ‰çš„è§‚å¯Ÿè€…</li><li>è§‚å¯Ÿè€…ï¼ˆObserverï¼‰ï¼šæ¥æ”¶è¢«è§‚å¯Ÿè€…çŠ¶æ€å˜åŒ–é€šçŸ¥</li></ul><p>ä¾‹å¦‚å¼‚æ­¥é€šçŸ¥åœºæ™¯</p><ol><li>å®šä¹‰è¢«è§‚å¯Ÿè€…</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Observable</span> &#123;<br>    <span class="hljs-keyword">private</span> List&lt;Observer&gt; observers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> state;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getState</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> state;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setState</span><span class="hljs-params">(<span class="hljs-type">int</span> state)</span>&#123;<br>        notifyAllObservers(state);<br>    &#125;<br><br>    <span class="hljs-comment">// æ·»åŠ è§‚å¯Ÿè€…</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addObserve</span><span class="hljs-params">(Observer observer)</span>&#123;<br>        observers.add(observer);<br>    &#125;<br>    <span class="hljs-comment">// ç§»é™¤è§‚å¯Ÿè€…</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeObserve</span><span class="hljs-params">(Observer observer)</span>&#123;<br>        observers.remove(observer);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">notifyAllObservers</span><span class="hljs-params">(<span class="hljs-type">int</span> state)</span>&#123;<br>        <span class="hljs-keyword">if</span> (state != <span class="hljs-number">1</span>)&#123;<br>            System.out.println(<span class="hljs-string">&quot;ä¸æ˜¯é€šçŸ¥çŠ¶æ€&quot;</span>);<br>            <span class="hljs-keyword">return</span> ;<br>        &#125;<br>        <span class="hljs-keyword">for</span> (Observer observer : observers) &#123;<br>            observer.doEvent();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="2"><li>è§‚å¯Ÿè€…æ¥å£ä»¥åŠå®ç°</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Observer</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * è§‚å¯Ÿè€…æ–¹æ³•</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">doEvent</span><span class="hljs-params">()</span>;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EmailObserver</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Observer</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doEvent</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;å‘é‚®ä»¶&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MobileObserver</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Observer</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doEvent</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;å‘çŸ­ä¿¡&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>è®¾è®¡æ¨¡å¼</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>æšä¸¾å®ç°è´£ä»»é“¾</title>
    <link href="/2024/06/26/%E6%9E%9A%E4%B8%BE%E5%AE%9E%E7%8E%B0%E8%B4%A3%E4%BB%BB%E9%93%BE/"/>
    <url>/2024/06/26/%E6%9E%9A%E4%B8%BE%E5%AE%9E%E7%8E%B0%E8%B4%A3%E4%BB%BB%E9%93%BE/</url>
    
    <content type="html"><![CDATA[<p>è´£ä»»é“¾å…è®¸è¯·æ±‚æ²¿ç€å¤„ç†è€…é“¾è¿›è¡Œå¤„ç†ï¼Œç±»ä¼¼äºæ‹¦æˆªå™¨</p><p>è´£ä»»é“¾ç”±ä¸‰éƒ¨åˆ†ç»„æˆ</p><ul><li>æŠ½è±¡å¤„ç†è€…ï¼ˆHandlerï¼‰ï¼šå®šä¹‰ä¸€ä¸ªå¤„ç†è¯·æ±‚çš„æŠ½è±¡ç±»ï¼ŒåŒ…å«å¤„ç†æ–¹æ³•å’Œä¸€ä¸ª next æŒ‡é’ˆ</li><li>å…·ä½“å¤„ç†è€…ï¼šå®ç°æŠ½è±¡å¤„ç†è€…æ–¹æ³•</li><li>å®¢æˆ·ç«¯</li></ul><p>æŠ½è±¡å¤„ç†è€…</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GatewayHandler</span> &#123;<br>    <span class="hljs-keyword">protected</span> GatewayHandler next;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setNext</span><span class="hljs-params">(GatewayHandler next)</span>&#123;<br>        <span class="hljs-built_in">this</span>.next = next;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-type">int</span> <span class="hljs-title function_">handler</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>å…·ä½“å®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApiLimitGatewayHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">GatewayHandler</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">log</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(ApiLimitGatewayHandler.class);<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">handler</span><span class="hljs-params">()</span> &#123;<br>        log.info(<span class="hljs-string">&quot;Api é™æµç½‘å…³å¤„ç†å™¨æ‰§è¡Œä¸­...&quot;</span>);<br>        <span class="hljs-comment">// ... è¿™é‡Œåˆ¤æ–­æ˜¯å¦æ»¡è¶³è¿™ä¸ªè´£ä»»é“¾</span><br>        <span class="hljs-comment">// å¦‚æœæ»¡è¶³ï¼Œçœ‹æ˜¯å¦æœ‰ä¸‹ä¸€ä¸ªè´£ä»»é“¾ï¼Œ</span><br>        <span class="hljs-keyword">if</span> (next != <span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-keyword">return</span> next.handler();<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BlackListGatewayHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">GatewayHandler</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">log</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(BlackListGatewayHandler.class);<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">handler</span><span class="hljs-params">()</span> &#123;<br>        log.info(<span class="hljs-string">&quot;é»‘åå•å¤„ç†å™¨æ‰§è¡Œä¸­...&quot;</span>);<br>        <span class="hljs-keyword">if</span> (next != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> next.handler();<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SessionGatewayHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">GatewayHandler</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">log</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(SessionGatewayHandler.class);<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">handler</span><span class="hljs-params">()</span> &#123;<br>        log.info(<span class="hljs-string">&quot;Session å¤„ç†å™¨æ‰§è¡Œä¸­...&quot;</span>);<br>        <span class="hljs-keyword">if</span> (next != <span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-keyword">return</span> next.handler();<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ç”¨æšä¸¾è¿›è¡Œè´£ä»»é“¾çš„é…ç½®</p><p>ç›®å½•ç»“æ„ï¼š</p><p><img src="https://gitee.com/AWallFlower/picture/raw/master/img/20240630130532.png"></p><ol><li>å®šä¹‰ä¸€ä¸ªå®ä½“ç±»ï¼Œå­˜æ”¾è´£ä»»é“¾çš„å®ä½“ä¿¡æ¯</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@NoArgsConstructor</span><br><span class="hljs-meta">@AllArgsConstructor</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GatewayEntity</span> &#123;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> String conference;  <span class="hljs-comment">// å…¨é™å®šç±»å</span><br>    <span class="hljs-keyword">private</span> Integer handlerId; <br>    <span class="hljs-keyword">private</span> Integer preHandlerId;<br>    <span class="hljs-keyword">private</span> Integer nextHandlerId;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="2"><li>å®šä¹‰ä¸€ä¸ªæšä¸¾ï¼Œé‡Œé¢å­˜å‚¨ <code>GatewayEntity</code> ï¼ˆæšä¸¾æœ¬è´¨ä¸Šä¹Ÿæ˜¯ä¸€ä¸ªç±»ï¼Œé‡Œé¢çš„æšä¸¾å¯¹è±¡æ˜¯ç”¨ä¸€ä¸ªæ•°ç»„å­˜å‚¨çš„ï¼‰</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">GatewayEnum</span> &#123;<br>    API_HANDLER(<span class="hljs-keyword">new</span> <span class="hljs-title class_">GatewayEntity</span>(<span class="hljs-string">&quot;API é™æµ&quot;</span>, <span class="hljs-string">&quot;com.dong.demo.design.chain.impl.ApiLimitGatewayHandler&quot;</span>,<br>            <span class="hljs-number">1</span>, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>)),<br>    BLACKLIST_HANDLER(<span class="hljs-keyword">new</span> <span class="hljs-title class_">GatewayEntity</span>(<span class="hljs-string">&quot;é»‘åå˜é™æµ&quot;</span>, <span class="hljs-string">&quot;com.dong.demo.design.chain.impl.BlackListGatewayHandler&quot;</span>,<br>            <span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>)),<br>    SESSION_HANDLER(<span class="hljs-keyword">new</span> <span class="hljs-title class_">GatewayEntity</span>(<span class="hljs-string">&quot;ç”¨æˆ·ä¼šè¯é™æµ&quot;</span>, <span class="hljs-string">&quot;com.dong.demo.design.chain.impl.SessionGatewayHandler&quot;</span>,<br>            <span class="hljs-number">3</span>, <span class="hljs-number">2</span>, <span class="hljs-literal">null</span>));<br><br>    <span class="hljs-keyword">private</span> GatewayEntity gatewayEntity;<br><br>    GatewayEnum(GatewayEntity gatewayEntity)&#123;<br>        <span class="hljs-built_in">this</span>.gatewayEntity = gatewayEntity;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> GatewayEntity <span class="hljs-title function_">getGatewayEntity</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> gatewayEntity;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="3"><li>ä¸€ä¸ªæ¥å£ï¼Œè·å–ç¬¬ä¸€ä¸ª <code>GatewayEntity</code> å’ŒæŒ‡å®šçš„ <code>GatewayEntity</code></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">GatewayEntityService</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * æ ¹æ® handlerId è·å–é…ç½®é¡¹</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> handlerId</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    GatewayEntity <span class="hljs-title function_">getGatewayEntity</span><span class="hljs-params">(Integer handlerId)</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * è·å–ç¬¬ä¸€ä¸ª handler</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    GatewayEntity <span class="hljs-title function_">getFirstGatewayEntity</span><span class="hljs-params">()</span>;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GatewayEntityServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">GatewayService</span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Map&lt;Integer, GatewayEntity&gt; gatewayEntityMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>    <span class="hljs-keyword">static</span> &#123;<br>        GatewayEnum[] values = GatewayEnum.values();<br>        <span class="hljs-keyword">for</span> (GatewayEnum value : values) &#123;<br>            <span class="hljs-type">GatewayEntity</span> <span class="hljs-variable">gatewayEntity</span> <span class="hljs-operator">=</span> value.getGatewayEntity();<br>            gatewayEntityMap.put(gatewayEntity.getHandlerId(), gatewayEntity);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> GatewayEntity <span class="hljs-title function_">getGatewayEntity</span><span class="hljs-params">(Integer handlerId)</span> &#123;<br>        <span class="hljs-keyword">return</span> gatewayEntityMap.get(handlerId);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> GatewayEntity <span class="hljs-title function_">getFirstGatewayEntity</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">for</span> (Map.Entry&lt;Integer, GatewayEntity&gt; entity : gatewayEntityMap.entrySet()) &#123;<br>            <span class="hljs-type">GatewayEntity</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> entity.getValue();<br>            <span class="hljs-keyword">if</span> (value.getPreHandlerId() == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> value;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <br>&#125;<br></code></pre></td></tr></table></figure><ol start="4"><li>ä¸€ä¸ªå·¥å‚ç±»ï¼Œè·å–ç¬¬ä¸€ä¸ª <code>handler</code> å¹¶æŠŠå…¶ä»–çš„ <code>handler</code> ä¸²è”èµ·æ¥</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GatewayHandlerEnumFactory</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">GatewayEntityService</span> <span class="hljs-variable">gatewayService</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GatewayEntityServiceImpl</span>();<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * è·å–ç¬¬ä¸€ä¸ª handler</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> GatewayHandler <span class="hljs-title function_">getFirstGatewayHandler</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-type">GatewayEntity</span> <span class="hljs-variable">firstGatewayEntity</span> <span class="hljs-operator">=</span> gatewayService.getFirstGatewayEntity();<br>        <span class="hljs-type">GatewayHandler</span> <span class="hljs-variable">firstGatewayHandler</span> <span class="hljs-operator">=</span> newGatewayHandler(firstGatewayEntity);<br>        <span class="hljs-keyword">if</span> (firstGatewayHandler == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        <span class="hljs-type">GatewayEntity</span> <span class="hljs-variable">curGatewayEntity</span> <span class="hljs-operator">=</span> firstGatewayEntity;<br>        <span class="hljs-type">GatewayHandler</span> <span class="hljs-variable">curGatewayHandler</span> <span class="hljs-operator">=</span> firstGatewayHandler;<br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">nextHandlerId</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">while</span> ((nextHandlerId = curGatewayEntity.getNextHandlerId()) != <span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-type">GatewayEntity</span> <span class="hljs-variable">gatewayEntity</span> <span class="hljs-operator">=</span> gatewayService.getGatewayEntity(nextHandlerId);<br>            <span class="hljs-type">GatewayHandler</span> <span class="hljs-variable">gatewayHandler</span> <span class="hljs-operator">=</span> newGatewayHandler(gatewayEntity);<br>            curGatewayHandler.setNext(gatewayHandler);<br>            curGatewayEntity = gatewayEntity;<br>            curGatewayHandler = gatewayHandler;<br>        &#125;<br>        <span class="hljs-keyword">return</span> firstGatewayHandler;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * åå°„å®ä¾‹åŒ–å…·ä½“çš„å¤„ç†è€…</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> gatewayEntity</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> GatewayHandler <span class="hljs-title function_">newGatewayHandler</span><span class="hljs-params">(GatewayEntity gatewayEntity)</span>&#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">className</span> <span class="hljs-operator">=</span> gatewayEntity.getConference();<br>        <span class="hljs-keyword">try</span> &#123;<br>            Class&lt;?&gt; clazz = Class.forName(className);<br>            <span class="hljs-keyword">return</span> (GatewayHandler) clazz.newInstance();<br>        &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException | InstantiationException | IllegalAccessException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="5"><li>ä¸€ä¸ªå®¢æˆ·ç«¯è¿›è¡Œæµ‹è¯•</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GatewayClient</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">GatewayHandler</span> <span class="hljs-variable">firstGatewayHandler</span> <span class="hljs-operator">=</span> GatewayHandlerEnumFactory.getFirstGatewayHandler();<br>        firstGatewayHandler.handler();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>è®¾è®¡æ¨¡å¼</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>æ¨¡ç‰ˆæ–¹æ³•æ¨¡å¼</title>
    <link href="/2024/06/25/%E6%A8%A1%E7%89%88%E6%96%B9%E6%B3%95%E6%A8%A1%E5%BC%8F/"/>
    <url>/2024/06/25/%E6%A8%A1%E7%89%88%E6%96%B9%E6%B3%95%E6%A8%A1%E5%BC%8F/</url>
    
    <content type="html"><![CDATA[<p>å®šä¹‰æ“ä½œä¸­çš„éª¨æ¶æµç¨‹ï¼Œå°†ä¸€äº›æ­¥éª¤å»¶è¿ŸåŠ è½½åˆ°å­ç±»ä¸­ï¼Œä½¿å­ç±»å¯ä»¥ä¸æ”¹å˜ç»“æ„å³å¯é‡æ–°å®šä¹‰è¯¥æµç¨‹çš„ç‰¹å®šæ­¥éª¤</p><ol><li>ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå®šä¹‰éª¨æ¶æµç¨‹</li></ol><p>ä¾‹å¦‚ä¸€ä¸ªè¯·æ±‚ç»è¿‡æµç¨‹åˆ†ä¸ºå¦‚ä¸‹æ­¥éª¤</p><ul><li>è§£æè¯·æ±‚å¤´</li><li>å°è£…æ•°æ®</li><li>è¿”å›è¯·æ±‚ä½“</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractRequestService</span> &#123;<br>    <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">resolveHead</span><span class="hljs-params">()</span>;<br>    <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">resolve</span><span class="hljs-params">()</span>;<br>    <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">resolveBody</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * æ¨¡ç‰ˆæ–¹æ³•</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">resolveRequest</span><span class="hljs-params">()</span>&#123;<br>        resolveHead();<br>        resolve();<br>        resolveBody();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="2"><li>å®ç°ç±»å®ç°çˆ¶ç±»ä¸­çš„ <code>abstract</code> æ–¹æ³•ï¼Œçˆ¶ç±»å¼•ç”¨æŒ‡å‘å­ç±»å¯¹è±¡</li></ol>]]></content>
    
    
    
    <tags>
      
      <tag>è®¾è®¡æ¨¡å¼</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ç­–ç•¥æ¨¡å¼</title>
    <link href="/2024/06/24/%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F/"/>
    <url>/2024/06/24/%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F/</url>
    
    <content type="html"><![CDATA[<p>æœ‰å¤šä¸ª <code>if...else</code> ç­‰æ¡ä»¶åˆ†æ”¯ï¼Œå¹¶ä¸”æ¯ä¸ªæ¡ä»¶åˆ†æ”¯ï¼Œå¯ä»¥å°è£…èµ·æ¥æ›¿æ¢çš„ï¼Œå¯ä»¥ä½¿ç”¨ç­–ç•¥æ¨¡å¼æ¥ä¼˜åŒ–</p><ol><li>ä¸€ä¸ªæ¥å£</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IFileStrategy</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * è¾“å…¥å“ªç§æ–‡ä»¶ç±»å‹</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    FileTypeEnum <span class="hljs-title function_">getFileType</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * å…·ä½“è§£ææ–¹æ³•</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> param</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">resolve</span><span class="hljs-params">(Object param)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="2"><li>ä¸€ä¸ªæšä¸¾ï¼ŒåŠå®ç°ç±»</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">FileTypeEnum</span> &#123;<br>    A,<br>    B,<br>    C;<br>&#125;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AFileResolve</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IFileStrategy</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">log</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(AFileResolve.class);<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> FileTypeEnum <span class="hljs-title function_">getFileType</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> FileTypeEnum.A;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">resolve</span><span class="hljs-params">(Object param)</span> &#123;<br>        log.info(<span class="hljs-string">&quot;A ç±»å‹è§£ææ–‡ä»¶ï¼Œå‚æ•°ï¼š&#123;&#125;&quot;</span>, param);<br>        <span class="hljs-comment">// A ç±»å‹è§£æ</span><br>    &#125;<br>&#125;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BFileResolve</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IFileStrategy</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">log</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(BFileResolve.class);<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> FileTypeEnum <span class="hljs-title function_">getFileType</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> FileTypeEnum.B;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">resolve</span><span class="hljs-params">(Object param)</span> &#123;<br>        log.info(<span class="hljs-string">&quot;B ç±»å‹è§£ææ–‡ä»¶ï¼Œå‚æ•°ï¼š&#123;&#125;&quot;</span>, param);<br>        <span class="hljs-comment">// B ç±»å‹è§£æ</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="3"><li>ç”¨ <code>ApplicationContextAware</code> æ¥å£ï¼ŒæŠŠç­–ç•¥åˆå§‹åŒ–åˆ° map é‡Œé¢</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StrategyUseService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ApplicationContextAware</span> &#123;<br>    <span class="hljs-keyword">private</span> Map&lt;FileTypeEnum, IFileStrategy&gt; iFileStrategyMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">resolveFile</span><span class="hljs-params">(FileTypeEnum fileTypeEnum, Object param)</span>&#123;<br>        <span class="hljs-type">IFileStrategy</span> <span class="hljs-variable">iFileStrategy</span> <span class="hljs-operator">=</span> iFileStrategyMap.get(fileTypeEnum);<br>        <span class="hljs-keyword">if</span> (iFileStrategy != <span class="hljs-literal">null</span>) &#123;<br>            iFileStrategy.resolve(param);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setApplicationContext</span><span class="hljs-params">(ApplicationContext applicationContext)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br>        Map&lt;String, IFileStrategy&gt; tempMap = applicationContext.getBeansOfType(IFileStrategy.class);<br>        tempMap.values().forEach(strategyService -&gt; iFileStrategyMap.put(strategyService.getFileType(), strategyService));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>è®¾è®¡æ¨¡å¼</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>æ¶ˆæ¯é˜Ÿåˆ—å¹‚ç­‰æ–¹æ¡ˆ</title>
    <link href="/2024/06/14/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E5%B9%82%E7%AD%89%E6%96%B9%E6%A1%88/"/>
    <url>/2024/06/14/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E5%B9%82%E7%AD%89%E6%96%B9%E6%A1%88/</url>
    
    <content type="html"><![CDATA[<blockquote><p>å¦‚æœä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—å¯¹æŸä¸ªæ¶ˆæ¯å‘é€äº†ä¸¤æ¬¡ï¼Œå¯¼è‡´å…¥åº“ä¸¤æ¡ç›¸åŒçš„æ•°æ®ï¼Œå¦‚ä½•é¿å…</p></blockquote><p>ä¹Ÿå³å¦‚ä½•ä¿è¯å¹‚ç­‰æ€§ï¼Œæ¥ä¸‹æ¥è®¨è®ºçš„å‰ææ˜¯å…¨å±€å”¯ä¸€ ID</p><h1 id="å”¯ä¸€ç´¢å¼•"><a href="#å”¯ä¸€ç´¢å¼•" class="headerlink" title="å”¯ä¸€ç´¢å¼•"></a>å”¯ä¸€ç´¢å¼•</h1><p>æœ€ç®€å•çš„æ–¹æ¡ˆï¼Œå…ˆæŸ¥ ID åœ¨æ•°æ®åº“é‡Œæœ‰æ²¡æœ‰ï¼Œå¦‚æœæ²¡æœ‰åˆ™å…¥åº“</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">vo = select(id);<br><span class="hljs-keyword">if</span> (vo == <span class="hljs-literal">null</span>)&#123;<br>  save(ä¿¡æ¯)<br>&#125;<br></code></pre></td></tr></table></figure><p>å…ˆæŸ¥è¯¢ï¼Œå†åˆ¤æ–­ï¼Œå†ä¿å­˜ï¼Œåœ¨å¤šçº¿ç¨‹çš„æƒ…å†µä¸‹ï¼Œè¿˜æ˜¯æ‹¦ä¸ä½</p><p>å¯ä»¥åœ¨æ•°æ®è¡¨ä¸­åŠ <strong>å”¯ä¸€ç´¢å¼•</strong>æ–¹æ¡ˆè§£å†³ï¼Œåœ¨æ•°æ®åº“å±‚é¢æŠ›å¼‚å¸¸ï¼Œæ¥ä¿è¯å¹‚ç­‰</p><p>å¦‚æœè¦ä¿è¯å°‘æŠ›å¼‚å¸¸ï¼Œçœ‹æ¥ä¸‹æ¥çš„æ–¹æ¡ˆ</p><h1 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h1><p>ä¸ºäº†ä¿è¯åœ¨å¹¶å‘æ¡ä»¶ä¸‹ï¼Œä¹Ÿåªæœ‰ä¸€ä¸ªè¯·æ±‚åˆ°æ•°æ®åº“ï¼Œå¯ä»¥ç”¨é”çš„æ–¹å¼</p><p>ä»¥ id ä¸º key åŠ é”ï¼Œå¦‚æœåŠ é”æˆåŠŸï¼Œåˆ™æ”¾è¡Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">flag = addRedisLock(id, è¿‡æœŸæ—¶é—´);<br><span class="hljs-keyword">if</span> (flag)&#123;<br>  save(ä¿¡æ¯)<br>&#125;<br></code></pre></td></tr></table></figure><p>å¦‚æœæ­¤æ—¶ Redis é”æˆåŠŸäº†ï¼Œä½†æ˜¯è¿˜æ²¡ saveï¼ŒRedis é‡å¯äº†ï¼Œç†è®ºä¸Šæ˜¯å¯ä»¥é‡è¯•çš„ï¼Œä½†æ˜¯ç”±äº Redis é”çš„å­˜åœ¨ï¼Œå¯¼è‡´ä¸ä¼šèµ°åˆ° save çš„é€»è¾‘</p><ul><li><p>äººå·¥ä»‹å…¥ï¼Œåˆ é™¤ Redis å¯¹åº”çš„ key</p></li><li><p>ç”±äºè®¾ç½®äº†è¿‡æœŸæ—¶é—´ï¼Œç­‰è¿‡æœŸæ—¶é—´è¿‡äº†ä¹‹åçš„è¯·æ±‚ç†è®ºä¸Šè¿˜æ˜¯å¯ä»¥æ‹¿åˆ°é”ï¼Œæ‰€ä»¥åŠ ä¸€ä¸ªé‡è¯•æœºåˆ¶</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">flag = addRedisLock(id, è¿‡æœŸæ—¶é—´, è·å–ä¸åˆ°åˆ™ç­‰å¾…);<br><span class="hljs-keyword">if</span> (flag)&#123;<br>  save(ä¿¡æ¯)<br>&#125;<br></code></pre></td></tr></table></figure><p>ç”±äºæœ‰é”ç­‰å¾…çš„é€»è¾‘ï¼Œå¦‚æœä¸¤ä¸ªè¯·æ±‚è¿‡æ¥ï¼Œè¿˜æ˜¯æœ‰å¯èƒ½éƒ½æ”¾åˆ° Redis é‡Œï¼Œsave æ–¹æ³•è¿˜æ˜¯ä¼šèµ°ä¸¤éï¼Œæ‰€ä»¥è¿˜éœ€è¦åŠ ä¸€ä¸ªæŸ¥è¯¢æ•°æ®åº“çš„é€»è¾‘</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java">flag = addRedisLock(id, è¿‡æœŸæ—¶é—´, è·å–ä¸åˆ°åˆ™ç­‰å¾…);<br><span class="hljs-keyword">if</span> (flag)&#123;<br>  vo = select(id);<br>  <span class="hljs-keyword">if</span> (vo == <span class="hljs-literal">null</span>)&#123;<br>    save(ä¿¡æ¯);<br>  &#125;<br>&#125;<span class="hljs-keyword">else</span> &#123;<br>  <span class="hljs-comment">// ç­‰å¾…ç»“æŸåè¿˜æ˜¯æœªè·å–åˆ°é”ï¼Œå‘é€é¢„è­¦</span><br>  monitor(é¢„è­¦ä¿¡æ¯);<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL</h1><p>æœ€å¼€å§‹åŠ å”¯ä¸€ç´¢å¼•éœ€æ±‚æ˜¯æ ¹æ®ä¸šåŠ¡è¡¨æ¥åšçš„ï¼Œå¦‚æœå‡ºç°é—®é¢˜å°±è®©å®ƒæŠ›å‡ºä¸»é”®å¼‚å¸¸</p><p>å¦‚ä½•è®¾è®¡ä¸€ä¸ªé€šç”¨æŠ€æœ¯ç»„ä»¶ï¼Œä¸ä¾èµ–äºä¸šåŠ¡åœºæ™¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">vo = select <span class="hljs-keyword">for</span> <span class="hljs-title function_">update</span><span class="hljs-params">(id)</span>;<br><span class="hljs-keyword">if</span> (vo == <span class="hljs-literal">null</span>)&#123;<br>  save(message);<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¹Ÿæ˜¯åŠ é”ï¼Œä½†æ˜¯è¿™æ ·æ€§èƒ½å°±å¤ªå·®äº†</p><p>è®¾è®¡ä¸€ä¸ª <code>æ¶ˆæ¯æ¶ˆè´¹è®°å½•è¡¨</code> ä¸“é—¨ä¸ºäº†è§£å†³å¹‚ç­‰é—®é¢˜è€Œå­˜åœ¨çš„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (ä¿å­˜æ•°æ®åˆ°æ¶ˆæ¯æ¶ˆè´¹è®°å½•è¡¨)&#123; <span class="hljs-comment">// å‡ºç°ä¸»é”®å†²çªå°±è¿”å› false</span><br>  save(message);<br>&#125;<br></code></pre></td></tr></table></figure><p>å…ˆåˆ¤æ–­ï¼Œå†ä¿å­˜ï¼ŒéåŸå­æ€§ï¼Œå¤šçº¿ç¨‹æƒ…å†µä¸‹ä¹Ÿä¸è¡Œ</p><p>åŠ å…¥äº‹åŠ¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">begin transaction;<br><span class="hljs-keyword">if</span> (ä¿å­˜æ•°æ®åˆ°æ¶ˆæ¯æ¶ˆè´¹è®°å½•è¡¨)&#123; <span class="hljs-comment">// å‡ºç°ä¸»é”®å†²çªå°±è¿”å› false</span><br>  save(message);<br>&#125;<br>end transaction;<br></code></pre></td></tr></table></figure><p>ä¸€èˆ¬æ¥è¯´ï¼Œèƒ½ä¸ç”¨äº‹åŠ¡å°±ä¸ä½¿ç”¨äº‹åŠ¡ï¼Œé€šè¿‡æœ€ç»ˆä¸€è‡´æ€§æ¥ä¿è¯æ•°æ®å®Œæ•´æ€§</p><p>æ‰€ä»¥å¯ä»¥åœ¨ <code>æ¶ˆè´¹è®°å½•è¡¨</code> ä¸­åŠ ä¸€ä¸ªçŠ¶æ€å­—æ®µï¼ŒçŠ¶æ€æœ‰ä¸¤ä¸ªå–å€¼ï¼šæ¶ˆè´¹ä¸­ï¼Œæ¶ˆè´¹å®Œæˆ</p><p>åŒæ—¶æŠŠå”¯ä¸€ç´¢å¼•æ”¹æˆ <code>æ¶ˆæ¯å”¯ä¸€æ ‡è¯† + çŠ¶æ€</code></p><p>é¦–å…ˆ MQ å‘èµ·è¯·æ±‚ï¼Œæ•°æ®å¾€æ¶ˆè´¹è®°å½•è¡¨ä¸­æ’å…¥ï¼ŒçŠ¶æ€æ˜¯â€œæ¶ˆè´¹ä¸­â€<br>å¦‚æœæ’å…¥æˆåŠŸï¼Œè¯´æ˜ç¬¬ä¸€æ¬¡æ¶ˆè´¹ï¼Œè¿›å…¥åˆ°ä¸šåŠ¡é€»è¾‘ä¸­</p><ul><li>å¦‚æœä¸šåŠ¡é€»è¾‘æ‰§è¡ŒæˆåŠŸï¼Œåˆ™æ›´æ–°æ¶ˆè´¹è®°å½•è¡¨å¯¹åº”æ•°æ®ä¸ºâ€œæ¶ˆè´¹å®Œæˆâ€</li><li>å¦‚æœä¸šåŠ¡æ‰§è¡Œå¤±è´¥ï¼Œåˆ é™¤æ¶ˆè´¹è®°å½•è¡¨å¯¹åº”çš„æ•°æ®ï¼ŒæŠŠæ¶ˆæ¯æ‰”å› MQï¼Œç­‰å¾…ä¸‹æ¬¡é‡è¯•<br>å¦‚æœæ’å…¥å¤±è´¥ï¼Œè¯´æ˜é‡å¤æ¶ˆè´¹ï¼Œç›´æ¥ä¸¢å¼ƒ</li></ul><p><img src="https://gitee.com/AWallFlower/picture/raw/master/img/20240630134342.png"></p><p>å…¶å®æ’å…¥å¤±è´¥è¿™é‡Œè¿˜åº”è¯¥åˆ¤æ–­çŠ¶æ€æ˜¯å¦æ˜¯æ¶ˆè´¹æˆåŠŸçš„ï¼Œå¦‚æœæ˜¯æ¶ˆè´¹æˆåŠŸçš„ï¼Œæ‰åº”è¯¥ä¸¢å¼ƒ</p><p><img src="https://gitee.com/AWallFlower/picture/raw/master/img/20240630134704.png"></p>]]></content>
    
    
    
    <tags>
      
      <tag>æ¶ˆæ¯é˜Ÿåˆ—</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Redission tryLock</title>
    <link href="/2024/05/28/Redission-tryLock/"/>
    <url>/2024/05/28/Redission-tryLock/</url>
    
    <content type="html"><![CDATA[<h1 id="Redisson-çš„-tryLock"><a href="#Redisson-çš„-tryLock" class="headerlink" title="Redisson çš„ tryLock"></a>Redisson çš„ tryLock</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">boolean</span> <span class="hljs-title function_">tryLock</span><span class="hljs-params">(<span class="hljs-type">long</span> waitTime, <span class="hljs-type">long</span> leaseTime, TimeUnit unit)</span><br></code></pre></td></tr></table></figure><p>åœ¨ waitTime æ—¶é—´èŒƒå›´å†…å°è¯•è·å–é”, å¦‚æœè·å–åˆ°é”, è®¾ç½®è¿‡æœŸæ—¶é—´ leaseTime</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedissonLock</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">RedissonBaseLock</span> &#123;<br>    <span class="hljs-comment">// åœ¨waitTimeæ—¶é—´èŒƒå›´å†…å°è¯•è·å–é”ï¼Œå¦‚æœè·å–åˆ°é”ï¼Œåˆ™è®¾ç½®é”è¿‡æœŸæ—¶é—´leaseTime</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryLock</span><span class="hljs-params">(<span class="hljs-type">long</span> waitTime, <span class="hljs-type">long</span> leaseTime, TimeUnit unit)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-type">long</span> <span class="hljs-variable">time</span> <span class="hljs-operator">=</span> unit.toMillis(waitTime);<br>        <span class="hljs-type">long</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br>        <span class="hljs-type">long</span> <span class="hljs-variable">threadId</span> <span class="hljs-operator">=</span> Thread.currentThread().getId();<br>        <span class="hljs-comment">// ç¬¬ä¸€æ­¥ï¼šå°è¯•è·å–é”</span><br>        <span class="hljs-type">Long</span> <span class="hljs-variable">ttl</span> <span class="hljs-operator">=</span> tryAcquire(waitTime, leaseTime, unit, threadId);<br>        <span class="hljs-comment">// ttlä¸ºç©ºè¯´æ˜è·å–åˆ°äº†é”</span><br>        <span class="hljs-keyword">if</span> (ttl == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br>        <br>        <span class="hljs-comment">// åˆ¤æ–­å°è¯•è·å–é”æ˜¯å¦è¶…è¿‡waitTime</span><br>        time -= System.currentTimeMillis() - current;<br>        <span class="hljs-keyword">if</span> (time &lt;= <span class="hljs-number">0</span>) &#123;<br>            acquireFailed(waitTime, unit, threadId);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>        <br>        <span class="hljs-comment">// ç¬¬äºŒæ­¥ï¼šè®¢é˜…è§£é”æ¶ˆæ¯é€šçŸ¥</span><br>        current = System.currentTimeMillis();<br>        <span class="hljs-comment">// è®¢é˜…é”é‡Šæ”¾</span><br>        RFuture&lt;RedissonLockEntry&gt; subscribeFuture = subscribe(threadId);<br>        <span class="hljs-comment">// ç­‰å¾…é”é‡Šæ”¾æ¶ˆæ¯ï¼Œç­‰å¾…æ—¶é—´è¶…è¿‡waitTimeï¼Œè·å–é”å¤±è´¥</span><br>        <span class="hljs-keyword">if</span> (!subscribeFuture.await(time, TimeUnit.MILLISECONDS)) &#123;<br>            <span class="hljs-comment">// å¦‚æœè®¢é˜…è§£é”Futureåœ¨æ‰§è¡Œä¸­ï¼Œç­‰ä»»åŠ¡æ‰§è¡Œå®Œåå–æ¶ˆè®¢é˜…é”é‡Šæ”¾</span><br>            <span class="hljs-keyword">if</span> (!subscribeFuture.cancel(<span class="hljs-literal">false</span>)) &#123;<br>                subscribeFuture.onComplete((res, e) -&gt; &#123;<br>                    <span class="hljs-keyword">if</span> (e == <span class="hljs-literal">null</span>) &#123;<br>                        <span class="hljs-comment">// å–æ¶ˆè®¢é˜…è§£é”é€šçŸ¥</span><br>                        unsubscribe(subscribeFuture, threadId);<br>                    &#125;<br>                &#125;);<br>            &#125;<br>            acquireFailed(waitTime, unit, threadId);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// åˆ¤æ–­å°è¯•è·å–é”æ˜¯å¦è¶…è¿‡waitTime</span><br>            time -= System.currentTimeMillis() - current;<br>            <span class="hljs-keyword">if</span> (time &lt;= <span class="hljs-number">0</span>) &#123;<br>                acquireFailed(waitTime, unit, threadId);<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>            &#125;<br>        <br>            <span class="hljs-comment">// ç¬¬ä¸‰æ­¥ï¼šè‡ªæ—‹å°è¯•è·å–é”</span><br>            <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>                <span class="hljs-type">long</span> <span class="hljs-variable">currentTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br>                <span class="hljs-comment">// 1ã€å°è¯•è·å–é”(ä¸‹æ–‡ä¼šè¯¦ç»†è§£ææ­¤æ–¹æ³•)</span><br>                ttl = tryAcquire(waitTime, leaseTime, unit, threadId);<br>                <span class="hljs-comment">// ttlä¸ºç©ºè¯´æ˜è·å–åˆ°äº†é”</span><br>                <span class="hljs-keyword">if</span> (ttl == <span class="hljs-literal">null</span>) &#123;<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>                &#125;<br><br>                <span class="hljs-comment">// åˆ¤æ–­å°è¯•è·å–é”æ˜¯å¦è¶…è¿‡waitTime</span><br>                time -= System.currentTimeMillis() - currentTime;<br>                <span class="hljs-keyword">if</span> (time &lt;= <span class="hljs-number">0</span>) &#123;<br>                    acquireFailed(waitTime, unit, threadId);<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>                &#125;<br><br>                <span class="hljs-comment">// ç­‰å¾…é”é‡Šæ”¾ï¼ˆä¿¡å·é‡æ§åˆ¶ï¼‰</span><br>                currentTime = System.currentTimeMillis();<br>                <span class="hljs-keyword">if</span> (ttl &gt;= <span class="hljs-number">0</span> &amp;&amp; ttl &lt; time) &#123;<br>                    <span class="hljs-comment">// å°è¯•è·å–ä¿¡å·é‡</span><br>                    subscribeFuture.getNow().getLatch().tryAcquire(ttl, TimeUnit.MILLISECONDS);<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    subscribeFuture.getNow().getLatch().tryAcquire(time, TimeUnit.MILLISECONDS);<br>                &#125;<br><br>                <span class="hljs-comment">// åˆ¤æ–­å°è¯•è·å–é”æ˜¯å¦è¶…è¿‡waitTime</span><br>                time -= System.currentTimeMillis() - currentTime;<br>                <span class="hljs-keyword">if</span> (time &lt;= <span class="hljs-number">0</span>) &#123;<br>                    acquireFailed(waitTime, unit, threadId);<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>                &#125;<br>            &#125;<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-comment">// ç¬¬å››æ­¥ï¼šå–æ¶ˆè§£é”è®¢é˜…</span><br>            unsubscribe(subscribeFuture, threadId);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸»è¦åˆ†ä¸ºä»¥ä¸‹å››æ­¥</p><ul><li>tryAcquire å°è¯•è·å–é”, è·å–åˆ°è¿”å› true</li><li>è·å–ä¸åˆ°è¯´æ˜é”è¢«å ç”¨äº†, è®¢é˜…ç»“æœæ¶ˆæ¯é€šçŸ¥</li><li>æ”¶åˆ°æ¶ˆæ¯è§£é”é€šçŸ¥, è‡ªæ—‹è·å–é”, ç›´åˆ° waitTime è·å–é”å¤±è´¥</li><li>ä¸è®ºæ˜¯å¦è·å–é”æˆåŠŸ, å–æ¶ˆè§£é”æ¶ˆæ¯è®¢é˜…</li></ul><p>tryAcquire æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> Long <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">(<span class="hljs-type">long</span> waitTime, <span class="hljs-type">long</span> leaseTime, TimeUnit unit, <span class="hljs-type">long</span> threadId)</span> &#123;<br>    <span class="hljs-keyword">return</span> get(tryAcquireAsync(waitTime, leaseTime, unit, threadId));<br>&#125;<br><br><span class="hljs-keyword">private</span> &lt;T&gt; RFuture&lt;Long&gt; <span class="hljs-title function_">tryAcquireAsync</span><span class="hljs-params">(<span class="hljs-type">long</span> waitTime, <span class="hljs-type">long</span> leaseTime, TimeUnit unit, <span class="hljs-type">long</span> threadId)</span> &#123;<br>    RFuture&lt;Long&gt; ttlRemainingFuture;<br>    <span class="hljs-keyword">if</span> (leaseTime != -<span class="hljs-number">1</span>) &#123;<br>        ttlRemainingFuture = tryLockInnerAsync(waitTime, leaseTime, unit, threadId, RedisCommands.EVAL_LONG);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯leaseTime == -1ï¼Œä¼šè§¦å‘redissonçœ‹é—¨ç‹—æœºåˆ¶</span><br>        ttlRemainingFuture = tryLockInnerAsync(waitTime, internalLockLeaseTime,<br>                TimeUnit.MILLISECONDS, threadId, RedisCommands.EVAL_LONG);<br>    &#125;<br>    ttlRemainingFuture.onComplete((ttlRemaining, e) -&gt; &#123;<br>        <span class="hljs-keyword">if</span> (e != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br><br>        <span class="hljs-comment">// è·å–é”æˆåŠŸ</span><br>        <span class="hljs-keyword">if</span> (ttlRemaining == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">if</span> (leaseTime != -<span class="hljs-number">1</span>) &#123;<br>                internalLockLeaseTime = unit.toMillis(leaseTime);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">// é”è‡ªåŠ¨ç»­æ—¶ï¼ˆçœ‹é—¨ç‹—æœºåˆ¶ï¼‰è§¦å‘æ¡ä»¶leaseTime == -1</span><br>                scheduleExpirationRenewal(threadId);<br>            &#125;<br>        &#125;<br>    &#125;);<br>    <span class="hljs-keyword">return</span> ttlRemainingFuture;<br>&#125;<br></code></pre></td></tr></table></figure><p>tryLockInnerAsync é‡Œé¢æ˜¯å°è¯•è·å–åˆ†å¸ƒå¼é”çš„ lua è„šæœ¬<br>scheduleExpirationRenewal é”è‡ªåŠ¨ç»­æ—¶, çœ‹é—¨ç‹—æœºåˆ¶</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;T&gt; RFuture&lt;T&gt; <span class="hljs-title function_">tryLockInnerAsync</span><span class="hljs-params">(<span class="hljs-type">long</span> waitTime, <span class="hljs-type">long</span> leaseTime, TimeUnit unit, <span class="hljs-type">long</span> threadId, RedisStrictCommand&lt;T&gt; command)</span> &#123;<br>    <span class="hljs-keyword">return</span> evalWriteAsync(getRawName(), LongCodec.INSTANCE, command,<br>            <span class="hljs-comment">// å¦‚æœkeyä¸€å¼€å§‹å°±ä¸å­˜åœ¨ï¼Œåˆ™ç›´æ¥åˆ›å»ºä¸€ä¸ªkey</span><br>            <span class="hljs-string">&quot;if (redis.call(&#x27;exists&#x27;, KEYS[1]) == 0) then &quot;</span> +<br>                    <span class="hljs-string">&quot;redis.call(&#x27;hincrby&#x27;, KEYS[1], ARGV[2], 1); &quot;</span> +<br>                    <span class="hljs-string">&quot;redis.call(&#x27;pexpire&#x27;, KEYS[1], ARGV[1]); &quot;</span> +<br>                    <span class="hljs-string">&quot;return nil; &quot;</span> +<br>                    <span class="hljs-string">&quot;end; &quot;</span> +<br>                    <span class="hljs-comment">// è¿™é‡Œæ˜¯é‡å…¥é”çš„å®ç°ï¼ŒåŒä¸€ä¸ªçº¿ç¨‹å¤šæ¬¡è·å–é”åªéœ€è¦åœ¨valueåŠ 1å³å¯ï¼Œvalueç›¸å½“äºä¸€ä¸ªåŠ é”è®¡æ•°å™¨</span><br>                    <span class="hljs-string">&quot;if (redis.call(&#x27;hexists&#x27;, KEYS[1], ARGV[2]) == 1) then &quot;</span> +<br>                    <span class="hljs-string">&quot;redis.call(&#x27;hincrby&#x27;, KEYS[1], ARGV[2], 1); &quot;</span> +<br>                    <span class="hljs-string">&quot;redis.call(&#x27;pexpire&#x27;, KEYS[1], ARGV[1]); &quot;</span> +<br>                    <span class="hljs-string">&quot;return nil; &quot;</span> +<br>                    <span class="hljs-string">&quot;end; &quot;</span> +<br>                    <span class="hljs-comment">// æœ‰å…¶ä»–çº¿ç¨‹æŒæœ‰é”ï¼ŒåŠ é”å¤±è´¥ï¼Œè¿”å›é”è¿‡æœŸæ—¶é—´</span><br>                    <span class="hljs-string">&quot;return redis.call(&#x27;pttl&#x27;, KEYS[1]);&quot;</span>,<br>            Collections.singletonList(getRawName()), unit.toMillis(leaseTime), getLockName(threadId));<br>&#125;<br></code></pre></td></tr></table></figure><ol><li>åŠ é”çš„ key ä¸å­˜åœ¨å°±åˆ›å»ºä¸€ä¸ª redis hash key, field(å½“å‰çº¿ç¨‹ id), value(åŠ é”æ¬¡æ•°)</li><li>æœ‰çº¿ç¨‹æŒæœ‰é”å¹¶ä¸”æœªè§£é”, å…¶ä»–çº¿ç¨‹æ— æ³•è·å–åˆ°é”</li><li>åŠ é”æˆåŠŸè¿”å› null, åŠ é”å¤±è´¥è¿”å›è¿‡æœŸæ—¶é—´</li></ol><p>é”è¿‡æœŸæ—¶é—´è‡ªåŠ¨ç»­è´¹</p><ol><li>é”è¿‡æœŸè‡ªåŠ¨ç»­è´¹çš„è§¦å‘æ¡ä»¶ä¸º tryLock è®¾ç½®çš„é”åˆ°æœŸæ—¶é—´ä¸º-1</li><li>è‡ªåŠ¨ç»­è´¹çš„åŸç†æ˜¯åˆ›å»ºä¸€ä¸ªå®šæ—¶ä»»åŠ¡, æ¯ internalLockLeaseTime &#x2F; 3 æ—¶è§¦å‘ä¸€æ¬¡, å¦‚æœå‘ç°æŒæœ‰é”æœªé‡Šæ”¾, æŠŠé”è¿‡æœŸæ—¶é—´æ›´æ–°ä¸º internalLockLeaseTime(é»˜è®¤ä¸º 30s)</li><li>é”è¿‡æœŸæ—¶é—´æ›´æ–°å, å†æ¬¡é€’å½’è°ƒç”¨ renewExpiration åˆ›å»ºä¸‹ä¸€æ¬¡å®šæ—¶ä»»åŠ¡</li></ol><p>å‰é¢ tryLock æ–¹æ³•çš„è®¢é˜…è§£é”æ¶ˆæ¯é€šçŸ¥æ˜¯åœ¨ unlock çš„æ—¶å€™å‘èµ·çš„<br>unlockAsync æ–¹æ³•å†…éƒ¨è°ƒç”¨ lua è„šæœ¬, è°ƒç”¨ publish æ¨é€è§£é”æ¶ˆæ¯</p><p>Redis çš„ publish</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs redis">publish channel message<br></code></pre></td></tr></table></figure><ul><li>channel æŒ‡å®šè¦å‘å¸ƒæ¶ˆæ¯çš„é¢‘é“</li><li>message è¦å‘å¸ƒçš„æ¶ˆæ¯å†…å®¹<br>åœ¨ tryLock å’Œ unLock ä¸­, ä»–ä»¬çš„ channel æ˜¯çº¿ç¨‹ id</li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>æºç </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Spring</title>
    <link href="/2024/05/28/Spring/"/>
    <url>/2024/05/28/Spring/</url>
    
    <content type="html"><![CDATA[<h1 id="Spring"><a href="#Spring" class="headerlink" title="Spring"></a>Spring</h1><h2 id="Bean-çš„ç”Ÿå‘½å‘¨æœŸ"><a href="#Bean-çš„ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="Bean çš„ç”Ÿå‘½å‘¨æœŸ"></a>Bean çš„ç”Ÿå‘½å‘¨æœŸ</h2><ul><li>é€šè¿‡ BeanDefinition è·å– Bean çš„å®šä¹‰ä¿¡æ¯</li><li>é€šè¿‡æ„é€ å‡½æ•°å®ä¾‹åŒ– Bean</li><li>Bean çš„ä¾èµ–æ³¨å…¥</li><li>å¤„ç† Aware æ¥å£</li><li>BeanPostProcessor - å‰ç½®æ–¹æ³•</li><li>åˆå§‹åŒ–æ–¹æ³•(InitializingBean, init-method)</li><li>BeanPostProcessor - åç½®æ–¹æ³•</li><li>é”€æ¯ Bean</li></ul><p>BeanDefinition æ˜¯ Spring å®¹å™¨åœ¨è¿›è¡Œå®ä¾‹åŒ–æ—¶, ä¼šå°† xml é…ç½®çš„ <code>&lt;bean&gt;</code> ä¿¡æ¯å°è£…æˆä¸€ä¸ª BeanDefinition å¯¹è±¡, Spring æ ¹æ®å®ƒæ¥åˆ›å»º Bean å¯¹è±¡<br><img src="https://gitee.com/AWallFlower/picture/raw/master/img/20240305171200.png" alt="image.png"></p><h2 id="Aware-æ¥å£æœ‰ä»€ä¹ˆç”¨"><a href="#Aware-æ¥å£æœ‰ä»€ä¹ˆç”¨" class="headerlink" title="Aware æ¥å£æœ‰ä»€ä¹ˆç”¨"></a>Aware æ¥å£æœ‰ä»€ä¹ˆç”¨</h2><ul><li>é€šè¿‡å®ç°ç‰¹å®šçš„ Aware æ¥å£, bean å¯ä»¥è·å¾—å¯¹ Spring å®¹å™¨çš„æŸäº›éƒ¨åˆ†(å¦‚é…ç½®æ–‡ä»¶, æ–‡ä»¶èµ„æº, ç¯å¢ƒå±æ€§ç­‰) çš„è®¿é—®æƒ</li><li>ApplicationContextAware: å…è®¸ä¸€ä¸ª bean è·å¾—å¯¹ ApplicationContext çš„è®¿é—®, æ„å‘³ç€è¯¥ bean å¯ä»¥è®¿é—® Spring å®¹å™¨çš„æ‰€æœ‰é…ç½®ä¿¡æ¯çš„å®šä¹‰</li><li>BeanNameAware: å®ƒä¼šåœ¨åˆ›å»ºè¿‡ç¨‹ä¸­æ¥æ”¶åˆ°è‡ªå·±åœ¨å®¹å™¨ä¸­çš„åç§°</li><li>BeanFactoryAware: Bean å¯ä»¥ç›´æ¥è®¿é—®åˆ°å®ƒæ‰€åœ¨çš„ BeanFactory, ä»è€Œå…è®¸è¯·æ±‚å…¶ä»– Bean ç­‰æ“ä½œ</li><li>å®ç°è¿™äº›æ¥å£å¯ä»¥è®©ä¸æ˜¯åœ¨ Spring çš„ç¯å¢ƒä¸‹, è·å– Spring çš„ Bean, ä¾‹å¦‚é€šè¿‡ BeanFactory</li></ul><h2 id="InitializingBean-æœ‰ä»€ä¹ˆä½œç”¨"><a href="#InitializingBean-æœ‰ä»€ä¹ˆä½œç”¨" class="headerlink" title="InitializingBean æœ‰ä»€ä¹ˆä½œç”¨"></a>InitializingBean æœ‰ä»€ä¹ˆä½œç”¨</h2><ul><li>ç”¨äºåœ¨åˆå§‹åŒ–æ–¹æ³•å®Œæˆåæ‰§è¡Œè‡ªå®šä¹‰åˆå§‹åŒ–é€»è¾‘</li><li>å½“ä¸€ä¸ª Bean å®ç°äº† InitializingBean æ¥å£æ—¶, Spring å®¹å™¨åœ¨åˆå§‹åŒ–Bean å¹¶å®Œæˆæ‰€æœ‰å±æ€§è®¾ç½®åä¼šè°ƒç”¨ <code>afterPropertiesSet()</code> æ–¹æ³•æ¥æ‰§è¡Œé¢å¤–åˆå§‹åŒ–æ“ä½œ</li></ul><h2 id="Spring-å‡ºç°å¾ªç¯ä¾èµ–"><a href="#Spring-å‡ºç°å¾ªç¯ä¾èµ–" class="headerlink" title="Spring å‡ºç°å¾ªç¯ä¾èµ–"></a>Spring å‡ºç°å¾ªç¯ä¾èµ–</h2><ul><li>å¾ªç¯ä¾èµ–æ˜¯æŒ‡ä¸¤ä¸ªæˆ–å¤šä¸ª Bean ç›¸äº’ä¾èµ–, A ä¾èµ–äº B, B ä¾èµ–äº A</li></ul><h3 id="æ„é€ å™¨æ³¨å…¥å¾ªç¯ä¾èµ–èƒ½è§£å†³å—"><a href="#æ„é€ å™¨æ³¨å…¥å¾ªç¯ä¾èµ–èƒ½è§£å†³å—" class="headerlink" title="æ„é€ å™¨æ³¨å…¥å¾ªç¯ä¾èµ–èƒ½è§£å†³å—"></a>æ„é€ å™¨æ³¨å…¥å¾ªç¯ä¾èµ–èƒ½è§£å†³å—</h3><ul><li>å¦‚æœ A å’Œ B éƒ½ç”¨æ„é€ å™¨æ³¨å…¥ä¸è¡Œ, å› ä¸ºåœ¨åˆ›å»º Bean å®ä¾‹æ—¶éœ€è¦è°ƒç”¨æ„é€ å‡½æ•°åˆ›å»º Bean</li><li>ä½†æ˜¯ä¸€ä¸ªä½¿ç”¨ Setter æ³¨å…¥, ä¸€ä¸ªä½¿ç”¨æ„é€ å™¨æ³¨å…¥éœ€è¦åˆ†æƒ…å†µè€ƒè™‘<ul><li>A ç”¨ Setter æ³¨å…¥ B, B ç”¨æ„é€ å™¨æ³¨å…¥ A, å¯ä»¥è§£å†³å¾ªç¯ä¾èµ–</li><li>A ç”¨æ„é€ å™¨æ³¨å…¥ B, B ç”¨ Setter æ³¨å…¥ A, ä¸å¯ä»¥è§£å†³</li><li>å› ä¸º Spring åœ¨åˆ›å»º Bean çš„æ—¶å€™é»˜è®¤æ˜¯æŒ‰ç…§è‡ªç„¶æ’åºè¿›è¡Œåˆ›å»º, A ä¼šä¼˜å…ˆäº B åˆ›å»º</li></ul></li></ul><h2 id="Spring-åˆ›å»º-Bean-ç®€å•çš„ä¸‰æ­¥"><a href="#Spring-åˆ›å»º-Bean-ç®€å•çš„ä¸‰æ­¥" class="headerlink" title="Spring åˆ›å»º Bean ç®€å•çš„ä¸‰æ­¥"></a>Spring åˆ›å»º Bean ç®€å•çš„ä¸‰æ­¥</h2><ul><li>å®ä¾‹åŒ–: å¯¹åº”æ–¹æ³• <code>AbstractAutowireCapableBeanFactory</code> çš„ <code>createBeanInstance</code> æ–¹æ³•</li><li>å±æ€§æ³¨å…¥: å¯¹åº”æ–¹æ³• <code>AbstractAutowireCapableBeanFactory</code> çš„ <code>populateBean</code> æ–¹æ³•</li><li>åˆå§‹åŒ–: å¯¹åº”æ–¹æ³• <code>AbstractAutowireCapableBeanFactory</code> çš„ <code>initializeBean</code><br>å…¶å®å°±æ˜¯</li><li>å®ä¾‹åŒ–, new äº†ä¸€ä¸ªå¯¹è±¡</li><li>å±æ€§æ³¨å…¥: ä¸º new çš„å¯¹è±¡å¡«å……å±æ€§</li><li>åˆå§‹åŒ–: æ‰§è¡Œ aware æ¥å£ä¸­çš„æ–¹æ³•, å®Œæˆ AOP ä»£ç†</li></ul><h2 id="Spring-ä¸‰çº§ç¼“å­˜"><a href="#Spring-ä¸‰çº§ç¼“å­˜" class="headerlink" title="Spring ä¸‰çº§ç¼“å­˜"></a>Spring ä¸‰çº§ç¼“å­˜</h2><ul><li><code>singletonObjects</code> ä¸€çº§ç¼“å­˜: å­˜å‚¨åˆ›å»ºå¥½çš„å•ä¾‹ Bean</li><li><code>earlySingletonObjects</code> äºŒçº§ç¼“å­˜: å®Œæˆå®ä¾‹åŒ–, è¿˜æœªè¿›è¡Œå±æ€§æ³¨å…¥åŠåˆå§‹åŒ–çš„å¯¹è±¡</li><li><code>singletonFactories</code> ä¸‰çº§ç¼“å­˜: æå‰æš´éœ²ä¸€ä¸ªå•ä¾‹å·¥å‚, äºŒçº§ç¼“å­˜ä¸­å­˜å‚¨çš„å°±æ˜¯ä»è¿™ä¸ªå·¥å‚ä¸­è·å–çš„å¯¹è±¡</li></ul><h2 id="SpringMVC-çš„æ‰§è¡Œæµç¨‹"><a href="#SpringMVC-çš„æ‰§è¡Œæµç¨‹" class="headerlink" title="SpringMVC çš„æ‰§è¡Œæµç¨‹"></a>SpringMVC çš„æ‰§è¡Œæµç¨‹</h2><ul><li>ç”¨æˆ·å‘é€è¯·æ±‚åˆ°å‰ç«¯æ§åˆ¶å™¨ DispatchServlet</li><li>DispatchServlet æ”¶åˆ°è¯·æ±‚, è°ƒç”¨ HandlerMapper</li><li>HandlerMapper æ‰¾åˆ°å…·ä½“çš„å¤„ç†å™¨, ç”Ÿæˆå¤„ç†å™¨å¯¹è±¡åŠå¤„ç†å™¨æ‹¦æˆªå™¨(å¦‚æœæœ‰) ä¸€èµ·è¿”å› DispatchServlet</li><li>DispatchServlet è°ƒç”¨ HandlerAdapter(å¤„ç†å™¨é€‚é…å™¨)</li><li>HandlerAdapter è°ƒç”¨å…·ä½“çš„ Controller</li></ul><h2 id="SpringBoot-è‡ªåŠ¨è£…é…åŸç†-or-å¯åŠ¨æµç¨‹"><a href="#SpringBoot-è‡ªåŠ¨è£…é…åŸç†-or-å¯åŠ¨æµç¨‹" class="headerlink" title="SpringBoot è‡ªåŠ¨è£…é…åŸç† or å¯åŠ¨æµç¨‹"></a>SpringBoot è‡ªåŠ¨è£…é…åŸç† or å¯åŠ¨æµç¨‹</h2><ul><li>åœ¨ SpringBoot å¯åŠ¨ç±»ä¸Šæœ‰ä¸€ä¸ª <code>@SpringBootApplication</code> æ³¨è§£, å…¶ä¸­å°è£…äº†ä¸‰ä¸ªæ³¨è§£<ul><li><code>@SpringBootConfiguration</code></li><li><code>@EnableAutoConfiguration</code></li><li><code>@ComponentScan</code></li></ul></li><li>å…¶ä¸­ <code>@EnableAutoConfiguration</code> æ˜¯å®ç°è‡ªåŠ¨é…ç½®çš„æ ¸å¿ƒæ³¨è§£, è¯¥æ³¨è§£é€šè¿‡ <code>@Import</code> æ³¨è§£å¯¼å…¥å¯¹åº”çš„é…ç½®é€‰æ‹©å™¨ç±»<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Import(&#123;AutoConfigurationImportSelector.class&#125;)</span><br></code></pre></td></tr></table></figure></li><li>é…ç½®é€‰æ‹©å™¨ç±»å†…éƒ¨è¯»å–è¯¥é¡¹ç›®å’Œè¯¥é¡¹ç›®å¼•ç”¨ jar åŒ…çš„ classpath è·¯å¾„ä¸‹çš„ META-INF&#x2F;spring.factories æ–‡ä»¶, è¯¥æ–‡ä»¶é‡Œæœ‰æ‰€éœ€è¦åŠ è½½çš„ç±»çš„å…¨é™å®šç±»å, ä¼šæ ¹æ® bean çš„æ¡ä»¶æ³¨è§£å†³å®šæ˜¯å¦å°†å…¶å¯¼å…¥ Spring å®¹å™¨ä¸­<ul><li>æ¡ä»¶æ³¨è§£æœ‰åƒ <code>@ConditionalOnClass</code> è¿™æ ·çš„æ³¨è§£, è¡¨ç¤ºæœ‰å¯¹åº”çš„ class æ–‡ä»¶, æ‰åŠ è½½</li></ul></li></ul><h2 id="SpringBoot-ä¾èµ–ç®¡ç†"><a href="#SpringBoot-ä¾èµ–ç®¡ç†" class="headerlink" title="SpringBoot ä¾èµ–ç®¡ç†"></a>SpringBoot ä¾èµ–ç®¡ç†</h2><ul><li>ç»§æ‰¿äº† <code>spring-boot-starter-parent</code>  å…¶åˆç»§æ‰¿äº† <code>spring-boot-dependencies</code> å†…éƒ¨å®šä¹‰äº†å¾ˆå¤šä¾èµ–</li></ul><h2 id="spring-boot-starter-è·Ÿ-spring-boot-starter-web-æœ‰ä»€ä¹ˆåŒºåˆ«"><a href="#spring-boot-starter-è·Ÿ-spring-boot-starter-web-æœ‰ä»€ä¹ˆåŒºåˆ«" class="headerlink" title="spring-boot-starter è·Ÿ spring-boot-starter-web æœ‰ä»€ä¹ˆåŒºåˆ«"></a>spring-boot-starter è·Ÿ spring-boot-starter-web æœ‰ä»€ä¹ˆåŒºåˆ«</h2><ul><li><code>spring-boot-starter</code> æ˜¯è®¸å¤šå…¶ä»– Starter çš„åŸºç¡€ä¾èµ–, ä½†ä¸åŒ…å«ä»»ä½•ç‰¹å®šçš„åŠŸèƒ½æ¨¡å—, å®ƒåŒ…å«ä»¥ä¸‹å†…å®¹<ul><li>Spring Core</li><li>Spring Context</li><li>Spring AOP</li></ul></li><li><code>spring-boot-starter-web</code> æ˜¯ä¸“é—¨ç”¨äºæ„å»º Web åº”ç”¨çš„ Starter ä¾èµ–, èƒ½å¤„ç† HTTP è¯·æ±‚, å®ƒé‡Œé¢åŒ…å« <code>spring-boot-starter</code> <ul><li>Spring Web</li><li>Spring MVC</li><li>Jackson</li><li>Tomcat</li></ul></li></ul><h2 id="Spring-å¸¸ç”¨çš„ç±»"><a href="#Spring-å¸¸ç”¨çš„ç±»" class="headerlink" title="Spring å¸¸ç”¨çš„ç±»"></a>Spring å¸¸ç”¨çš„ç±»</h2><ul><li><code>ApplicationContext</code> Spring å®¹å™¨æ¥å£, è´Ÿè´£åˆ›å»ºå’Œç®¡ç† Spring Bean</li><li><code>BeanFactory</code> Spring å®¹å™¨, æä¾› Bean çš„åŸºç¡€ç®¡ç†</li><li><code>BeanDefinition</code> </li><li><code>InitializingBean</code></li><li>ä¸€äº› Aware æ¥å£</li></ul><h2 id="Spring-è‡ªåŠ¨æ³¨å…¥åŸç†"><a href="#Spring-è‡ªåŠ¨æ³¨å…¥åŸç†" class="headerlink" title="Spring è‡ªåŠ¨æ³¨å…¥åŸç†"></a>Spring è‡ªåŠ¨æ³¨å…¥åŸç†</h2><ul><li>ä½¿ç”¨åå°„æœºåˆ¶å°†ä¾èµ–æ³¨å…¥åˆ° Bean ä¸­<ul><li>æ„é€ å™¨æ³¨å…¥</li><li>Setter æ–¹æ³•æ³¨å…¥</li><li>å­—æ®µæ³¨å…¥</li></ul></li></ul><h2 id="get-å’Œ-post-æœ‰ä»€ä¹ˆåŒºåˆ«"><a href="#get-å’Œ-post-æœ‰ä»€ä¹ˆåŒºåˆ«" class="headerlink" title="get å’Œ post æœ‰ä»€ä¹ˆåŒºåˆ«"></a>get å’Œ post æœ‰ä»€ä¹ˆåŒºåˆ«</h2><ul><li>get å‚æ•°æ‹¼æ¥åœ¨ Url åé¢, post å‚æ•°åœ¨è¯·æ±‚ä½“é‡Œ, ç›¸å¯¹å®‰å…¨</li><li>æ•°æ®å¤§å°é™åˆ¶, get å—åˆ° Url é•¿åº¦çš„é™åˆ¶, post ç†è®ºä¸Šæ²¡æœ‰å¤§å°é™åˆ¶</li><li>å¹‚ç­‰æ€§, get æ˜¯å¹‚ç­‰çš„, post æ˜¯éå¹‚ç­‰çš„</li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>å…«è‚¡</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>LRU</title>
    <link href="/2024/05/28/%E5%8A%9B%E6%89%A3-LRU/"/>
    <url>/2024/05/28/%E5%8A%9B%E6%89%A3-LRU/</url>
    
    <content type="html"><![CDATA[<h1 id="LRU"><a href="#LRU" class="headerlink" title="LRU"></a>LRU</h1><p>LRUï¼ŒLeast Recently Usedï¼Œæœ€å°‘æœ€è¿‘ä½¿ç”¨ï¼Œæ·˜æ±°ç­–ç•¥æ˜¯æœ€ä¹…æ²¡ç”¨çš„<br>æƒ³è±¡æœ‰ä¸€æ‘ä¹¦ï¼Œç”¨çš„æ—¶å€™æŠ½å‡ºæ¥ï¼Œæ”¾åœ¨æœ€ä¸Šé¢<br>æ·˜æ±°çš„æ—¶å€™æŠŠæœ€ä¸‹é¢çš„ç§»é™¤<br>æ•´ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œæ¯æ¬¡éƒ½æ·˜æ±°æœ€åä¸€ä¸ªï¼Œæ’å…¥çš„æ—¶å€™æ’å…¥åˆ°å¤´ï¼ˆå“¨å…µåé¢ï¼‰<br><img src="https://gitee.com/AWallFlower/picture/raw/master/img/20240314221217.png" alt="image.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">LRUCache</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Node</span>&#123;<br>        <span class="hljs-type">int</span> key, value;<br>        Node pre, next;<br>        Node(<span class="hljs-type">int</span> key, <span class="hljs-type">int</span> value)&#123;<br>            <span class="hljs-built_in">this</span>.key = key;<br>            <span class="hljs-built_in">this</span>.value = value;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">Node</span> <span class="hljs-variable">dummy</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);  <span class="hljs-comment">// å“¨å…µèŠ‚ç‚¹</span><br>    <span class="hljs-comment">// å­˜å‚¨ key å’Œ Node çš„å…³ç³»ï¼Œæ–¹ä¾¿æ£€ç´¢</span><br>    <span class="hljs-keyword">private</span> Map&lt;Integer, Node&gt; key2Node = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>(); <br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> capacity;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">LRUCache</span><span class="hljs-params">(<span class="hljs-type">int</span> capacity)</span> &#123;<br>        <span class="hljs-built_in">this</span>.capacity = capacity;<br>        dummy.pre = dummy;<br>        dummy.next = dummy;<br>    &#125;<br>    <span class="hljs-comment">// ç§»é™¤æŸä¸€ä¸ªèŠ‚ç‚¹ï¼ˆæŠ½å‡ºä¸€æœ¬ä¹¦ï¼‰</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">remove</span><span class="hljs-params">(Node node)</span>&#123;<br>        node.pre.next = node.next;<br>        node.next.pre = node.pre;<br>    &#125;<br>    <span class="hljs-comment">// æŠŠèŠ‚ç‚¹æ·»åŠ åˆ°é“¾è¡¨å¤´ï¼ˆæŠŠä¸€æœ¬ä¹¦æ”¾åˆ°æœ€ä¸Šé¢ï¼‰</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">pushFront</span><span class="hljs-params">(Node node)</span>&#123;<br>        node.pre = dummy;<br>        node.next = dummy.next;<br>        node.pre.next = node;<br>        node.next.pre = node;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> Node <span class="hljs-title function_">getNode</span><span class="hljs-params">(<span class="hljs-type">int</span> key)</span>&#123;<br>        <span class="hljs-keyword">if</span> (!key2Node.containsKey(key)) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br><br>        <span class="hljs-type">Node</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> key2Node.get(key);  <span class="hljs-comment">// å¦‚æœæœ‰çš„è¯ï¼Œæœ€è¿‘ä½¿ç”¨è¿‡</span><br>        <span class="hljs-comment">// è¦æŠŠå®ƒæ”¾åˆ°æœ€ä¸Šé¢ï¼Œä¹Ÿå°±æ˜¯å…ˆç§»é™¤å†æ’å…¥</span><br>        remove(node);<br>        pushFront(node);<br>        <span class="hljs-keyword">return</span> node;<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">get</span><span class="hljs-params">(<span class="hljs-type">int</span> key)</span> &#123;<br>        <span class="hljs-type">Node</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> getNode(key);<br>        <span class="hljs-keyword">return</span> node == <span class="hljs-literal">null</span> ? -<span class="hljs-number">1</span> : node.value;<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">put</span><span class="hljs-params">(<span class="hljs-type">int</span> key, <span class="hljs-type">int</span> value)</span> &#123;<br>        <span class="hljs-type">Node</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> getNode(key);<br>        <span class="hljs-keyword">if</span> (node != <span class="hljs-literal">null</span>)&#123;  <span class="hljs-comment">// æœ‰è¿™æœ¬ä¹¦</span><br>            node.value = value;  <span class="hljs-comment">// æ›´æ–° value</span><br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        node = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>(key, value);  <span class="hljs-comment">// æ–°ä¹¦</span><br>        key2Node.put(key, node);<br>        pushFront(node);  <span class="hljs-comment">// æ”¾åˆ°æœ€ä¸Šé¢</span><br>        <span class="hljs-keyword">if</span> (key2Node.size() &gt; capacity)&#123;  <span class="hljs-comment">// æ·˜æ±°ç­–ç•¥</span><br>            <span class="hljs-type">Node</span> <span class="hljs-variable">backNode</span> <span class="hljs-operator">=</span> dummy.pre;<br>            key2Node.remove(backNode.key);<br>            remove(backNode);  <span class="hljs-comment">// ç§»é™¤æœ€åä¸€ä¸ª</span><br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>ç®—æ³•</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MySQL</title>
    <link href="/2024/05/27/MySQL/"/>
    <url>/2024/05/27/MySQL/</url>
    
    <content type="html"><![CDATA[<ul><li><h1 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL</h1><h2 id="redo-log-å’Œ-binlog-çš„åŒºåˆ«"><a href="#redo-log-å’Œ-binlog-çš„åŒºåˆ«" class="headerlink" title="redo log å’Œ binlog çš„åŒºåˆ«"></a>redo log å’Œ binlog çš„åŒºåˆ«</h2><ul><li>redo log æ˜¯ InnoDB ç‰¹æœ‰çš„, binlog æ˜¯ Server å±‚çš„æ¯ä¸ªæ•°æ®å¼•æ“éƒ½æœ‰</li><li>redo log è®°å½•çš„æ˜¯ç‰©ç†æ—¥å¿—, è®°å½•çš„æ˜¯åœ¨æŸä¸ªæ•°æ®é¡µåšçš„ä¿®æ”¹, æ¯”å¦‚â€å¯¹ xxx è¡¨ä¸­ yyy æ•°æ®é¡µ zzz åç§»é‡çš„åœ°æ–¹åäº† aaa æ›´æ–°â€ binlog æ˜¯é€»è¾‘æ—¥å¿—, è®°å½•çš„æ˜¯è¿™ä¸ªè¯­å¥çš„åŸå§‹é€»è¾‘, æ¯”å¦‚â€ç»™ id &#x3D; 2 çš„å­—æ®µ c åŠ  1â€</li><li>redo log æ˜¯å¾ªç¯å†™çš„, ç©ºé—´ä¼šç”¨å®Œ, binlog æ˜¯è¿½åŠ å†™çš„</li></ul><h2 id="èšç°‡ç´¢å¼•å’ŒäºŒçº§ç´¢å¼•"><a href="#èšç°‡ç´¢å¼•å’ŒäºŒçº§ç´¢å¼•" class="headerlink" title="èšç°‡ç´¢å¼•å’ŒäºŒçº§ç´¢å¼•"></a>èšç°‡ç´¢å¼•å’ŒäºŒçº§ç´¢å¼•</h2><ul><li>InnoDB ä½¿ç”¨äº† B+ æ ‘ç´¢å¼•æ¨¡å‹</li><li>ä¸»é”®ç´¢å¼•çš„å¶å­èŠ‚ç‚¹å­˜å‚¨çš„æ˜¯æ•´è¡Œæ•°æ®, åœ¨ InnoDB ä¸­, ä¸»é”®ç´¢å¼•ä¹Ÿè¢«ç§°ä¸ºèšç°‡ç´¢å¼•</li><li>éä¸»é”®ç´¢å¼•çš„å¶å­èŠ‚ç‚¹å­˜å‚¨çš„æ˜¯ä¸»é”®å€¼, åœ¨ InnoDB ä¸­, éä¸»é”®ç´¢å¼•ä¹Ÿè¢«ç§°ä¸ºäºŒçº§ç´¢å¼•</li></ul><h2 id="ä¸ºä»€ä¹ˆç”¨-B-æ ‘åšç´¢å¼•"><a href="#ä¸ºä»€ä¹ˆç”¨-B-æ ‘åšç´¢å¼•" class="headerlink" title="ä¸ºä»€ä¹ˆç”¨ B+ æ ‘åšç´¢å¼•"></a>ä¸ºä»€ä¹ˆç”¨ B+ æ ‘åšç´¢å¼•</h2><h3 id="ä»€ä¹ˆæ ·çš„æ•°æ®ç»“æ„æ˜¯å¥½çš„ç´¢å¼•"><a href="#ä»€ä¹ˆæ ·çš„æ•°æ®ç»“æ„æ˜¯å¥½çš„ç´¢å¼•" class="headerlink" title="ä»€ä¹ˆæ ·çš„æ•°æ®ç»“æ„æ˜¯å¥½çš„ç´¢å¼•?"></a>ä»€ä¹ˆæ ·çš„æ•°æ®ç»“æ„æ˜¯å¥½çš„ç´¢å¼•?</h3><ul><li>MySQL æ˜¯æŒä¹…åŒ–åˆ°ç£ç›˜çš„, å› æ­¤å½“æˆ‘ä»¬é€šè¿‡ç´¢å¼•æŸ¥æ‰¾æŸè¡Œæ•°æ®çš„æ—¶å€™, éœ€è¦å…ˆä»ç£ç›˜è¯»å–ç´¢å¼•åˆ°å†…å­˜, å†é€šè¿‡ç´¢å¼•ä»ç£ç›˜ä¸­æ‰¾åˆ°æŸè¡Œæ•°æ®, ç„¶åè¯»å…¥å†…å­˜, ä¹Ÿå°±æ˜¯è¯´æŸ¥è¯¢çš„è¿‡ç¨‹ä¸­ä¼šå‘ç”Ÿå¤šæ¬¡ IO æ“ä½œ, IO æ“ä½œæ¬¡æ•°è¶Šå¤š, æ€§èƒ½æŸè€—è¶Šå¤§</li><li>MySQL æ˜¯æ”¯æŒèŒƒå›´æŸ¥æ‰¾çš„, æ‰€ä»¥ç´¢å¼•æ•°æ®ä¸ä»…èƒ½é«˜æ•ˆæŸ¥æ‰¾æŸä¸€ä¸ªè®°å½•, è€Œä¸”ä¹Ÿè¦èƒ½é«˜æ•ˆæ‰§è¡ŒèŒƒå›´æŸ¥æ‰¾</li><li>æ‰€ä»¥ä¸€ä¸ªåˆé€‚çš„ç´¢å¼•è¦æ»¡è¶³<ul><li>å°½å¯èƒ½å°‘çš„è¿›è¡Œ IO æ“ä½œ</li><li>èƒ½é«˜æ•ˆæŸ¥æ‰¾æŸä¸€ä¸ªè®°å½•, ä¹Ÿèƒ½é«˜æ•ˆè¿›è¡ŒèŒƒå›´æŸ¥æ‰¾</li></ul></li></ul><h3 id="å„ä¸ªæ•°æ®ç»“æ„å¯¹æ¯”"><a href="#å„ä¸ªæ•°æ®ç»“æ„å¯¹æ¯”" class="headerlink" title="å„ä¸ªæ•°æ®ç»“æ„å¯¹æ¯”"></a>å„ä¸ªæ•°æ®ç»“æ„å¯¹æ¯”</h3><ul><li>é¡ºåºç»“æ„, å¯ä»¥ç”¨äºŒåˆ†æ¥æŸ¥æ‰¾, é€Ÿåº¦å¿«, ä½†æ˜¯æ’å…¥æ€§èƒ½å¤ªä½</li><li>äºŒå‰æœç´¢æ ‘, ä¸æ”¯æŒèŒƒå›´æŸ¥æ‰¾, è€Œä¸”æœ‰é€€åŒ–æˆé“¾è¡¨çš„é£é™©</li><li>å¹³è¡¡äºŒå‰æ ‘, ä¸æ”¯æŒèŒƒå›´æŸ¥æ‰¾, å¹¶ä¸”ç”±äºæ˜¯äºŒå‰æ ‘, éšç€å…ƒç´ å¢å¤š, æ ‘çš„é«˜åº¦å˜é«˜, ç£ç›˜ IO æ¬¡æ•°å¢åŠ </li><li>B æ ‘, B æ ‘å¯ä»¥æ˜¯å¤šå‰æ ‘, ä½†æ˜¯æ¯ä¸ªèŠ‚ç‚¹éƒ½å­˜å‚¨ç´¢å¼•+æ•°æ®, è€Œæ•°æ®çš„å¤§å°å¯èƒ½è¿œè¿œè¶…è¿‡ç´¢å¼•å¤§å°</li><li>B+æ ‘, å¶å­ç»“ç‚¹æ‰ä¼šå­˜æ”¾å®é™…æ•°æ®, éå¶å­èŠ‚ç‚¹åªä¼šå­˜æ”¾ç´¢å¼•, å¶å­èŠ‚ç‚¹æ„æˆä¸€ä¸ªæœ‰åºé“¾è¡¨</li></ul><h3 id="InnoDB-ä¸­çš„-B-æ ‘"><a href="#InnoDB-ä¸­çš„-B-æ ‘" class="headerlink" title="InnoDB ä¸­çš„ B+ æ ‘"></a>InnoDB ä¸­çš„ B+ æ ‘</h3><ul><li>å¶å­èŠ‚ç‚¹ç”¨åŒå‘é“¾è¡¨è¿›è¡Œè¿æ¥, æ—¢èƒ½å‘å·¦éå†, ä¹Ÿèƒ½å‘å³éå†</li><li>å¶å­èŠ‚ç‚¹å†…å®¹æ˜¯æ•°æ®é¡µ, æ•°æ®é¡µå­˜æ”¾äº†æ•°æ®ä»¥åŠå„ç§ä¿¡æ¯, æ¯ä¸ªæ•°æ®é¡µé»˜è®¤å¤§å° 16KB</li></ul><h2 id="ä»€ä¹ˆæ˜¯ä¸¤é˜¶æ®µé”"><a href="#ä»€ä¹ˆæ˜¯ä¸¤é˜¶æ®µé”" class="headerlink" title="ä»€ä¹ˆæ˜¯ä¸¤é˜¶æ®µé”"></a>ä»€ä¹ˆæ˜¯ä¸¤é˜¶æ®µé”</h2><ul><li>åœ¨ InnoDB äº‹åŠ¡ä¸­, è¡Œé”æ˜¯åœ¨éœ€è¦çš„æ—¶å€™åŠ ä¸Šçš„, ä½†å¹¶ä¸æ˜¯ä¸éœ€è¦äº†å°±ç«‹å³é‡Šæ”¾, è€Œæ˜¯ç­‰åˆ°äº‹åŠ¡ç»“æŸæ‰é‡Šæ”¾</li></ul><h2 id="å¿«ç…§è¯»å’Œå½“å‰è¯»"><a href="#å¿«ç…§è¯»å’Œå½“å‰è¯»" class="headerlink" title="å¿«ç…§è¯»å’Œå½“å‰è¯»"></a>å¿«ç…§è¯»å’Œå½“å‰è¯»</h2><ul><li>å¿«ç…§è¯»ä¸­, äº‹åŠ¡è¯»å–çš„æ˜¯æ•°æ®å¿«ç…§, å³äº‹åŠ¡å¼€å§‹æ—¶çš„æ•°æ®çŠ¶æ€</li><li>å½“å‰è¯»ä¸­, äº‹åŠ¡è¯»å–çš„æ˜¯æ•°æ®åº“å½“å‰æ•°æ®çŠ¶æ€, å³æœ€æ–°æ•°æ®, å¦‚æœæœ‰é”çš„è¯é˜»å¡ç­‰å¾…</li><li>å¯é‡å¤è¯»çš„éš”ç¦»çº§åˆ«ä¸‹<ul><li>select é»˜è®¤å¿«ç…§è¯»</li><li>select åŠ é”æ˜¯å½“å‰è¯»<ul><li>select a from t where id &#x3D; 1 lock in share mode å…±äº«é”</li><li>select a from t where id for update æ’ä»–é”</li></ul></li><li>update è¯­å¥æ˜¯å½“å‰è¯»</li></ul></li></ul><h2 id="ç´¢å¼•åˆ›å»ºåŸåˆ™"><a href="#ç´¢å¼•åˆ›å»ºåŸåˆ™" class="headerlink" title="ç´¢å¼•åˆ›å»ºåŸåˆ™"></a>ç´¢å¼•åˆ›å»ºåŸåˆ™</h2><ul><li>æ•°æ®é‡å¤§, ä¸”æŸ¥è¯¢é¢‘ç¹çš„æ—¶å€™è¦åˆ›å»ºç´¢å¼•</li><li>ä¸ºå¸¸ä½œä¸ºæŸ¥è¯¢æ¡ä»¶, æ’åº, åˆ†ç»„çš„å­—æ®µåˆ›å»ºç´¢å¼•</li><li>å­—æ®µçš„å†…å®¹åŒºåˆ†åº¦è¦é«˜</li><li>å†…å®¹è¾ƒé•¿çš„æƒ…å†µä¸‹, ä½¿ç”¨å‰ç¼€ç´¢å¼•</li><li>å°½é‡ä½¿ç”¨è”åˆç´¢å¼•, è¿™æ ·å¯ä»¥è¿›è¡Œè¦†ç›–æŸ¥è¯¢, æ–¹å¼å›è¡¨</li><li>è¦æ§åˆ¶ç´¢å¼•çš„æ•°é‡</li></ul><h2 id="ä»€ä¹ˆæƒ…å†µä¸‹ç´¢å¼•ä¼šå¤±æ•ˆ"><a href="#ä»€ä¹ˆæƒ…å†µä¸‹ç´¢å¼•ä¼šå¤±æ•ˆ" class="headerlink" title="ä»€ä¹ˆæƒ…å†µä¸‹ç´¢å¼•ä¼šå¤±æ•ˆ"></a>ä»€ä¹ˆæƒ…å†µä¸‹ç´¢å¼•ä¼šå¤±æ•ˆ</h2><ul><li>è”åˆç´¢å¼•ä¸­è¿åæœ€å·¦å‰ç¼€æ³•åˆ™</li><li>è”åˆç´¢å¼•ä¸­èŒƒå›´æŸ¥è¯¢çš„å³è¾¹çš„åˆ—, ä¸èƒ½ä½¿ç”¨ç´¢å¼•</li><li>ç´¢å¼•åˆ—ä¸Šè¿›è¡Œè¿ç®—æ“ä½œ, ç´¢å¼•å¤±æ•ˆ</li><li>ç´¢å¼•åˆ—è¿›è¡Œç±»å‹è½¬æ¢, æ¯”å¦‚å­—ç¬¦ä¸²ä¸åŠ å•å¼•å·, ç´¢å¼•å¤±æ•ˆ</li><li>ä»¥%å¼€å¤´çš„ like æ¨¡ç³ŠæŸ¥è¯¢, ç´¢å¼•å¤±æ•ˆ</li></ul><h2 id="å…¨æ–‡ç´¢å¼•"><a href="#å…¨æ–‡ç´¢å¼•" class="headerlink" title="å…¨æ–‡ç´¢å¼•"></a>å…¨æ–‡ç´¢å¼•</h2><ul><li>æ˜¯ä¸€ç§å¿«é€Ÿæœç´¢æ–‡æœ¬æ•°æ®çš„ç´¢å¼•, é€‚ç”¨äºéœ€è¦å¤„ç†å¤§é‡è‡ªç„¶è¯­è¨€æ–‡æœ¬çš„åº”ç”¨åœºæ™¯</li><li>åº•å±‚ç”±å€’æ’ç´¢å¼•å®ç°<ul><li>è¯å…¸: å­˜å‚¨æ¯ä¸€ä¸ªè¯</li><li>å€’æ’åˆ—è¡¨: è®°å½•æ¯ä¸ªè¯åœ¨æ–‡æ¡£ä¸­å‡ºç°çš„ä½ç½®</li></ul></li></ul><h2 id="æ…¢æŸ¥è¯¢å‡ºç°çš„åŸå› "><a href="#æ…¢æŸ¥è¯¢å‡ºç°çš„åŸå› " class="headerlink" title="æ…¢æŸ¥è¯¢å‡ºç°çš„åŸå› "></a>æ…¢æŸ¥è¯¢å‡ºç°çš„åŸå› </h2><ul><li>æ²¡æœ‰ä½¿ç”¨ç´¢å¼•æˆ–è€…ç´¢å¼•ä¸å½“</li><li>å¤æ‚çš„ join æ“ä½œ, å°¤å…¶æ¶‰åŠå¤§é‡æ•°æ®çš„è¡¨</li><li>å­æŸ¥è¯¢è¿‡å¤š</li><li>è¡¨ç»“æ„è®¾è®¡ä¸åˆç†, è¿‡å¤šçš„å†—ä½™è®¾è®¡</li><li>æ•°æ®é‡è¿‡å¤§</li><li>æœåŠ¡å™¨çš„ç¡¬ä»¶èµ„æºä¸ç²—</li></ul><h2 id="ä¼˜åŒ–æ…¢æŸ¥è¯¢"><a href="#ä¼˜åŒ–æ…¢æŸ¥è¯¢" class="headerlink" title="ä¼˜åŒ–æ…¢æŸ¥è¯¢"></a>ä¼˜åŒ–æ…¢æŸ¥è¯¢</h2><ul><li>å…ˆè¿è¡Œçœ‹çœ‹æ˜¯å¦çœŸçš„å¾ˆæ…¢ï¼Œæ³¨æ„è®¾ç½® SQL_NO_CACHE</li><li>WHERE æ¡ä»¶å•è¡¨æŸ¥ï¼Œé”å®šæœ€å°è¿”å›è®°å½•è¡¨<ul><li>åœ¨æ¶‰åŠå¤šä¸ªè¡¨çš„æŸ¥è¯¢ä¸­ï¼Œåº”è¯¥ä»è¿”å›è®°å½•æœ€å°‘çš„è¡¨å¼€å§‹æŸ¥è¯¢ï¼Œä»¥å‡å°‘æ•°æ®å¤„ç†çš„å¼€é”€</li><li>å¯¹äºå•è¡¨æŸ¥è¯¢ï¼Œé€šè¿‡ WHERE æ¡ä»¶é€ä¸ªåº”ç”¨åˆ°è¡¨ä¸­çš„æ¯ä¸ªå­—æ®µï¼Œæ‰¾å‡ºåŒºåˆ†åº¦æœ€é«˜çš„å­—æ®µï¼Œè¿™æ ·å¯ä»¥æ›´é«˜æ•ˆåœ°è¿‡æ»¤æ•°æ®<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- å‡è®¾æœ‰ä¸¤ä¸ªè¡¨</span><br><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> A, B <span class="hljs-keyword">WHERE</span> A.id <span class="hljs-operator">=</span> B.id <span class="hljs-keyword">AND</span> A.status <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;active&#x27;</span> <span class="hljs-keyword">AND</span> B.type <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;premium&#x27;</span>;<br><span class="hljs-comment">-- åˆ†æå•æ ‡ where æ¡ä»¶æ•ˆæœ</span><br><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> A <span class="hljs-keyword">WHERE</span> status <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;active&#x27;</span>; <span class="hljs-comment">-- ç»“æœè®°å½•æ•°è¾ƒå¤š</span><br><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> B <span class="hljs-keyword">WHERE</span> type <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;premium&#x27;</span>;  <span class="hljs-comment">-- ç»“æœè®°å½•æ•°è¾ƒå°‘</span><br><span class="hljs-comment">-- ä¼˜å…ˆä»è®°å½•è¾ƒå°‘çš„ B è¡¨å¼€å§‹æŸ¥</span><br></code></pre></td></tr></table></figure></li></ul></li><li>ä½¿ç”¨ EXPLAIN æŸ¥çœ‹æŸ¥è¯¢çš„æ‰§è¡Œè®¡åˆ’ï¼Œç¡®è®¤æŸ¥è¯¢æ˜¯ä»è®°å½•è¾ƒå°‘çš„è¡¨å¼€å§‹çš„ï¼Œå¹¶æ£€æŸ¥ç´¢å¼•çš„ä½¿ç”¨æƒ…å†µ</li><li>åœ¨ ORDER BY â€¦ LIMIT â€¦ çš„æŸ¥è¯¢ä¸­ï¼Œåº”è¯¥ä¼˜å…ˆå¤„ç†æ’åºçš„è¡¨ï¼Œè¿™æ ·å¯ä»¥å‡å°‘æ’åºå’Œæˆªå–ç»“æœçš„å¼€é”€</li></ul><h2 id="äº‹åŠ¡çš„ç‰¹æ€§"><a href="#äº‹åŠ¡çš„ç‰¹æ€§" class="headerlink" title="äº‹åŠ¡çš„ç‰¹æ€§"></a>äº‹åŠ¡çš„ç‰¹æ€§</h2><ul><li>A åŸå­æ€§: äº‹åŠ¡æ˜¯ä¸å¯åˆ†å‰²çš„æœ€å°å•ä½, è¦ä¹ˆå…¨éƒ¨æˆåŠŸ, è¦ä¹ˆå…¨éƒ¨å¤±è´¥</li><li>C ä¸€è‡´æ€§: äº‹åŠ¡å®Œæˆæ—¶, å¿…é¡»ä½¿æ‰€æœ‰çš„æ•°æ®éƒ½ä¿æŒä¸€è‡´çŠ¶æ€</li><li>I éš”ç¦»æ€§: æ•°æ®åº“ç³»ç»Ÿæä¾›çš„éš”ç¦»æœºåˆ¶, ä¿è¯äº‹åŠ¡åœ¨ä¸æ”¶å¤–éƒ¨å¹¶å‘æ“ä½œçš„å½±å“çš„ç‹¬ç«‹ç¯å¢ƒä¸‹è¿è¡Œ</li><li>D æŒä¹…æ€§: äº‹åŠ¡ä¸€æ—¦æäº¤æˆ–å›æ»š, å®ƒå¯¹æ•°æ®åº“çš„æ”¹å˜æ˜¯æ°¸ä¹…çš„</li></ul><h2 id="å¹¶å‘äº‹åŠ¡å¸¦æ¥äº†å“ªäº›é—®é¢˜"><a href="#å¹¶å‘äº‹åŠ¡å¸¦æ¥äº†å“ªäº›é—®é¢˜" class="headerlink" title="å¹¶å‘äº‹åŠ¡å¸¦æ¥äº†å“ªäº›é—®é¢˜"></a>å¹¶å‘äº‹åŠ¡å¸¦æ¥äº†å“ªäº›é—®é¢˜</h2><ul><li>è„è¯»</li><li>ä¸å¯é‡å¤åº¦</li><li>å¹»è¯»: ä¸€ä¸ªäº‹åŠ¡æŒ‰ç…§æ¡ä»¶æŸ¥è¯¢, æ²¡æœ‰å¯¹åº”çš„è®°å½•, ä½†æ˜¯æ’å…¥çš„æ—¶å€™å‘ç°è®°å½•å·²å­˜åœ¨, å¥½åƒå‡ºç°äº†å¹»å½±</li></ul><h2 id="MVCC"><a href="#MVCC" class="headerlink" title="MVCC"></a>MVCC</h2><ul><li>å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶, ä¸»è¦æ˜¯é€šè¿‡éšè—å­—æ®µ(äº‹åŠ¡ id, roll_pointer), undo log ç‰ˆæœ¬é“¾å’Œ ReadViewç»„æˆçš„</li><li>å®ƒç»´æŠ¤äº†ä¸€æ¡æ•°æ®çš„å¤šä¸ªç‰ˆæœ¬, ç”¨ roll_pointer è¿›è¡Œè¿æ¥, å½¢æˆä¸€ä¸ª undo log é“¾</li><li>ReadView å¿«ç…§è¯»<ul><li>è¯»å·²æäº¤: æ¯æ¬¡ select éƒ½ä¼šç”Ÿæˆå¿«ç…§</li><li>å¯é‡å¤è¯»: ç¬¬ä¸€æ¬¡ select ç”Ÿæˆå¿«ç…§, ä¹‹åå¤ç”¨</li></ul></li></ul><p>å¯¹äºä¸€ä¸ªäº‹åŠ¡è§†å›¾æ¥è¯´, é™¤äº†è‡ªå·±æ›´æ–°æ€»æ˜¯å¯è§çš„ä»¥å¤–, è¿˜æœ‰ 3 ç§æƒ…å†µ</p><ul><li>ç‰ˆæœ¬æœªæäº¤, ä¸å¯è§</li><li>ç‰ˆæœ¬å·²æäº¤, ä½†æ˜¯åœ¨è§†å›¾åˆ›å»ºåæäº¤çš„, ä¸å¯è§</li><li>ç‰ˆæœ¬å·²æäº¤, è€Œä¸”å®åœ¨è§†å›¾åˆ›å»ºå‰æäº¤çš„, å¯è§</li></ul><h2 id="å¹»è¯»"><a href="#å¹»è¯»" class="headerlink" title="å¹»è¯»"></a>å¹»è¯»</h2><p>å½“åŒä¸€ä¸ªæŸ¥è¯¢åœ¨ä¸åŒçš„æ—¶é—´äº§ç”Ÿä¸åŒçš„ç»“æœé›†æ—¶, äº‹åŠ¡ä¸­å°±ä¼šå‡ºç°æ‰€è°“çš„å¹»è±¡, ä¾‹å¦‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> t <span class="hljs-keyword">where</span> id <span class="hljs-operator">&gt;</span> <span class="hljs-number">100</span>;<br></code></pre></td></tr></table></figure><p>åœ¨ T1 æ—¶åˆ»å’Œ T2 æ—¶åˆ»åˆ†åˆ«æ‰§è¡Œä»¥ä¸‹è¯­å¥, å¾—åˆ°çš„ç»“æœé›†æ˜¯ä¸ç›¸åŒçš„<br>ä¾‹å¦‚ T1 æ—¶åˆ»æœ‰ 5 æ¡è®°å½•, è€Œ T2 æ—¶åˆ»æœ‰ 6 æ¡è®°å½•<br>åœ¨å¯é‡å¤åº¦çº§åˆ«ä¸‹<br><img src="https://gitee.com/AWallFlower/picture/raw/master/img/20240514195706.png" alt="image.png"><br>å‰åä¸¤æ¬¡æŸ¥è¯¢ç»“æœæ˜¯ä¸€æ ·çš„, æ²¡æœ‰å‡ºç°å¹»è¯», å› ä¸ºåœ¨å¯é‡å¤åº¦çº§åˆ«ä¸‹ select æ‰§è¡Œçš„æ—¶å€™ä¼šåˆ›å»ºä¸€ä¸ªå¿«ç…§, åœ¨å¿«ç…§ä¸Šè¯»è‚¯å®šæ²¡æœ‰å¹»è¯»<br>ä½†æ˜¯å½“å‰è¯»ä¼šå‡ºç°å¹»è¯», å› ä¸ºå½“å‰è¯»éƒ½ä¼šæŸ¥è¯¢æœ€æ–°ç‰ˆæœ¬æ•°æ®, ç„¶åå†åšè¿›ä¸€æ­¥æ“ä½œ</p><ul><li>update</li><li>insert</li><li>delete</li><li>select â€¦ for update éƒ½æ˜¯å½“å‰è¯»<br>æˆ‘ä»¬å‡è®¾ select â€¦ for update æ˜¯ä¸ä¼šåŠ é”, (å®é™…ä¸Šæ˜¯ä¼šåŠ é”çš„)<br><img src="https://gitee.com/AWallFlower/picture/raw/master/img/20240514195938.png" alt="image.png"><br>ç”±äº select â€¦ for update æ˜¯å½“å‰è¯», æ‰€ä»¥å°±ä¼šå‡ºç°ä¸¤æ¬¡æŸ¥è¯¢ç»“æœä¸ä¸€æ ·çš„æƒ…å†µ<br>æ‰€ä»¥ InnoDB ä¸ºäº†è§£å†³å¯é‡å¤è¯»ä½¿ç”¨å½“å‰è¯»è€Œé€ æˆçš„å¹»è¯»é—®é¢˜, å¼•å…¥äº†é—´æ­‡é”<br><img src="https://gitee.com/AWallFlower/picture/raw/master/img/20240514200205.png" alt="image.png"><br>äº‹åŠ¡ A æ‰§è¡Œè¯­å¥åå°±ä¼šåœ¨ id èŒƒå›´ä¸º(2, +âˆ] çš„ next-key lock(é—´æ­‡é” + è®°å½•é”)<br>äº‹åŠ¡ B åœ¨æ‰§è¡Œæ’å…¥è¯­å¥çš„æ—¶å€™, åˆ¤æ–­æ’å…¥ä½ç½®è¢« A åŠ ä¸Šäº† next-key lock, äºæ˜¯äº‹åŠ¡ B ä¼šç”Ÿæˆä¸€ä¸ªæ’å…¥æ„å‘é”, ç­‰å¾…</li></ul><p>è¿˜æœ‰å‡ ç§æƒ…å†µ<br>è¯¦è§å°æ— coding <a href="https://xiaolincoding.com/mysql/transaction/phantom.html">https://xiaolincoding.com/mysql/transaction/phantom.html</a></p><h2 id="ä¸»ä»åŒæ­¥åŸç†"><a href="#ä¸»ä»åŒæ­¥åŸç†" class="headerlink" title="ä¸»ä»åŒæ­¥åŸç†"></a>ä¸»ä»åŒæ­¥åŸç†</h2><ul><li>æ ¸å¿ƒæ˜¯ binlog æ—¥å¿—</li><li>ä»åº“è¯»å–ä¸»åº“çš„ binlog, å†™å…¥åˆ°ä»åº“çš„ä¸­ç»§æ—¥å¿— Relay Log ä¸­</li><li>ä»åº“æ‰§è¡Œä¸­ç»§æ—¥å¿—çš„äº‹åŠ¡, åŒæ­¥æ•°æ®</li></ul><h2 id="åˆ†åº“åˆ†è¡¨"><a href="#åˆ†åº“åˆ†è¡¨" class="headerlink" title="åˆ†åº“åˆ†è¡¨"></a>åˆ†åº“åˆ†è¡¨</h2><ul><li>æ°´å¹³åˆ†åº“</li><li>æ°´å¹³åˆ†è¡¨</li><li>å‚ç›´åˆ†åº“</li><li>å‚ç›´åˆ†è¡¨: å†·çƒ­æ•°æ®åˆ†ç¦», å¤šè¡¨äº’ä¸å½±å“(æŠŠè¡¨ä¸­æŸäº›å­—æ®µåˆ†å‡ºå»)</li></ul><h2 id="èŒƒå›´æŸ¥æ‰¾æµç¨‹"><a href="#èŒƒå›´æŸ¥æ‰¾æµç¨‹" class="headerlink" title="èŒƒå›´æŸ¥æ‰¾æµç¨‹"></a>èŒƒå›´æŸ¥æ‰¾æµç¨‹</h2><h3 id="æœ‰ç´¢å¼•"><a href="#æœ‰ç´¢å¼•" class="headerlink" title="æœ‰ç´¢å¼•"></a>æœ‰ç´¢å¼•</h3><p>æ¯”å¦‚æ‰¾åˆ° id &gt;&#x3D; 20 and &lt; 49çš„æ•°æ®<br>1ã€åŠ è½½æ ¹æ•°æ®é¡µåˆ°å†…å­˜<br>2ã€åœ¨å†…å­˜ä¸­åšäºŒåˆ†ï¼Œæ‰¾åˆ°å¯¹åº”çš„å­é¡µ<br>3ã€åœ¨å­é¡µåšäºŒåˆ†ï¼Œæ‰¾åˆ°å¯¹åº”çš„å­é¡µ<br>4ã€ç°åœ¨åˆ°äº†å¶å­èŠ‚ç‚¹é¡µï¼Œåœ¨é¡µä¸­åšäºŒåˆ†ï¼Œæ‰¾åˆ°ç¬¬ä¸€æ¡æ»¡è¶³çš„æ•°æ®ï¼Œè¿™é‡Œæ˜¯ id &#x3D; 20<br>5ã€ä¸€ç›´é€šè¿‡å¶å­èŠ‚ç‚¹çš„é“¾è¡¨æŒ‡é’ˆï¼Œæ‰¾åˆ°ç¬¬ä¸€æ¡ä¸æ»¡è¶³çš„ä¸ºæ­¢ï¼Œè¿™é‡Œæ˜¯ id &#x3D; 49<br>6ã€ç»“æŸæŸ¥æ‰¾ï¼Œè¿”å›æ•°æ®</p><h3 id="æ²¡æœ‰ç´¢å¼•"><a href="#æ²¡æœ‰ç´¢å¼•" class="headerlink" title="æ²¡æœ‰ç´¢å¼•"></a>æ²¡æœ‰ç´¢å¼•</h3><ul><li>æ‰«æå…¨è¡¨</li></ul><h2 id="å¦‚ä½•é¿å…ä¸»ä»å»¶è¿Ÿ"><a href="#å¦‚ä½•é¿å…ä¸»ä»å»¶è¿Ÿ" class="headerlink" title="å¦‚ä½•é¿å…ä¸»ä»å»¶è¿Ÿ"></a>å¦‚ä½•é¿å…ä¸»ä»å»¶è¿Ÿ</h2><ul><li>å¼ºåˆ¶å°†è¯»è¯·æ±‚è·¯ç”±åˆ°ä¸»åº“å¤„ç†, å¯¹äºå¿…é¡»è·å–æœ€æ–°æ•°æ®çš„è¯·æ±‚, éƒ½äº¤ç»™ä¸»åº“å¤„ç†</li><li>å»¶è¿Ÿè¯»å–, å¯¹äºä¸€äº›å¯¹æ•°æ®æ¯”è¾ƒæ•æ„Ÿçš„åœºæ™¯, å¯ä»¥åœ¨å®Œæˆå†™è¯·æ±‚ä¹‹å, é¿å…ç«‹åˆ»è¿›è¡Œè¯·æ±‚æ“ä½œ<ul><li>æ¯”å¦‚æ”¯ä»˜æˆåŠŸä¹‹å, è·³è½¬åˆ°æ”¯ä»˜æˆåŠŸçš„é¡µé¢, å½“ç‚¹å‡»è¿”å›çš„æ—¶å€™æ‰è¿”å›è‡ªå·±çš„è´¦æˆ·</li></ul></li></ul><h2 id="MySQL-ä¸»é”®è‡ªå¢ç­–ç•¥"><a href="#MySQL-ä¸»é”®è‡ªå¢ç­–ç•¥" class="headerlink" title="MySQL ä¸»é”®è‡ªå¢ç­–ç•¥"></a>MySQL ä¸»é”®è‡ªå¢ç­–ç•¥</h2><ul><li>è‡ªå¢</li><li>UUID</li><li>é›ªèŠ±ç®—æ³•</li></ul><h2 id="MySQL-çš„ç´¢å¼•ç±»å‹"><a href="#MySQL-çš„ç´¢å¼•ç±»å‹" class="headerlink" title="MySQL çš„ç´¢å¼•ç±»å‹"></a>MySQL çš„ç´¢å¼•ç±»å‹</h2><ul><li>æ™®é€šç´¢å¼•</li><li>å”¯ä¸€ç´¢å¼•</li><li>ä¸»é”®ç´¢å¼•, ä¸€èˆ¬åœ¨åˆ›å»ºè¡¨çš„æ—¶å€™æŒ‡å®š</li><li>è”åˆç´¢å¼•</li><li>å…¨æ–‡ç´¢å¼•</li></ul><h2 id="é—´éš™é”å¯¼è‡´æ­»é”"><a href="#é—´éš™é”å¯¼è‡´æ­»é”" class="headerlink" title="é—´éš™é”å¯¼è‡´æ­»é”"></a>é—´éš™é”å¯¼è‡´æ­»é”</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- äº‹åŠ¡A</span><br><span class="hljs-keyword">delete</span> <span class="hljs-keyword">from</span> course <span class="hljs-keyword">where</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">3</span>;<br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> course(id, user_id, <span class="hljs-keyword">no</span>) <span class="hljs-keyword">VALUE</span> (<span class="hljs-number">3</span>,<span class="hljs-number">3</span>,<span class="hljs-string">&#x27;3&#x27;</span>);<br><br><span class="hljs-comment">-- äº‹åŠ¡B</span><br><span class="hljs-keyword">delete</span> <span class="hljs-keyword">from</span> course <span class="hljs-keyword">where</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">4</span>;<br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> course(id, user_id, <span class="hljs-keyword">no</span>) <span class="hljs-keyword">VALUE</span> (<span class="hljs-number">4</span>,<span class="hljs-number">4</span>,<span class="hljs-string">&#x27;4&#x27;</span>);<br></code></pre></td></tr></table></figure><h2 id="æ—¥å¿—æœ‰å“ªäº›"><a href="#æ—¥å¿—æœ‰å“ªäº›" class="headerlink" title="æ—¥å¿—æœ‰å“ªäº›"></a>æ—¥å¿—æœ‰å“ªäº›</h2><ul><li>BinLog æ—¥å¿—</li><li>æ…¢æŸ¥è¯¢æ—¥å¿—</li><li>Relay Log</li><li>Undo Log</li></ul></li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>å…«è‚¡</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å¤šçº¿ç¨‹</title>
    <link href="/2024/05/26/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"/>
    <url>/2024/05/26/%E5%A4%9A%E7%BA%BF%E7%A8%8B/</url>
    
    <content type="html"><![CDATA[<h1 id="å¤šçº¿ç¨‹"><a href="#å¤šçº¿ç¨‹" class="headerlink" title="å¤šçº¿ç¨‹"></a>å¤šçº¿ç¨‹</h1><h2 id="Runnable-å’Œ-Callable-æœ‰ä»€ä¹ˆåŒºåˆ«"><a href="#Runnable-å’Œ-Callable-æœ‰ä»€ä¹ˆåŒºåˆ«" class="headerlink" title="Runnable å’Œ Callable æœ‰ä»€ä¹ˆåŒºåˆ«"></a>Runnable å’Œ Callable æœ‰ä»€ä¹ˆåŒºåˆ«</h2><ul><li>Runnable çš„ run æ–¹æ³•æ²¡æœ‰è¿”å›å€¼, Callable çš„ call æ–¹æ³•æœ‰</li><li>Callable çš„ call æ–¹æ³•æ˜¯ä¸ªæ³›å‹</li><li>Runnable çš„ run æ–¹æ³•ä¸èƒ½æŠ›å¼‚å¸¸, Callable çš„ call æ–¹æ³•å¯ä»¥</li></ul><h2 id="wait-å’Œ-sleep-æ–¹æ³•æœ‰ä»€ä¹ˆåŒºåˆ«"><a href="#wait-å’Œ-sleep-æ–¹æ³•æœ‰ä»€ä¹ˆåŒºåˆ«" class="headerlink" title="wait å’Œ sleep æ–¹æ³•æœ‰ä»€ä¹ˆåŒºåˆ«"></a>wait å’Œ sleep æ–¹æ³•æœ‰ä»€ä¹ˆåŒºåˆ«</h2><ul><li>å½’å±ä¸åŒ: wait æ–¹æ³•æ˜¯ Object ç±»ä¸­çš„, sleep æ–¹æ³•æ˜¯ Thread çš„é™æ€æ–¹æ³•</li><li>é†’æ¥æ—¶æœºä¸åŒ: sleep(long) å’Œ wait(long) éƒ½ä¼šåœ¨ç­‰å¾…ç›¸åº”æ¯«ç§’åé†’æ¥, wait æ–¹æ³•å¯ä»¥è¢« notify å”¤é†’</li><li>é”ç‰¹æ€§ä¸åŒ: wait æ–¹æ³•å¿…é¡»é…åˆSynchronized ä½¿ç”¨, sleep æ— æ­¤é™åˆ¶<ul><li>wait æ–¹æ³•æ‰§è¡Œåä¼šé‡Šæ”¾é”å¯¹è±¡, å…è®¸å…¶ä»–çº¿ç¨‹è·å¾—é”(æˆ‘æ”¾å¼ƒ CPU, ä½ ä»¬å¯ä»¥ç”¨)</li><li>sleep å¦‚æœåœ¨ Synchronized ä»£ç å—ä¸­æ‰§è¡Œ, ä¸ä¼šé‡Šæ”¾é”å¯¹è±¡(æˆ‘æ”¾å¼ƒ CPU, ä½ ä»¬ä¹Ÿä¸èƒ½ç”¨)</li></ul></li></ul><h2 id="Synchronized-åº•å±‚åŸç†"><a href="#Synchronized-åº•å±‚åŸç†" class="headerlink" title="Synchronized åº•å±‚åŸç†"></a>Synchronized åº•å±‚åŸç†</h2><h2 id="ConcurrentHashMap"><a href="#ConcurrentHashMap" class="headerlink" title="ConcurrentHashMap"></a>ConcurrentHashMap</h2><ul><li>åœ¨ 1.7 ç‰ˆæœ¬ä¸­ ConcurrentHashMap æ˜¯ç”¨ æ•°ç»„ + é“¾è¡¨çš„æ•°æ®ç»“æ„å®ç°çš„<ul><li>æ•°ç»„åˆåˆ†å¤§æ•°ç»„ Segment å’Œå°æ•°ç»„ HashEntry (å¤§æ•°ç»„å¯ä»¥ç†è§£ä¸º MySQL çš„æ•°æ®åº“, å°æ•°ç»„å¯ä»¥ç†è§£ä¸ºè¡¨, æ¯ä¸ªæ•°ç»„å¯ä»¥å­˜å‚¨å¤šæ¡æ•°æ®, ç”¨é“¾è¡¨è¿æ¥)</li><li>å®ƒæ˜¯åŸºäº ReentrantLock å®ç°åŠ é”å’Œé‡Šæ”¾é”çš„æ“ä½œ, é”çš„ç²’åº¦ä¸º Segment</li></ul></li><li>åœ¨ 1.8 ç‰ˆæœ¬ä¸­ç”¨çš„æ˜¯ æ•°ç»„ + é“¾è¡¨ + çº¢é»‘æ ‘çš„æ•°æ®ç»“æ„å®ç°çš„<ul><li>ç”¨çš„æ˜¯ CAS + volatile æˆ– Synchronized æ–¹å¼ä¿è¯çº¿ç¨‹å®‰å…¨</li><li>æ·»åŠ å…ƒç´ é¦–å…ˆä¼šåˆ¤æ–­å®¹å™¨æ˜¯å¦ä¸ºç©º, å¦‚æœä¸ºç©ºåˆ™ç”¨ volatile + CAS åˆå§‹åŒ–</li><li>å®¹å™¨ä¸ä¸ºç©ºåˆ™æ ¹æ®å­˜å‚¨çš„å…ƒç´ è®¡ç®—ä½ç½®æ˜¯å¦ä¸ºç©º, ä¸ºç©ºç”¨ CAS è®¾ç½®èŠ‚ç‚¹</li><li>ä¸ä¸ºç©ºåˆ™ä½¿ç”¨ Synchronized åŠ é”</li></ul></li></ul><h2 id="JMM-å†…å­˜ç»“æ„"><a href="#JMM-å†…å­˜ç»“æ„" class="headerlink" title="JMM å†…å­˜ç»“æ„"></a>JMM å†…å­˜ç»“æ„</h2><h2 id="ä»‹ç»ä¸€ä¸‹volatile-å…³é”®å­—"><a href="#ä»‹ç»ä¸€ä¸‹volatile-å…³é”®å­—" class="headerlink" title="ä»‹ç»ä¸€ä¸‹volatile å…³é”®å­—"></a>ä»‹ç»ä¸€ä¸‹volatile å…³é”®å­—</h2><ul><li>æ˜¯ç”¨æ¥ä¿®é¥°å˜é‡çš„</li><li>è¢«å…¶ä¿®é¥°çš„å˜é‡åœ¨ä¿®æ”¹åå¯ä»¥ç«‹å³åŒæ­¥åˆ°ä¸»å†…å­˜, æ¯æ¬¡ä½¿ç”¨ä¹‹å‰éƒ½æ˜¯ä»ä¸»å†…å­˜è¯»å–, å› æ­¤ volatile å¯ä»¥ä¿è¯å¯è§æ€§</li><li>volatile å¯ä»¥ç¦æ­¢æŒ‡ä»¤é‡æ’åº, è¢« volatile ä¿®é¥°çš„å˜é‡æ“ä½œ, ä¼šä¸¥æ ¼æŒ‰ç…§ä»£ç é¡ºåºæ‰§è¡Œ</li></ul><h2 id="CAS"><a href="#CAS" class="headerlink" title="CAS"></a>CAS</h2><h2 id="AQS"><a href="#AQS" class="headerlink" title="AQS"></a>AQS</h2><ul><li>æŠ½è±¡é˜Ÿåˆ—åŒæ­¥å™¨</li><li>å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªå…ˆè¿›å…ˆå‡ºçš„åŒå‘é˜Ÿåˆ—, é˜Ÿåˆ—ä¸­å­˜å‚¨çš„æ˜¯æ’é˜Ÿçš„çº¿ç¨‹</li><li>AQS å†…éƒ¨æœ‰ä¸€ä¸ªå±æ€§ state, ç›¸å½“äºèµ„æº, é»˜è®¤æ˜¯ 0, å½“æœ‰ä¸€ä¸ªçº¿ç¨‹æˆåŠŸä¿®æ”¹ state ä¸º 1, åˆ™å½“å‰çº¿ç¨‹å°±ç­‰äºè·å–äº†èµ„æº</li><li>å¯¹ state ä¿®æ”¹çš„æ—¶å€™ç”¨ CAS æ“ä½œ, ä¿è¯å¤šä¸ªçº¿ç¨‹ä¿®æ”¹æƒ…å†µä¸‹çš„åŸå­æ€§</li></ul><h2 id="ThreadLocal"><a href="#ThreadLocal" class="headerlink" title="ThreadLocal"></a>ThreadLocal</h2><h2 id="çº¿ç¨‹æ± å‚æ•°"><a href="#çº¿ç¨‹æ± å‚æ•°" class="headerlink" title="çº¿ç¨‹æ± å‚æ•°"></a>çº¿ç¨‹æ± å‚æ•°</h2><h2 id="ç”¨çº¿ç¨‹æ± æœ‰ä»€ä¹ˆå¥½å¤„"><a href="#ç”¨çº¿ç¨‹æ± æœ‰ä»€ä¹ˆå¥½å¤„" class="headerlink" title="ç”¨çº¿ç¨‹æ± æœ‰ä»€ä¹ˆå¥½å¤„"></a>ç”¨çº¿ç¨‹æ± æœ‰ä»€ä¹ˆå¥½å¤„</h2><ul><li>ä¸ç”¨åå¤åˆ›å»ºæ”¶å›çº¿ç¨‹æ‰€éœ€è¦çš„èµ„æº</li><li>ç³»ç»Ÿçš„å“åº”é€Ÿåº¦æ›´å¿«</li><li>æ›´åŠ åˆç†åˆ©ç”¨ CPU èµ„æº</li><li>å¯ä»¥ç»Ÿä¸€ç®¡ç†èµ„æº</li></ul><h2 id="çº¿ç¨‹æ± çš„åˆ›å»ºæ–¹æ³•"><a href="#çº¿ç¨‹æ± çš„åˆ›å»ºæ–¹æ³•" class="headerlink" title="çº¿ç¨‹æ± çš„åˆ›å»ºæ–¹æ³•"></a>çº¿ç¨‹æ± çš„åˆ›å»ºæ–¹æ³•</h2><ul><li>ThreadPoolExecutor æ„é€ å‡½æ•°</li><li>Executors å·¥å…·ç±»</li></ul><h2 id="ä»€ä¹ˆæ—¶å€™ä½¿ç”¨çº¿ç¨‹æ± "><a href="#ä»€ä¹ˆæ—¶å€™ä½¿ç”¨çº¿ç¨‹æ± " class="headerlink" title="ä»€ä¹ˆæ—¶å€™ä½¿ç”¨çº¿ç¨‹æ± "></a>ä»€ä¹ˆæ—¶å€™ä½¿ç”¨çº¿ç¨‹æ± </h2><ul><li>å½“éœ€è¦é¢‘ç¹åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹çš„æ—¶å€™</li><li>å¸¸é‡æ± çš„å‚æ•°é…ç½®<ul><li>å¿«é€Ÿå“åº”ç”¨æˆ·è¯·æ±‚, ç”¨æˆ·å‘èµ·è¯•è¯•è¯·æ±‚, æœåŠ¡è¿½æ±‚å“åº”æ—¶é—´, æ¯”å¦‚ä¸€ä¸ªç”¨æˆ·è¦æŸ¥çœ‹å•†å“ä¿¡æ¯, é‚£ä¹ˆå“åº”è¶Šå¿«è¶Šå¥½, æ‰€ä»¥è¿™ç§åœºæ™¯ä¸åº”è¯¥è®¾ç½®é˜Ÿåˆ—å»ç¼“å­˜å¹¶å‘ä»»åŠ¡, è°ƒé«˜ corePoolSize å’Œ maxPoolSize å°½å¯èƒ½åˆ›é€ å¤šçš„çº¿ç¨‹æ‰§è¡Œä»»åŠ¡</li><li>æ‰¹å¤„ç†æ“ä½œ, ç¦»çº¿è®¡ç®—å¤§é‡ä»»åŠ¡, æ¯”å¦‚ç»Ÿè®¡æŠ¥è¡¨, è¿™ç§æƒ…å†µä¸‹, ä»»åŠ¡é‡å·¨å¤§ä¸éœ€è¦ç¬æ—¶å®Œæˆ, ä¹Ÿå°±æ˜¯ååé‡ä¼˜å…ˆ, æ‰€ä»¥åº”è¯¥è®¾ç½®é˜Ÿåˆ—å»ç¼“å†²å¹¶å‘ä»»åŠ¡</li></ul></li></ul><h2 id="notify-å’Œ-wait"><a href="#notify-å’Œ-wait" class="headerlink" title="notify å’Œ wait"></a>notify å’Œ wait</h2><ul><li>wait å’Œ notify å‡ä¾èµ–äºé”, ä¸”é”çš„å¯¹è±¡å¿…é¡»æ˜¯åŒä¸€ä¸ªå¯¹è±¡, å¦åˆ™æ— æ³•æ‰§è¡Œå”¤é†’</li><li>notify å”¤é†’æ˜¯éšæœºå”¤é†’ä¸€ä¸ªçº¿ç¨‹, å”¤é†’çš„èŒƒä¸ºæ˜¯åŒä¸€é”å¯¹è±¡, æ‰€æœ‰ wait çš„çº¿ç¨‹</li></ul><p>notify åŒä¸€ä¾èµ–äºé”, å¿…é¡»åœ¨åŒæ­¥å¿«ä¸­æ‰§è¡Œ, æ‰§è¡Œä¹‹åä¼šç«‹åˆ»é‡Šæ”¾é”å—?</p><ul><li>notify åœ¨æ‰§è¡Œåä¸ä¼šç«‹å³å”¤é†’, è€Œæ˜¯ç­‰åˆ° notify åŒæ­¥å—æ‰§è¡Œå®Œä¹‹åæ‰ä¼šå»æ‰§è¡Œå”¤é†’</li></ul><h2 id="wait-notify-å’Œ-await-signal-å…³ç³»"><a href="#wait-notify-å’Œ-await-signal-å…³ç³»" class="headerlink" title="wait&#x2F;notify å’Œ await&#x2F;signal å…³ç³»"></a>wait&#x2F;notify å’Œ await&#x2F;signal å…³ç³»</h2><ul><li>wait&#x2F;notify <ul><li>åŸºäº Synchronized å®ç°çš„</li><li>æ— æ³•æ§åˆ¶å”¤é†’è°, éšæœºå”¤é†’</li></ul></li><li>await&#x2F;signal <ul><li>åŸºäº Lock å®ç°çš„</li><li>ä½¿ç”¨ Condition å¯¹è±¡å¯ä»¥ç»†ç²’åº¦ä½æ§åˆ¶çº¿ç¨‹çš„ç­‰å¾…å’Œå”¤é†’</li></ul></li></ul><h2 id="Executors-å·¥å…·ç±»æä¾›çš„å››ä¸ªçº¿ç¨‹æ± å­"><a href="#Executors-å·¥å…·ç±»æä¾›çš„å››ä¸ªçº¿ç¨‹æ± å­" class="headerlink" title="Executors å·¥å…·ç±»æä¾›çš„å››ä¸ªçº¿ç¨‹æ± å­"></a>Executors å·¥å…·ç±»æä¾›çš„å››ä¸ªçº¿ç¨‹æ± å­</h2><ul><li><code>newSingleThreadExecutor()</code> ç”¨äºéœ€è¦ä¿è¯ä»»åŠ¡æŒ‰é¡ºåºæ‰§è¡Œçš„åœºæ™¯<ul><li>corePoolSize: 1</li><li>maximumPoolSize: 1</li><li>é˜»å¡é˜Ÿåˆ—: LinkedBlockingQueue å¤§å°æ˜¯ Integer.MAX_VALUE</li></ul></li><li><code>newFixedThreadPool(int nThreads)</code> ç”¨äºè´Ÿè½½ç¨³å®šã€ä»»åŠ¡é‡æ’å®šçš„åœºæ™¯<ul><li>corePoolSize: nThreads</li><li>maximumPoolSize: nThreads</li><li>é˜»å¡é˜Ÿåˆ—: LinkedBlockingQueue å¤§å°æ˜¯ Integer.MAX_VALUE</li></ul></li><li><code>newCachedThreadPool()</code> é€‚ç”¨äºæ‰§è¡Œå¤§é‡çŸ­æœŸå¼‚æ­¥ä»»åŠ¡çš„åœºæ™¯ï¼Œèƒ½é«˜æ•ˆåœ°åˆ©ç”¨ç³»ç»Ÿèµ„æº<ul><li>corePoolSize: 0</li><li>maximumPoolSize: Integer.MAX_VALUE</li><li>é˜»å¡é˜Ÿåˆ—: å¤§å°ä¸º 0</li></ul></li><li><code>ScheduledThreadPoolExecutor(int corePoolSize)</code> ç”¨äºéœ€è¦å®šæ—¶æˆ–å‘¨æœŸæ€§æ‰§è¡Œä»»åŠ¡çš„åœºæ™¯<ul><li>corePoolSize: 0</li><li>maximumPoolSize: Integer.MAX_VALUE</li><li>é˜»å¡é˜Ÿåˆ—: å¤§å°æ— ç•Œ, æŒ‰ç…§å»¶è¿Ÿçš„æ—¶é—´é•¿çŸ­å¯¹ä»»åŠ¡è¿›è¡Œæ’åº</li></ul></li></ul><h2 id="shutdown-å’Œ-shutdownNow"><a href="#shutdown-å’Œ-shutdownNow" class="headerlink" title="shutdown() å’Œ shutdownNow()"></a>shutdown() å’Œ shutdownNow()</h2><ul><li>shutdown(): å…³é—­çº¿ç¨‹æ± , çº¿ç¨‹æ± çš„çŠ¶æ€å˜ä¸º SHUTDOWN, çº¿ç¨‹æ± ä¸å†æ¥å—æ–°ä»»åŠ¡, ä½†æ˜¯é˜Ÿåˆ—é‡Œçš„ä»»åŠ¡å¾—æ‰§è¡Œå®Œæ¯•</li><li>shutdownNow(): å…³é—­çº¿ç¨‹æ± , çº¿ç¨‹æ± çš„çŠ¶æ€å˜ä¸º STOP, çº¿ç¨‹æ± ä¼šç»ˆæ­¢å½“å‰æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡, å¹¶åœæ­¢å¤„ç†æ’é˜Ÿçš„ä»»åŠ¡å¹¶è¿”å›æ­£åœ¨ç­‰å¾…æ‰§è¡Œçš„ List</li></ul><h2 id="isTerminated-å’Œ-isShutdown"><a href="#isTerminated-å’Œ-isShutdown" class="headerlink" title="isTerminated() å’Œ isShutdown()"></a>isTerminated() å’Œ isShutdown()</h2><ul><li>isShutdown(): å½“è°ƒç”¨ shutdown() æ–¹æ³•åè¿”å› true</li><li>isTerminated: å½“è°ƒç”¨ shutdown() æ–¹æ³•å, å¹¶æ‰§è¡Œå®Œæ‰€æœ‰æäº¤çš„ä»»åŠ¡åè¿”å› true</li></ul><h2 id="å¦‚ä½•æ­£ç¡®ä½¿ç”¨çº¿ç¨‹æ± "><a href="#å¦‚ä½•æ­£ç¡®ä½¿ç”¨çº¿ç¨‹æ± " class="headerlink" title="å¦‚ä½•æ­£ç¡®ä½¿ç”¨çº¿ç¨‹æ± "></a>å¦‚ä½•æ­£ç¡®ä½¿ç”¨çº¿ç¨‹æ± </h2><ul><li>æ­£ç¡®å£°æ˜çº¿ç¨‹æ± , ç”¨ ThreadExecutorPool æ„é€ å‡½æ•°å£°æ˜, è€Œä¸æ˜¯ Executors å·¥å…·ç±»(ä¼šæœ‰ OOM çš„é£é™©)</li><li>ç›‘æµ‹çº¿ç¨‹æ± è¿è¡ŒçŠ¶æ€, SpringBoot çš„ Actuator ç»„ä»¶</li><li>å»ºè®®ä¸åŒä¸šåŠ¡ä½¿ç”¨ä¸åŒçš„çº¿ç¨‹æ± </li><li>ç»™çº¿ç¨‹æ± å‘½å</li><li>åˆ«å¿˜è®°å…³é—­çº¿ç¨‹æ± </li><li>çº¿ç¨‹æ± å°½é‡ä¸è¦æ”¾è€—æ—¶ä»»åŠ¡, è€—æ—¶ä»»åŠ¡ç”¨æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥æ‰§è¡Œ</li></ul><h2 id="åŠ¨æ€è°ƒæ•´çº¿ç¨‹æ± å¤§å°-ç¾å›¢"><a href="#åŠ¨æ€è°ƒæ•´çº¿ç¨‹æ± å¤§å°-ç¾å›¢" class="headerlink" title="åŠ¨æ€è°ƒæ•´çº¿ç¨‹æ± å¤§å°(ç¾å›¢)"></a>åŠ¨æ€è°ƒæ•´çº¿ç¨‹æ± å¤§å°(ç¾å›¢)</h2><ul><li>ç”¨ setCorePoolSize è°ƒæ•´æ ¸å¿ƒçº¿ç¨‹æ± å¤§å°</li><li>ç”¨ setMaximumPoolSize è°ƒæ•´æœ€å¤§çº¿ç¨‹æ± å¤§å°</li><li>é‡å†™ LinkedBlockingQueue, æŠŠé‡Œé¢çš„ capacity å­—æ®µçš„ finalå…³é”®å­—å»æ‰, å˜ä¸ºå¯å˜çš„</li></ul><h2 id="åŠ¨æ€è°ƒæ•´çº¿ç¨‹æ± å¤§å°-Nacos"><a href="#åŠ¨æ€è°ƒæ•´çº¿ç¨‹æ± å¤§å°-Nacos" class="headerlink" title="åŠ¨æ€è°ƒæ•´çº¿ç¨‹æ± å¤§å°(Nacos)"></a>åŠ¨æ€è°ƒæ•´çº¿ç¨‹æ± å¤§å°(Nacos)</h2><ul><li><code>@RefreshScope</code> æ”¯æŒ Nacos åŠ¨æ€åˆ·æ–°</li><li><code>@Value(&quot;$&#123;max.size&#125;&quot;</code> è¯»å–åœ¨ Nacos é…ç½®çš„å…·ä½“ä¿¡æ¯</li><li>é…ç½®ç›‘å¬, Nacos é…ç½®å˜æ›´æ—¶å®æ—¶ä¿®æ”¹çº¿ç¨‹æ± é…ç½®</li></ul><h2 id="çº¿ç¨‹æ± ä¸­çº¿ç¨‹å¼‚å¸¸å-é”€æ¯è¿˜æ˜¯å¤ç”¨"><a href="#çº¿ç¨‹æ± ä¸­çº¿ç¨‹å¼‚å¸¸å-é”€æ¯è¿˜æ˜¯å¤ç”¨" class="headerlink" title="çº¿ç¨‹æ± ä¸­çº¿ç¨‹å¼‚å¸¸å, é”€æ¯è¿˜æ˜¯å¤ç”¨?"></a>çº¿ç¨‹æ± ä¸­çº¿ç¨‹å¼‚å¸¸å, é”€æ¯è¿˜æ˜¯å¤ç”¨?</h2><ul><li>ä½¿ç”¨ execute() æäº¤ä»»åŠ¡<ul><li>å¦‚æœå¼‚å¸¸æ²¡æœ‰åœ¨ä»»åŠ¡å†…æ•è·, é‚£ä¹ˆè¯¥å¼‚å¸¸ä¼šå¯¼è‡´å½“å‰çº¿ç¨‹ç»ˆæ­¢, æ§åˆ¶å°æ‰“å°æ—¥å¿—</li><li>çº¿ç¨‹æ± ä¼šæ£€æµ‹åˆ°è¿™ç§å¼‚å¸¸ç»ˆæ­¢, å¹¶åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹æ¥æ›¿æ¢å®ƒ, ä»è€Œä¿è¯é…ç½®çš„çº¿ç¨‹æ•°ä¸å˜</li></ul></li><li>ä½¿ç”¨ submit() æäº¤ä»»åŠ¡<ul><li>å¦‚æœåœ¨æ‰§è¡Œä¸­å‘ç”Ÿå¼‚å¸¸, ä¼šå°è£…åœ¨ submit() è¿”å›çš„ <code>Future</code> å¯¹è±¡ä¸­</li><li>å½“è°ƒç”¨ <code>Future.get()</code> æ–¹æ³•å¯ä»¥æ•è·åˆ°ä¸€ä¸ª <code>ExecutionException</code> </li><li>çº¿ç¨‹ä¸ä¼šå› å¼‚å¸¸ç»ˆæ­¢, ä¼šç»§ç»­å­˜åœ¨çº¿ç¨‹æ± ä¸­</li></ul></li></ul><h2 id="CompletableFuture"><a href="#CompletableFuture" class="headerlink" title="CompletableFuture"></a>CompletableFuture</h2><ul><li>æ˜¯ç”¨æ¥åšå¤šä¸ªä»»åŠ¡çš„ç¼–æ’çš„, è§„å®šä»»åŠ¡å‰åæ‰§è¡Œé¡ºåº</li><li>Future ä¸æ”¯æŒå¼‚æ­¥ä»»åŠ¡çš„ç¼–æ’, è·å–è®¡ç®—ç»“æœçš„ <code>get()</code> æ–¹æ³•ä¸ºé˜»å¡è°ƒç”¨</li></ul><h2 id="Java-ä¸åŒé”çš„å®ç°å’Œä½¿ç”¨åœºæ™¯"><a href="#Java-ä¸åŒé”çš„å®ç°å’Œä½¿ç”¨åœºæ™¯" class="headerlink" title="Java ä¸åŒé”çš„å®ç°å’Œä½¿ç”¨åœºæ™¯"></a>Java ä¸åŒé”çš„å®ç°å’Œä½¿ç”¨åœºæ™¯</h2><ul><li><code>synchronized</code> å…³é”®å­—<ul><li>å¯é‡å…¥é”</li><li>éå…¬å¹³é”</li></ul></li><li><code>ReentrantLock</code><ul><li>å¯é‡å…¥é”</li><li>AQS é˜Ÿåˆ—</li><li>å¯ä»¥å®ç°å…¬å¹³é”</li></ul></li><li><code>ReadWrite Lock</code> è¯»å†™é”<ul><li>è¯»é”æ˜¯å…±äº«é”, è¯»è¯»ä¸äº’æ–¥, è·å–åˆ°è¯»é”çš„æ—¶å€™, æ— æ³•è·å–å†™é”</li><li>å†™é”æ˜¯ç‹¬å é”, åŠ ä¸Šå†™é”çš„æ—¶å€™åˆ«çš„çº¿ç¨‹è¯»å†™éƒ½ä¸è¡Œ</li></ul></li></ul><h2 id="CountDownLatch-ç±»-å€’è®¡æ—¶å™¨"><a href="#CountDownLatch-ç±»-å€’è®¡æ—¶å™¨" class="headerlink" title="CountDownLatch ç±»(å€’è®¡æ—¶å™¨)"></a>CountDownLatch ç±»(å€’è®¡æ—¶å™¨)</h2><ul><li>CountDownLatch å…è®¸ count ä¸ªçº¿ç¨‹é˜»å¡åœ¨ä¸€ä¸ªåœ°æ–¹, ç›´è‡³æ‰€æœ‰çº¿ç¨‹çš„ä»»åŠ¡éƒ½æ‰§è¡Œå®Œæ¯•</li><li>å…¸å‹ç”¨æ³•<ul><li>æŸä¸€ä¸ªçº¿ç¨‹åœ¨å¼€å§‹è¿è¡Œå‰ç­‰å¾… n ä¸ªçº¿ç¨‹æ‰§è¡Œå®Œæ¯•: å°† CountDownLatch çš„è®¡æ•°å™¨åˆå§‹åŒ–ä¸º n, æ¯å½“ä¸€ä¸ªä»»åŠ¡çº¿ç¨‹æ‰§è¡Œå®Œæ¯•, å°±å°†è®¡æ•°å™¨ -1, å½“è®¡æ•°å™¨çš„å€¼å˜ä¸º 0 æ—¶, åœ¨ CountDownLatch ä¸Š await() çš„çº¿ç¨‹å°±è¢«å”¤é†’<ul><li>å…¸å‹åº”ç”¨åœºæ™¯å°±æ˜¯å¯åŠ¨ä¸€ä¸ªæœåŠ¡æ—¶, ä¸»çº¿ç¨‹éœ€è¦ç­‰å¾…å¤šä¸ªç»„ä»¶åŠ è½½å®Œæˆ, ä¹‹åå†ç»§ç»­æ‰§è¡Œ</li></ul></li><li>å®ç°å¤šä¸ªçº¿ç¨‹å¼€å§‹æ‰§è¡Œä»»åŠ¡çš„æœ€å¤§å¹¶å‘æ€§: å¼ºè°ƒçš„æ˜¯å¤šä¸ªçº¿ç¨‹åœ¨æŸä¸€æ—¶åˆ»åŒæ—¶å¼€å§‹æ‰§è¡Œ, ç±»ä¼¼äºèµ›è·‘, å°†å¤šä¸ªçº¿ç¨‹æ”¾åˆ°èµ·ç‚¹, åŒæ—¶å¼€è·‘, åˆå§‹åŒ–ä¸€ä¸ªå…±äº«çš„ CountDownLatch å¯¹è±¡, å°†å…¶è®¡æ•°å™¨åˆå§‹åŒ–ä¸º 1, å¤šä¸ªçº¿ç¨‹åœ¨å¼€å§‹æ‰§è¡Œä»»åŠ¡å‰é¦–å…ˆ <code>countdownLathch.await()</code> å½“ä¸»çº¿ç¨‹è°ƒç”¨ countDown() æ—¶, è®¡æ•°å™¨å˜ä¸º 0, å¤šä¸ªçº¿ç¨‹è¢«åŒæ—¶å”¤é†’</li></ul></li></ul><h2 id="å¦‚ä½•é¢„é˜²æ­»é”"><a href="#å¦‚ä½•é¢„é˜²æ­»é”" class="headerlink" title="å¦‚ä½•é¢„é˜²æ­»é”"></a>å¦‚ä½•é¢„é˜²æ­»é”</h2><ul><li>ç ´åè¯·æ±‚ä¸ä¿æŒæ¡ä»¶: ä¸€æ¬¡æ€§ç”³è¯·æ‰€æœ‰èµ„æº</li><li>ç ´åä¸å¯å‰¥å¤ºæ¡ä»¶: å ç”¨éƒ¨åˆ†èµ„æºçš„çº¿ç¨‹å»ç”³è¯·å…¶ä»–èµ„æºæ—¶, å¦‚æœç”³è¯·ä¸åˆ°, ä¸»åŠ¨é‡Šæ”¾ä»–æ‰€å ç”¨çš„èµ„æº</li><li>ç ´åå¾ªç¯ç­‰å¾…æ¡ä»¶: æŒ‰ç…§é¡ºåºç”³è¯·èµ„æº, é‡Šæ”¾èµ„æºååºé‡Šæ”¾</li></ul><h2 id="java-å¤šçº¿ç¨‹é€šä¿¡"><a href="#java-å¤šçº¿ç¨‹é€šä¿¡" class="headerlink" title="java å¤šçº¿ç¨‹é€šä¿¡"></a>java å¤šçº¿ç¨‹é€šä¿¡</h2><ul><li>é”</li><li><code>wait/notify</code></li><li><code>volatile</code> </li><li>ç®¡é“</li><li><code>join</code></li><li><code>ThreadLocal</code></li></ul><h2 id="å¦‚ä½•æ£€æµ‹æ­»é”"><a href="#å¦‚ä½•æ£€æµ‹æ­»é”" class="headerlink" title="å¦‚ä½•æ£€æµ‹æ­»é”"></a>å¦‚ä½•æ£€æµ‹æ­»é”</h2><ul><li><code>jstack</code> å‘½ä»¤å¯ä»¥æŸ¥çœ‹ JVM çº¿ç¨‹æ ˆå’Œå †å†…å­˜çš„æƒ…å†µ, å¦‚æœæœ‰æ­»é”, é€šå¸¸ä¼šè¾“å‡º <code>Found one Java-level deadlock</code> å­—æ ·</li><li>å®é™…é¡¹ç›®å¯ä»¥ç”¨ <code>top</code> æŸ¥çœ‹ CPU å ç”¨æƒ…å†µ, å‡ºç°æ­»é”ä¼šå¯¼è‡´ CPU å†…å­˜å ç”¨è¿‡é«˜</li></ul><h2 id="é”å‡çº§"><a href="#é”å‡çº§" class="headerlink" title="é”å‡çº§"></a>é”å‡çº§</h2><ul><li>é”ä¸»è¦å­˜åœ¨å››ç§çŠ¶æ€ï¼Œä¾æ¬¡æ˜¯ï¼šæ— é”çŠ¶æ€ã€åå‘é”çŠ¶æ€ã€è½»é‡çº§é”çŠ¶æ€ã€é‡é‡çº§é”çŠ¶æ€ï¼Œä»–ä»¬ä¼šéšç€ç«äº‰çš„æ¿€çƒˆè€Œé€æ¸å‡çº§ã€‚æ³¨æ„é”å¯ä»¥å‡çº§ä¸å¯é™çº§ï¼Œè¿™ç§ç­–ç•¥æ˜¯ä¸ºäº†æé«˜è·å¾—é”å’Œé‡Šæ”¾é”çš„æ•ˆç‡</li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>å…«è‚¡</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>golang</title>
    <link href="/2024/05/26/golang/"/>
    <url>/2024/05/26/golang/</url>
    
    <content type="html"><![CDATA[<h1 id="golang"><a href="#golang" class="headerlink" title="golang"></a>golang</h1><h2 id="init-å’Œ-mian-å‡½æ•°"><a href="#init-å’Œ-mian-å‡½æ•°" class="headerlink" title="init å’Œ mian å‡½æ•°"></a>init å’Œ mian å‡½æ•°</h2><ul><li>init å‡½æ•°<ul><li>åŒä¸€ä¸ª package å¯ä»¥å®šä¹‰å¤šä¸ª init æ–¹æ³•<ul><li>åŒä¸€ä¸ª package ä¸åŒæ–‡ä»¶ init æ–¹æ³•æ‰§è¡ŒæŒ‰ç…§æ–‡ä»¶åå…ˆåé¡ºåºæ‰§è¡Œ</li></ul></li><li>åŒä¸€ä¸ª go æ–‡ä»¶ä¸­å¯ä»¥é‡å¤å®šä¹‰ init æ–¹æ³•<ul><li>æŒ‰å®šä¹‰é¡ºåºæ‰§è¡Œ</li></ul></li><li>æŒ‰ç…§ import é¡ºåºè°ƒç”¨å…¶ä»–åŒ…çš„ init å‡½æ•°</li><li>å¯¼å…¥é¡ºåº mian -&gt; A -&gt; B -&gt; C åˆ™ init æ‰§è¡Œçš„é¡ºåºæ­£å¥½ç›¸å</li><li>init å‡½æ•°éƒ½åœ¨ä¸€ä¸ª goroutine å†…æ‰§è¡Œ</li><li>æ‰§è¡Œå®Œä¹‹åå†æ‰§è¡Œ main å‡½æ•°<br>  <img src="https://gitee.com/AWallFlower/picture/raw/master/img/20240523190103.png" alt="image.png"></li></ul></li></ul><h2 id="byte-å’Œ-rune-æœ‰ä»€ä¹ˆåŒºåˆ«"><a href="#byte-å’Œ-rune-æœ‰ä»€ä¹ˆåŒºåˆ«" class="headerlink" title="byte å’Œ rune æœ‰ä»€ä¹ˆåŒºåˆ«"></a>byte å’Œ rune æœ‰ä»€ä¹ˆåŒºåˆ«</h2><ul><li>éƒ½æ˜¯å­—ç¬¦ç±»å‹, éƒ½æ˜¯åˆ«åç±»å‹</li><li>byte æœ¬è´¨æ˜¯ uint8 ç±»å‹çš„åˆ«å, ä»£è¡¨äº† ASCII ç çš„ä¸€ä¸ªå­—ç¬¦</li><li>rune æœ¬è´¨æ˜¯ int32 ç±»å‹çš„åˆ«å, ä»£è¡¨äº† UTF-8 å­—ç¬¦</li></ul><h2 id="Go-struct-èƒ½ä¸èƒ½æ¯”è¾ƒ"><a href="#Go-struct-èƒ½ä¸èƒ½æ¯”è¾ƒ" class="headerlink" title="Go struct èƒ½ä¸èƒ½æ¯”è¾ƒ"></a>Go struct èƒ½ä¸èƒ½æ¯”è¾ƒ</h2><ul><li>å¦‚æœ struct æœ‰ä¸èƒ½æ¯”è¾ƒçš„å­—æ®µ, å°±ä¸èƒ½æ¯”è¾ƒ</li><li>åªèƒ½æ¯”è¾ƒæ˜¯å¦ç›¸ç­‰, ä¸èƒ½æ¯”è¾ƒå¤§å°</li><li>æ‰€æœ‰å±æ€§éƒ½ç›¸ç­‰å¹¶ä¸”é¡ºåºä¸€è‡´çš„ struct æ‰èƒ½æ¯”è¾ƒ</li></ul><h2 id="goroutine-å’Œçº¿ç¨‹çš„åŒºåˆ«"><a href="#goroutine-å’Œçº¿ç¨‹çš„åŒºåˆ«" class="headerlink" title="goroutine å’Œçº¿ç¨‹çš„åŒºåˆ«"></a>goroutine å’Œçº¿ç¨‹çš„åŒºåˆ«</h2><ul><li>å†…å­˜å ç”¨<ul><li>goroutine æ ˆå†…å­˜æ¶ˆè€—ä¸º 2KB</li><li>Thread æ¶ˆè€— 1MB</li></ul></li><li>åˆ›å»ºå’Œé”€æ¯<ul><li>Thread åˆ›å»ºå’Œé”€æ¯éƒ½æ˜¯æ“ä½œç³»ç»Ÿå†…æ ¸çº§åˆ«çš„, é€šå¸¸ç”±çº¿ç¨‹æ± ç®¡ç†</li><li>goroutine ç”± Go runtime è´Ÿè´£åˆ›å»º, åˆ›å»ºé”€æ¯æ¶ˆè€—éå¸¸å°, æ˜¯ç”¨æˆ·çº§</li></ul></li><li>åˆ‡æ¢<ul><li>Thread åˆ‡æ¢æ—¶, éœ€è¦ä¿å­˜å„ç§å¯„å­˜å™¨</li><li>goroutine åˆ‡æ¢åªéœ€è¦ä¿å­˜ 3 ä¸ªå¯„å­˜å™¨ <ul><li><code>PC ç¨‹åºè®¡æ•°å™¨</code></li><li><code>Stack Pointer æ ˆé¡¶æŒ‡é’ˆ</code></li><li><code>BP åŸºå€æŒ‡é’ˆ</code></li></ul></li></ul></li></ul><h2 id="slice-å’Œæ•°ç»„çš„åŒºåˆ«"><a href="#slice-å’Œæ•°ç»„çš„åŒºåˆ«" class="headerlink" title="slice å’Œæ•°ç»„çš„åŒºåˆ«"></a>slice å’Œæ•°ç»„çš„åŒºåˆ«</h2><ul><li>slice çš„åº•å±‚æ•°æ®ç»“æ„æ˜¯æ•°ç»„</li><li>æ•°ç»„æ˜¯å®šé•¿çš„, slice å¯ä»¥æ‰©å®¹</li><li>æ•°ç»„å°±æ˜¯ä¸€ç‰‡è¿ç»­çš„å†…å­˜, slice å®é™…ä¸Šæ˜¯ä¸€ä¸ªç»“æ„ä½“, åŒ…å«é•¿åº¦, å®¹é‡, åº•å±‚æ•°ç»„<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> slice <span class="hljs-keyword">struct</span>&#123;<br>array unsafe.Pointer <span class="hljs-comment">// å…ƒç´ æŒ‡é’ˆ</span><br><span class="hljs-built_in">len</span> <span class="hljs-type">int</span> <span class="hljs-comment">// æ•°ç»„é•¿åº¦</span><br><span class="hljs-built_in">cap</span> <span class="hljs-type">int</span> <span class="hljs-comment">// å®¹é‡</span><br>&#125;<br></code></pre></td></tr></table></figure></li><li>åº•å±‚æ•°æ®å¯ä»¥è¢«å¤šä¸ª slice æŒ‡å‘, æ‰€ä»¥å¯¹ä¸€ä¸ª slice æ“ä½œæœ‰å¯èƒ½å½±å“å…¶ä»– slice</li></ul><h2 id="map-å®ç°åŸç†"><a href="#map-å®ç°åŸç†" class="headerlink" title="map å®ç°åŸç†"></a>map å®ç°åŸç†</h2><ul><li>æ•°æ®è¢«æ”¾å…¥ä¸€ä¸ªç”±æ¡¶ç»„æˆçš„æœ‰åºæ•°ç»„ä¸­, æ¯ä¸ªæ¡¶æœ€å¤šå¯ä»¥å­˜æ”¾ 8 ä¸ª <code>key/value</code> å¯¹</li><li>key çš„ Hash å€¼ä½ä½ç”¨äºåœ¨è¯¥æ•°ç»„ä¸­å®šä½åˆ°æ¡¶, é«˜ 8 ä½ç”¨äºåœ¨æ¡¶ä¸­åŒºåˆ† <code>key/value</code> å¯¹</li><li>è¶…äº†ä¼šé“¾æ¥åˆ°é¢å¤–çš„æº¢å‡ºæ¡¶ <code>overflow uintptr</code> æ‰€ä»¥æ•°æ®ç»“æ„ä¸º<ul><li>hash æ•°ç»„</li><li>æ¡¶å†… key-value æ•°ç»„</li><li>æº¢å‡ºçš„æ¡¶é“¾è¡¨</li></ul></li><li>å½“ Hash è¶…è¿‡é˜ˆå€¼éœ€è¦æ‰©å®¹æ—¶, ä¼šåˆ†é…ä¸€ä¸ªæ–°çš„æ¡¶æ•°ç»„, ä¸€èˆ¬æ˜¯æ—§çš„ 2 å€</li><li>go ä¸ä¼šä¸€æ¬¡å…¨é‡æ‹·è´, è€—æ—¶å¤ªå¤§, ä¼šåœ¨æ¯æ¬¡è¯»å†™ map çš„æ—¶å€™åŠ¨æ€è¿ç§»</li></ul><h2 id="ä¸ºä»€ä¹ˆä¼š-Hash-å†²çª"><a href="#ä¸ºä»€ä¹ˆä¼š-Hash-å†²çª" class="headerlink" title="ä¸ºä»€ä¹ˆä¼š Hash å†²çª"></a>ä¸ºä»€ä¹ˆä¼š Hash å†²çª</h2><ul><li>é€šè¿‡å“ˆå¸Œå‡½æ•°äº§ç”Ÿçš„å“ˆå¸Œå€¼æ˜¯æœ‰é™çš„, æ•°æ®å¯èƒ½æ¯”è¾ƒå¤š, å¯¼è‡´ç»è¿‡å“ˆå¸Œå‡½æ•°å¤„ç†åå‡ºç°ç›¸åŒçš„å“ˆå¸Œå€¼</li></ul><h2 id="go-map-å¹¶å‘å¯¼è‡´-panic-å¦‚ä½•è§£å†³"><a href="#go-map-å¹¶å‘å¯¼è‡´-panic-å¦‚ä½•è§£å†³" class="headerlink" title="go map å¹¶å‘å¯¼è‡´ panic å¦‚ä½•è§£å†³"></a>go map å¹¶å‘å¯¼è‡´ panic å¦‚ä½•è§£å†³</h2><ul><li>go ä¸­ map ä¸æ”¯æŒå¹¶å‘è¯»å†™</li><li>ä½¿ç”¨ <code>sync.map</code></li></ul><h2 id="go-çš„åƒåœ¾å›æ”¶"><a href="#go-çš„åƒåœ¾å›æ”¶" class="headerlink" title="go çš„åƒåœ¾å›æ”¶"></a>go çš„åƒåœ¾å›æ”¶</h2><ul><li>æ— åˆ†ä»£</li><li>ä¸æ•´ç†(å›æ”¶è¿‡ç¨‹ä¸­ä¸å¯¹å¯¹è±¡è¿›è¡Œç§»åŠ¨ä¸æ•´ç†)</li><li>å¹¶å‘(ä¸ç”¨æˆ·ä»£ç å¹¶å‘æ‰§è¡Œ)</li><li>ä¸‰è‰²æ ‡è®°æ¸…é™¤æ³•</li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>golang</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
